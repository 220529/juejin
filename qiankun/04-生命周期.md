# Qiankun 微前端源码解析：生命周期

> 本文深入分析 Qiankun 的生命周期管理机制，理解子应用从加载到卸载的完整流程。

## 生命周期概览

```
┌─────────────────────────────────────────────────────────────────┐
│                      子应用生命周期                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐     │
│   │ 加载中   │───▶│ 已启动   │───▶│ 已挂载   │───▶│ 已卸载   │     │
│   │ LOADING │    │BOOTSTRAP│    │ MOUNTED │    │UNMOUNTED│     │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘     │
│        │              │              │              │           │
│        ▼              ▼              ▼              ▼           │
│   beforeLoad     bootstrap      mount          unmount         │
│                                beforeMount    beforeUnmount    │
│                                afterMount     afterUnmount     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 生命周期类型定义

```typescript
// packages/qiankun/src/types.ts
export type LifeCycleFn<T extends ObjectType> = (
  app: LoadableApp<T>, 
  global: WindowProxy
) => Promise<void>;

export type LifeCycles<T extends ObjectType> = {
  beforeLoad?: LifeCycleFn<T> | Array<LifeCycleFn<T>>;
  beforeMount?: LifeCycleFn<T> | Array<LifeCycleFn<T>>;
  afterMount?: LifeCycleFn<T> | Array<LifeCycleFn<T>>;
  beforeUnmount?: LifeCycleFn<T> | Array<LifeCycleFn<T>>;
  afterUnmount?: LifeCycleFn<T> | Array<LifeCycleFn<T>>;
};

// 子应用导出的生命周期
export type MicroAppLifeCycles = {
  bootstrap: () => Promise<void>;
  mount: (props: { container: HTMLElement }) => Promise<void>;
  unmount: (props: { container: HTMLElement }) => Promise<void>;
  update?: (props: unknown) => Promise<void>;
};
```

## 生命周期执行链

### execHooksChain

```typescript
// packages/qiankun/src/core/loadApp.ts
function execHooksChain<T extends ObjectType>(
  hooks: Array<LifeCycleFn<T>>,
  app: LoadableApp<T>,
  global: WindowProxy = window,
): Promise<unknown> {
  if (hooks.length) {
    // 串行执行所有钩子
    return hooks.reduce(
      (chain, hook) => chain.then(() => hook(app, global)), 
      Promise.resolve()
    );
  }
  return Promise.resolve();
}
```

### 钩子合并

```typescript
// 合并内置钩子和用户钩子
const {
  beforeUnmount = [],
  afterUnmount = [],
  afterMount = [],
  beforeMount = [],
  beforeLoad = [],
} = mergeWith(
  {},
  getAddOns(global, assetPublicPath),  // 内置钩子
  lifeCycles,                           // 用户钩子
  (v1, v2) => concat((v1 ?? []) as LifeCycleFn<T>, (v2 ?? []) as LifeCycleFn<T>)
);
```

## 内置 AddOns

```typescript
// packages/qiankun/src/addons/index.ts
export default function getAddOns(
  global: WindowProxy, 
  publicPath: string
): LifeCycles<ObjectType> {
  return {
    beforeLoad: [
      // 注入 __POWERED_BY_QIANKUN__
      async (app) => {
        (global as any).__POWERED_BY_QIANKUN__ = true;
      },
      // 注入 __INJECTED_PUBLIC_PATH_BY_QIANKUN__
      async (app) => {
        (global as any).__INJECTED_PUBLIC_PATH_BY_QIANKUN__ = publicPath;
      },
    ],
    afterUnmount: [
      // 清理注入的变量
      async (app) => {
        delete (global as any).__POWERED_BY_QIANKUN__;
        delete (global as any).__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
      },
    ],
  };
}
```

## Mount 阶段详解

```typescript
// packages/qiankun/src/core/loadApp.ts
mount: [
  // 1. 性能标记
  async () => {
    if (process.env.NODE_ENV === 'development') {
      const marks = performanceGetEntriesByName(markName, 'mark');
      if (marks && !marks.length) {
        performanceMark(markName);
      }
    }
  },

  // 2. 重新挂载时重新加载 HTML
  async () => {
    microAppDOMContainer = mountContainer;

    if (mountTimes > 1) {
      // 初始化容器
      initContainer(mountContainer, appName, { sandboxCfg: sandbox, mountTimes, instanceId });
      
      // 获取不含脚本的 HTML（避免重复执行）
      const htmlString = await getPureHTMLStringWithoutScripts(entry, enhancedFetch);
      
      // 重新加载 HTML
      await loadEntry(
        { url: entry, res: new Response(htmlString, { status: 200, statusText: 'OK' }) },
        mountContainer,
        containerOpts,
      );
    }
  },

  // 3. 激活沙箱
  async () => {
    await mountSandbox(mountContainer);
  },

  // 4. 执行 beforeMount 钩子
  async () => execHooksChain(toArray(beforeMount), app, global),

  // 5. 执行子应用 mount
  async (props) => mount({ ...props, container: mountContainer }),

  // 6. 执行 afterMount 钩子
  async () => execHooksChain(toArray(afterMount), app, global),

  // 7. 性能测量
  async () => {
    if (process.env.NODE_ENV === 'development') {
      const measureName = `[qiankun] App ${appName} Loading Consuming`;
      performanceMeasure(measureName, markName);
    }
  },

  // 8. 挂载次数 +1
  async () => {
    mountTimes++;
  },
],
```

## Unmount 阶段详解

```typescript
unmount: [
  // 1. 执行 beforeUnmount 钩子
  async () => execHooksChain(toArray(beforeUnmount), app, global),

  // 2. 执行子应用 unmount
  async (props) => unmount({ ...props, container: mountContainer }),

  // 3. 卸载沙箱（记录副作用）
  unmountSandbox,

  // 4. 执行 afterUnmount 钩子
  async () => execHooksChain(toArray(afterUnmount), app, global),

  // 5. 清理容器
  async () => {
    clearContainer(mountContainer);
  },
],
```

## 获取子应用生命周期

```typescript
function getLifecyclesFromExports(
  scriptExports: MicroAppLifeCycles,
  appName: string,
  globalContext: WindowProxy,
  globalLatestSetProp?: PropertyKey,
): MicroAppLifeCycles {
  const validateExportLifecycle = (exports: ObjectType | undefined): boolean => {
    const { bootstrap, mount, unmount } = exports ?? {};
    return isFunction(bootstrap) && isFunction(mount) && isFunction(unmount);
  };

  // 1. 优先从 exports 获取（ES Module）
  if (validateExportLifecycle(scriptExports)) {
    return scriptExports;
  }

  // 2. 从沙箱最后设置的属性获取（UMD）
  if (globalLatestSetProp) {
    const lifecycles = globalContext[globalLatestSetProp as never] as MicroAppLifeCycles;
    if (validateExportLifecycle(lifecycles)) {
      return lifecycles;
    }
  }

  // 3. 从 window[appName] 获取（全局变量）
  if (process.env.NODE_ENV === 'development') {
    warn(`lifecycle not found from ${appName} entry exports, fallback to get from window['${appName}']`);
  }

  const globalVariableExports = globalContext[appName as never] as MicroAppLifeCycles;
  if (validateExportLifecycle(globalVariableExports)) {
    return globalVariableExports;
  }

  throw new QiankunError(
    `You need to export lifecycle functions in ${appName} entry`
  );
}
```

## 子应用生命周期示例

### React 子应用

```typescript
// src/index.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

let root: ReactDOM.Root | null = null;

export async function bootstrap() {
  console.log('react app bootstraped');
}

export async function mount(props: { container: HTMLElement }) {
  const { container } = props;
  const mountNode = container.querySelector('#root') || container;
  
  root = ReactDOM.createRoot(mountNode);
  root.render(<App />);
}

export async function unmount(props: { container: HTMLElement }) {
  root?.unmount();
  root = null;
}

// 独立运行
if (!window.__POWERED_BY_QIANKUN__) {
  const root = ReactDOM.createRoot(document.getElementById('root')!);
  root.render(<App />);
}
```

### Vue 子应用

```typescript
// src/main.ts
import { createApp, App as VueApp } from 'vue';
import App from './App.vue';

let app: VueApp | null = null;

export async function bootstrap() {
  console.log('vue app bootstraped');
}

export async function mount(props: { container: HTMLElement }) {
  const { container } = props;
  app = createApp(App);
  app.mount(container.querySelector('#app') || container);
}

export async function unmount() {
  app?.unmount();
  app = null;
}

if (!window.__POWERED_BY_QIANKUN__) {
  createApp(App).mount('#app');
}
```

## 容器管理

### 初始化容器

```typescript
function initContainer(
  container: HTMLElement,
  appName: string,
  opts: { sandboxCfg: AppConfiguration['sandbox']; mountTimes: number; instanceId: number },
): void {
  const { sandboxCfg, mountTimes, instanceId } = opts;
  
  // 清空容器
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }

  // 设置数据属性
  container.dataset.name = appName;
  container.dataset.version = version;
  container.dataset.sandboxCfg = JSON.stringify(sandboxCfg);

  if (mountTimes > 1) {
    container.dataset.mountTimes = String(mountTimes);
  }
  if (instanceId > 1) {
    container.dataset.instanceId = String(instanceId);
  }
}
```

### 清理容器

```typescript
function clearContainer(container: HTMLElement): void {
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
}
```

## 多实例管理

```typescript
// 全局实例 ID 存储
const globalAppInstanceStoreKey = '__agii__';

function genInstanceId(appName: string): number {
  if (!hasOwnProperty(nativeGlobal, globalAppInstanceStoreKey)) {
    defineProperty(nativeGlobal, globalAppInstanceStoreKey, {
      enumerable: false,
      configurable: false,
      writable: true,
      value: {},
    });
  }
  
  nativeGlobal[globalAppInstanceStoreKey]![appName] = 
    nativeGlobal[globalAppInstanceStoreKey]![appName]
      ? nativeGlobal[globalAppInstanceStoreKey]![appName] + 1
      : 1;
      
  return nativeGlobal[globalAppInstanceStoreKey]![appName];
}
```

## 生命周期时序图

```
┌─────────────────────────────────────────────────────────────────┐
│                      生命周期时序                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  主应用                          子应用                          │
│    │                               │                             │
│    │  registerMicroApps            │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │  路由匹配 / loadMicroApp      │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │  beforeLoad                   │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │  loadEntry (加载 HTML/JS)     │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │                               │  bootstrap                  │
│    │                               │◀─────────────────────────── │
│    │                               │                             │
│    │  beforeMount                  │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │                               │  mount                      │
│    │                               │◀─────────────────────────── │
│    │                               │                             │
│    │  afterMount                   │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │         ... 运行中 ...         │                             │
│    │                               │                             │
│    │  beforeUnmount                │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
│    │                               │  unmount                    │
│    │                               │◀─────────────────────────── │
│    │                               │                             │
│    │  afterUnmount                 │                             │
│    │──────────────────────────────▶│                             │
│    │                               │                             │
└─────────────────────────────────────────────────────────────────┘
```

## 小结

Qiankun 生命周期管理的核心设计：

1. **钩子链**：beforeLoad → bootstrap → beforeMount → mount → afterMount
2. **钩子合并**：内置钩子 + 用户钩子串行执行
3. **多种获取方式**：exports、latestSetProp、window[appName]
4. **重新挂载**：mountTimes > 1 时重新加载 HTML（不含脚本）
5. **容器管理**：数据属性记录应用状态

---

> 下一篇：通信机制
