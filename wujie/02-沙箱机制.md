# æ— ç•Œå¾®å‰ç«¯æºç è§£æï¼šæ²™ç®±æœºåˆ¶

> æ·±å…¥åˆ†æ iframe æ²™ç®±çš„åˆ›å»ºã€patch å’Œ JS æ‰§è¡Œéš”ç¦»åŸç†ã€‚

## ä¸ºä»€ä¹ˆç”¨ iframe

iframe æ˜¯æµè§ˆå™¨åŸç”Ÿçš„éš”ç¦»æ–¹æ¡ˆï¼Œå…·å¤‡ï¼š

- **å®Œæ•´çš„ window å¯¹è±¡**ï¼šç‹¬ç«‹çš„å…¨å±€ä½œç”¨åŸŸ
- **åŸç”Ÿ JS éš”ç¦»**ï¼šå˜é‡ä¸ä¼šæ±¡æŸ“ä¸»åº”ç”¨
- **åŸç”Ÿè·¯ç”±éš”ç¦»**ï¼šç‹¬ç«‹çš„ history å’Œ location

æ— ç•Œçš„åˆ›æ–°åœ¨äºï¼šåªç”¨ iframe è¿è¡Œ JSï¼ŒDOM æ¸²æŸ“åœ¨ Shadow DOM ä¸­ã€‚

## iframe åˆ›å»º

```typescript
// packages/wujie-core/src/iframe.ts
export function iframeGenerator(
  sandbox: WuJie,
  attrs: { [key: string]: any },
  mainHostPath: string,
  appHostPath: string,
  appRoutePath: string
): HTMLIFrameElement {
  // 1. åˆ›å»º iframe
  const iframe = document.createElement("iframe");
  
  // 2. è®¾ç½®å±æ€§
  setAttrsToElement(iframe, {
    src: mainHostPath,  // åŒåŸŸï¼Œé¿å…è·¨åŸŸé—®é¢˜
    style: "display: none",
    ...attrs,
    [WUJIE_DATA_FLAG]: "",
  });
  
  // 3. æ’å…¥æ–‡æ¡£
  document.body.appendChild(iframe);
  
  // 4. ç­‰å¾… iframe åŠ è½½
  sandbox.iframeReady = stopIframeLoading(iframe).then(() => {
    // 5. åˆå§‹åŒ– iframe DOM
    initIframeDom(iframe.contentWindow, sandbox, mainHostPath, appHostPath);
    // 6. æ³¨å…¥å˜é‡
    patchIframeVariable(iframe.contentWindow, sandbox, appHostPath);
  });
  
  return iframe;
}
```

å…³é”®ç‚¹ï¼š
- `src` è®¾ä¸ºä¸»åº”ç”¨åŸŸåï¼Œä¿è¯åŒåŸŸ
- `display: none` éšè— iframe
- é€šè¿‡ `stopIframeLoading` é˜»æ­¢ iframe åŠ è½½ä¸»åº”ç”¨å†…å®¹

## é˜»æ­¢ iframe åŠ è½½

```typescript
// packages/wujie-core/src/iframe.ts
function stopIframeLoading(iframe: HTMLIFrameElement) {
  const iframeWindow = iframe.contentWindow;
  const oldDoc = iframeWindow.document;
  
  return new Promise<void>((resolve) => {
    function loop() {
      setTimeout(() => {
        let newDoc;
        try {
          newDoc = iframeWindow.document;
        } catch (err) {
          newDoc = null;
        }
        
        // ç­‰å¾… document å°±ç»ª
        if (!newDoc || newDoc == oldDoc) {
          loop();
          return;
        }
        
        // åœæ­¢åŠ è½½
        iframeWindow.stop ? iframeWindow.stop() : newDoc.execCommand("Stop");
        resolve();
      }, 1);
    }
    loop();
  });
}
```

## åˆå§‹åŒ– iframe DOM

```typescript
// packages/wujie-core/src/iframe.ts
function initIframeDom(iframeWindow: Window, wujie: WuJie, mainHostPath: string, appHostPath: string): void {
  const iframeDocument = iframeWindow.document;
  
  // 1. åˆ›å»ºç©ºç™½æ–‡æ¡£
  const newDoc = window.document.implementation.createHTMLDocument("");
  const newDocumentElement = iframeDocument.importNode(newDoc.documentElement, true);
  iframeDocument.replaceChild(newDocumentElement, iframeDocument.documentElement);
  
  // 2. ä¿å­˜åŸç”Ÿæ–¹æ³•
  iframeWindow.__WUJIE_RAW_DOCUMENT_HEAD__ = iframeDocument.head;
  iframeWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__ = iframeWindow.Document.prototype.querySelector;
  iframeWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__ = iframeWindow.Document.prototype.createElement;
  
  // 3. åˆå§‹åŒ– base æ ‡ç­¾
  initBase(iframeWindow, wujie.url);
  
  // 4. patch history
  patchIframeHistory(iframeWindow, appHostPath, mainHostPath);
  
  // 5. patch äº‹ä»¶
  patchIframeEvents(iframeWindow);
  
  // 6. patch window
  patchWindowEffect(iframeWindow);
  
  // 7. patch document
  patchDocumentEffect(iframeWindow);
  
  // 8. patch Node
  patchNodeEffect(iframeWindow);
  
  // 9. patch ç›¸å¯¹è·¯å¾„
  patchRelativeUrlEffect(iframeWindow);
}
```

## patch history

```typescript
// packages/wujie-core/src/iframe.ts
function patchIframeHistory(iframeWindow: Window, appHostPath: string, mainHostPath: string): void {
  const history = iframeWindow.history;
  const rawHistoryPushState = history.pushState;
  const rawHistoryReplaceState = history.replaceState;
  
  // åŠ«æŒ pushState
  history.pushState = function (data: any, title: string, url?: string): void {
    // å°†å­åº”ç”¨è·¯å¾„è½¬æ¢ä¸ºä¸»åº”ç”¨è·¯å¾„
    const baseUrl = mainHostPath + iframeWindow.location.pathname + 
                    iframeWindow.location.search + iframeWindow.location.hash;
    const mainUrl = getAbsolutePath(url?.replace(appHostPath, ""), baseUrl);
    
    rawHistoryPushState.call(history, data, title, url === undefined ? undefined : mainUrl);
    if (url === undefined) return;
    
    // æ›´æ–° base æ ‡ç­¾
    updateBase(iframeWindow, appHostPath, mainHostPath);
    // åŒæ­¥è·¯ç”±åˆ°ä¸»åº”ç”¨
    syncUrlToWindow(iframeWindow);
  };
  
  // replaceState åŒç†
  history.replaceState = function (data: any, title: string, url?: string): void {
    // ...ç±»ä¼¼é€»è¾‘
  };
}
```

## patch äº‹ä»¶ç›‘å¬

```typescript
// packages/wujie-core/src/iframe.ts
function patchIframeEvents(iframeWindow: Window) {
  iframeWindow.__WUJIE_EVENTLISTENER__ = new Set();
  
  iframeWindow.addEventListener = function addEventListener(type, listener, options) {
    // è¿è¡Œæ’ä»¶é’©å­
    execHooks(iframeWindow.__WUJIE.plugins, "windowAddEventListenerHook", iframeWindow, type, listener, options);
    
    // è®°å½•äº‹ä»¶
    iframeWindow.__WUJIE_EVENTLISTENER__.add({ type, listener, options });
    
    // è·¯ç”±ç›¸å…³äº‹ä»¶ä¿ç•™åœ¨ iframe
    if (appWindowAddEventListenerEvents.includes(type)) {
      return rawWindowAddEventListener.call(iframeWindow, type, listener, options);
    }
    
    // å…¶ä»–äº‹ä»¶ä»£ç†åˆ°ä¸»åº”ç”¨ window
    rawWindowAddEventListener.call(window.__WUJIE_RAW_WINDOW__ || window, type, listener, options);
  };
  
  iframeWindow.removeEventListener = function removeEventListener(type, listener, options) {
    // è¿è¡Œæ’ä»¶é’©å­
    execHooks(iframeWindow.__WUJIE.plugins, "windowRemoveEventListenerHook", iframeWindow, type, listener, options);
    
    // ç§»é™¤è®°å½•
    iframeWindow.__WUJIE_EVENTLISTENER__.forEach((o) => {
      if (o.listener === listener && o.type === type && options == o.options) {
        iframeWindow.__WUJIE_EVENTLISTENER__.delete(o);
      }
    });
    
    // å¯¹åº”ç§»é™¤
    if (appWindowAddEventListenerEvents.includes(type)) {
      return rawWindowRemoveEventListener.call(iframeWindow, type, listener, options);
    }
    rawWindowRemoveEventListener.call(window.__WUJIE_RAW_WINDOW__ || window, type, listener, options);
  };
}
```

äº‹ä»¶åˆ†ç±»ï¼š

| äº‹ä»¶ç±»å‹ | ç›‘å¬ä½ç½® | ç¤ºä¾‹ |
|---------|---------|------|
| è·¯ç”±äº‹ä»¶ | iframe | popstate, hashchange |
| DOM äº‹ä»¶ | ä¸»åº”ç”¨ window | click, scroll, resize |

## patch window å±æ€§

```typescript
// packages/wujie-core/src/iframe.ts
function patchWindowEffect(iframeWindow: Window): void {
  Object.getOwnPropertyNames(iframeWindow).forEach((key) => {
    // ç‰¹æ®Šå¤„ç† getSelection
    if (key === "getSelection") {
      Object.defineProperty(iframeWindow, key, {
        get: () => iframeWindow.document[key],
      });
      return;
    }
    
    // ä»£ç†åˆ°ä¸»åº”ç”¨ window
    if (windowProxyProperties.includes(key)) {
      processWindowProperty(key);
      return;
    }
    
    // æ­£åˆ™åŒ¹é…
    windowRegWhiteList.some((reg) => {
      if (reg.test(key) && key in iframeWindow.parent) {
        return processWindowProperty(key);
      }
      return false;
    });
  });
  
  // å¤„ç† onEvent
  const windowOnEvents = Object.getOwnPropertyNames(window)
    .filter((p) => /^on/.test(p))
    .filter((e) => !appWindowOnEvent.includes(e));
  
  windowOnEvents.forEach((e) => {
    Object.defineProperty(iframeWindow, e, {
      get: () => window[e],
      set: (handler) => {
        window[e] = typeof handler === "function" ? handler.bind(iframeWindow) : handler;
      },
    });
  });
  
  // è¿è¡Œæ’ä»¶é’©å­
  execHooks(iframeWindow.__WUJIE.plugins, "windowPropertyOverride", iframeWindow);
}
```

## è„šæœ¬æ‰§è¡Œ

```typescript
// packages/wujie-core/src/iframe.ts
export function insertScriptToIframe(scriptResult, iframeWindow, rawElement?) {
  const { src, module, content, crossorigin, async, attrs, callback, onload } = scriptResult;
  const scriptElement = iframeWindow.document.createElement("script");
  const { replace, plugins, proxyLocation } = iframeWindow.__WUJIE;
  
  // 1. é€šè¿‡ jsLoader å¤„ç†ä»£ç 
  const jsLoader = getJsLoader({ plugins, replace });
  let code = jsLoader(content, src, getCurUrl(proxyLocation));
  
  // 2. å†…è”è„šæœ¬åŒ…è£…
  if (content && !module) {
    // å…³é”®ï¼šå°† window/self/global/location æ›¿æ¢ä¸ºä»£ç†å¯¹è±¡
    code = `(function(window, self, global, location) {
      ${code}
    }).bind(window.__WUJIE.proxy)(
      window.__WUJIE.proxy,
      window.__WUJIE.proxy,
      window.__WUJIE.proxy,
      window.__WUJIE.proxyLocation,
    );`;
  }
  
  // 3. è®¾ç½®è„šæœ¬å†…å®¹
  scriptElement.textContent = code || "";
  
  // 4. æ’å…¥æ‰§è¡Œ
  const container = rawDocumentQuerySelector.call(iframeWindow.document, "head");
  container.appendChild(scriptElement);
  
  // 5. æ‰§è¡Œä¸‹ä¸€ä¸ªè„šæœ¬
  const execNextScript = () => !async && container.appendChild(nextScriptElement);
}
```

æ ¸å¿ƒæŠ€å·§ï¼šé€šè¿‡ IIFE åŒ…è£…ï¼Œå°†å…¨å±€å˜é‡æ›¿æ¢ä¸ºä»£ç†å¯¹è±¡ï¼š

```javascript
// åŸå§‹ä»£ç 
window.foo = 'bar';
document.getElementById('app');

// åŒ…è£…å
(function(window, self, global, location) {
  window.foo = 'bar';  // å®é™…æ“ä½œ proxy
  document.getElementById('app');  // å®é™…æ“ä½œ proxyDocument
}).bind(window.__WUJIE.proxy)(
  window.__WUJIE.proxy,
  window.__WUJIE.proxy,
  window.__WUJIE.proxy,
  window.__WUJIE.proxyLocation,
);
```

## æ³¨å…¥å˜é‡

```typescript
// packages/wujie-core/src/iframe.ts
function patchIframeVariable(iframeWindow: Window, wujie: WuJie, appHostPath: string): void {
  // æ²™ç®±å®ä¾‹
  iframeWindow.__WUJIE = wujie;
  
  // å…¬å…±è·¯å¾„
  iframeWindow.__WUJIE_PUBLIC_PATH__ = appHostPath + "/";
  
  // å­åº”ç”¨æ¥å£
  iframeWindow.$wujie = wujie.provide;
  
  // åŸå§‹ window
  iframeWindow.__WUJIE_RAW_WINDOW__ = iframeWindow;
}
```

å­åº”ç”¨å¯é€šè¿‡ `window.$wujie` è®¿é—®ï¼š

```typescript
// å­åº”ç”¨ä¸­
window.$wujie.bus.$emit('event', data);  // äº‹ä»¶é€šä¿¡
window.$wujie.props;                      // è·å– props
window.$wujie.location;                   // ä»£ç†çš„ location
```

## é”€æ¯æ¸…ç†

```typescript
// packages/wujie-core/src/sandbox.ts
public async destroy() {
  await this.unmount();
  
  // æ¸…ç†äº‹ä»¶
  this.bus.$clear();
  
  // æ¸…ç†ä»£ç†
  this.proxy = null;
  this.proxyDocument = null;
  this.proxyLocation = null;
  
  // æ¸…ç† DOM
  if (this.el) {
    clearChild(this.el);
    this.el = null;
  }
  
  // æ¸…ç† iframe
  if (this.iframe) {
    const iframeWindow = this.iframe.contentWindow;
    
    // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬
    if (iframeWindow?.__WUJIE_EVENTLISTENER__) {
      iframeWindow.__WUJIE_EVENTLISTENER__.forEach((o) => {
        iframeWindow.removeEventListener(o.type, o.listener, o.options);
      });
    }
    
    // ç§»é™¤ iframe
    this.iframe.parentNode?.removeChild(this.iframe);
    this.iframe = null;
  }
  
  // ä»ç¼“å­˜ä¸­åˆ é™¤
  deleteWujieById(this.id);
}
```

## å°ç»“

æ— ç•Œçš„ iframe æ²™ç®±æœºåˆ¶ï¼š

1. **åŒåŸŸ iframe**ï¼šé¿å…è·¨åŸŸé—®é¢˜ï¼Œä¿è¯ JS éš”ç¦»
2. **é˜»æ­¢åŠ è½½**ï¼šåˆ›å»ºç©ºç™½ iframeï¼Œä¸åŠ è½½ä¸»åº”ç”¨å†…å®¹
3. **patch åŠ«æŒ**ï¼šhistoryã€äº‹ä»¶ã€window å±æ€§å…¨é¢åŠ«æŒ
4. **IIFE åŒ…è£…**ï¼šè„šæœ¬æ‰§è¡Œæ—¶æ›¿æ¢å…¨å±€å˜é‡ä¸ºä»£ç†å¯¹è±¡
5. **äº‹ä»¶åˆ†æµ**ï¼šè·¯ç”±äº‹ä»¶ç•™åœ¨ iframeï¼ŒDOM äº‹ä»¶ä»£ç†åˆ°ä¸»åº”ç”¨

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†æ CSS éš”ç¦»çš„å®ç°ã€‚

---

> ğŸ“¦ æºç ç‰ˆæœ¬ï¼šwujie v1.0.22
>
> ä¸Šä¸€ç¯‡ï¼šæ¶æ„æ€»è§ˆ
>
> ä¸‹ä¸€ç¯‡ï¼šCSS éš”ç¦»
