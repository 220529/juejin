# æ— ç•Œå¾®å‰ç«¯æºç è§£æžï¼šè·¯ç”±åŒæ­¥

> æ·±å…¥åˆ†æžä¸»å­åº”ç”¨è·¯ç”±åŒæ­¥æœºåˆ¶ï¼Œç†è§£ sync æ¨¡å¼çš„å®žçŽ°åŽŸç†ã€‚

## è·¯ç”±åŒæ­¥åŽŸç†

æ— ç•Œé€šè¿‡ URL query å‚æ•°å®žçŽ°ä¸»å­åº”ç”¨è·¯ç”±åŒæ­¥ï¼š

```
ä¸»åº”ç”¨ URL:
https://main.com/home?vue3=%2Fuser%2F123

å­åº”ç”¨å®žé™…è·¯ç”±:
/user/123
```

## åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     pushState/replaceState     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                 â”‚
â”‚   å­åº”ç”¨è·¯ç”±     â”‚                                â”‚   ä¸»åº”ç”¨ URL    â”‚
â”‚                 â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     æµè§ˆå™¨åˆ·æ–°/å‰è¿›åŽé€€         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å­åº”ç”¨ â†’ ä¸»åº”ç”¨

```typescript
// packages/wujie-core/src/sync.ts
export function syncUrlToWindow(iframeWindow: Window): void {
  const { sync, id, prefix } = iframeWindow.__WUJIE;
  
  // è§£æžä¸»åº”ç”¨ URL
  let winUrlElement = anchorElementGenerator(window.location.href);
  const queryMap = getAnchorElementQueryMap(winUrlElement);
  
  // éžåŒæ­¥æ¨¡å¼ä¸” URL ä¸Šæ²¡æœ‰å½“å‰ id çš„å‚æ•°ï¼Œç›´æŽ¥è¿”å›ž
  if (!sync && !queryMap[id]) return (winUrlElement = null);
  
  // èŽ·å–å­åº”ç”¨å½“å‰è·¯ç”±
  const curUrl = iframeWindow.location.pathname + 
                 iframeWindow.location.search + 
                 iframeWindow.location.hash;
  
  // å¤„ç†çŸ­è·¯å¾„
  let validShortPath = "";
  if (prefix) {
    Object.keys(prefix).forEach((shortPath) => {
      const longPath = prefix[shortPath];
      // æ‰¾å‡ºæœ€é•¿åŒ¹é…è·¯å¾„
      if (curUrl.startsWith(longPath) && 
          (!validShortPath || longPath.length > prefix[validShortPath].length)) {
        validShortPath = shortPath;
      }
    });
  }
  
  // åŒæ­¥æ¨¡å¼ï¼šæ›´æ–°å‚æ•°
  if (sync) {
    queryMap[id] = window.encodeURIComponent(
      validShortPath 
        ? curUrl.replace(prefix[validShortPath], `{${validShortPath}}`) 
        : curUrl
    );
  } else {
    // éžåŒæ­¥æ¨¡å¼ï¼šæ¸…ç†å‚æ•°
    delete queryMap[id];
  }
  
  // æž„å»ºæ–° URL
  const newQuery = "?" + Object.keys(queryMap)
    .map((key) => key + "=" + queryMap[key])
    .join("&");
  winUrlElement.search = newQuery;
  
  // æ›´æ–°ä¸»åº”ç”¨ URL
  if (winUrlElement.href !== window.location.href) {
    window.history.replaceState(null, "", winUrlElement.href);
  }
  winUrlElement = null;
}
```

## ä¸»åº”ç”¨ â†’ å­åº”ç”¨

```typescript
// packages/wujie-core/src/sync.ts
export function syncUrlToIframe(iframeWindow: Window): void {
  const { pathname, search, hash } = iframeWindow.location;
  const { id, url, sync, execFlag, prefix, inject } = iframeWindow.__WUJIE;

  // åªåœ¨æµè§ˆå™¨åˆ·æ–°æˆ–ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶åŒæ­¥
  const idUrl = sync && !execFlag ? getSyncUrl(id, prefix) : url;
  
  // æŽ’é™¤ href è·³è½¬æƒ…å†µ
  const syncUrl = (/^http/.test(idUrl) ? null : idUrl) || url;
  const { appRoutePath } = appRouteParse(syncUrl);

  const preAppRoutePath = pathname + search + hash;
  
  // è·¯ç”±ä¸åŒåˆ™åŒæ­¥
  if (preAppRoutePath !== appRoutePath) {
    iframeWindow.history.replaceState(null, "", inject.mainHostPath + appRoutePath);
  }
}
```

## èŽ·å–åŒæ­¥ URL

```typescript
// packages/wujie-core/src/utils.ts
export function getSyncUrl(id: string, prefix?: { [key: string]: string }): string {
  const winUrlElement = anchorElementGenerator(window.location.href);
  const queryMap = getAnchorElementQueryMap(winUrlElement);
  
  let syncUrl = queryMap[id] ? window.decodeURIComponent(queryMap[id]) : "";
  
  // å¤„ç†çŸ­è·¯å¾„è¿˜åŽŸ
  if (prefix && syncUrl) {
    Object.keys(prefix).forEach((shortPath) => {
      const longPath = prefix[shortPath];
      syncUrl = syncUrl.replace(`{${shortPath}}`, longPath);
    });
  }
  
  return syncUrl;
}
```

## çŸ­è·¯å¾„é…ç½®

é€šè¿‡ `prefix` é…ç½®å¯ä»¥ç¼©çŸ­ URLï¼š

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  sync: true,
  prefix: {
    'u': '/user',           // /user/123 â†’ {u}/123
    'p': '/product/detail', // /product/detail/456 â†’ {p}/456
  },
});
```

æ•ˆæžœï¼š
```
åŽŸå§‹: ?vue3=%2Fuser%2F123
çŸ­è·¯å¾„: ?vue3=%7Bu%7D%2F123
```

## History åŠ«æŒ

```typescript
// packages/wujie-core/src/iframe.ts
function patchIframeHistory(iframeWindow: Window, appHostPath: string, mainHostPath: string): void {
  const history = iframeWindow.history;
  const rawHistoryPushState = history.pushState;
  const rawHistoryReplaceState = history.replaceState;
  
  history.pushState = function (data: any, title: string, url?: string): void {
    // å°†å­åº”ç”¨è·¯å¾„è½¬æ¢ä¸ºä¸»åº”ç”¨è·¯å¾„
    const baseUrl = mainHostPath + iframeWindow.location.pathname + 
                    iframeWindow.location.search + iframeWindow.location.hash;
    const mainUrl = getAbsolutePath(url?.replace(appHostPath, ""), baseUrl);
    const ignoreFlag = url === undefined;

    // è°ƒç”¨åŽŸç”Ÿæ–¹æ³•
    rawHistoryPushState.call(history, data, title, ignoreFlag ? undefined : mainUrl);
    if (ignoreFlag) return;
    
    // æ›´æ–° base æ ‡ç­¾
    updateBase(iframeWindow, appHostPath, mainHostPath);
    // åŒæ­¥åˆ°ä¸»åº”ç”¨
    syncUrlToWindow(iframeWindow);
  };
  
  history.replaceState = function (data: any, title: string, url?: string): void {
    // ç±»ä¼¼é€»è¾‘...
  };
}
```

## å‰è¿›åŽé€€ç›‘å¬

```typescript
// packages/wujie-core/src/iframe.ts
export function syncIframeUrlToWindow(iframeWindow: Window): void {
  // hashchange äº‹ä»¶
  iframeWindow.addEventListener("hashchange", () => syncUrlToWindow(iframeWindow));
  
  // popstate äº‹ä»¶
  iframeWindow.addEventListener("popstate", () => {
    syncUrlToWindow(iframeWindow);
  });
}
```

## href è·³è½¬å¤„ç†

```typescript
// packages/wujie-core/src/sync.ts
export function processAppForHrefJump(): void {
  window.addEventListener("popstate", () => {
    let winUrlElement = anchorElementGenerator(window.location.href);
    const queryMap = getAnchorElementQueryMap(winUrlElement);
    winUrlElement = null;
    
    Object.keys(queryMap)
      .map((id) => getWujieById(id))
      .filter((sandbox) => sandbox)
      .forEach((sandbox) => {
        const url = queryMap[sandbox.id];
        const iframeBody = rawDocumentQuerySelector.call(sandbox.iframe.contentDocument, "body");
        
        // å‰è¿›åˆ° href è·³è½¬çš„é¡µé¢
        if (/http/.test(url)) {
          if (sandbox.degrade) {
            renderElementToContainer(sandbox.document.documentElement, iframeBody);
            renderIframeReplaceApp(
              window.decodeURIComponent(url),
              getDegradeIframe(sandbox.id).parentElement,
              sandbox.degradeAttrs
            );
          } else {
            renderIframeReplaceApp(
              window.decodeURIComponent(url),
              sandbox.shadowRoot.host.parentElement,
              sandbox.degradeAttrs
            );
          }
          sandbox.hrefFlag = true;
          
        // ä»Ž href é¡µé¢åŽé€€
        } else if (sandbox.hrefFlag) {
          if (sandbox.degrade) {
            const { iframe } = initRenderIframeAndContainer(sandbox.id, sandbox.el, sandbox.degradeAttrs);
            patchEventTimeStamp(iframe.contentWindow, sandbox.iframe.contentWindow);
            iframe.contentWindow.onunload = () => sandbox.unmount();
            iframe.contentDocument.appendChild(iframeBody.firstElementChild);
            sandbox.document = iframe.contentDocument;
          } else {
            renderElementToContainer(sandbox.shadowRoot.host, sandbox.el);
          }
          sandbox.hrefFlag = false;
        }
      });
  });
}
```

## æ¸…ç†éžæ¿€æ´»åº”ç”¨ URL

```typescript
// packages/wujie-core/src/sync.ts
export function clearInactiveAppUrl(): void {
  let winUrlElement = anchorElementGenerator(window.location.href);
  const queryMap = getAnchorElementQueryMap(winUrlElement);
  
  Object.keys(queryMap).forEach((id) => {
    const sandbox = getWujieById(id);
    if (!sandbox) return;
    
    // å­åº”ç”¨æ‰§è¡Œè¿‡ä¸”å·²å¤±æ´»æ‰éœ€è¦æ¸…é™¤
    if (sandbox.execFlag && sandbox.sync && !sandbox.hrefFlag && !sandbox.activeFlag) {
      delete queryMap[id];
    }
  });
  
  const newQuery = "?" + Object.keys(queryMap)
    .map((key) => key + "=" + window.decodeURIComponent(queryMap[key]))
    .join("&");
  winUrlElement.search = newQuery;
  
  if (winUrlElement.href !== window.location.href) {
    window.history.replaceState(null, "", winUrlElement.href);
  }
  winUrlElement = null;
}
```

## æŽ¨é€ URL

```typescript
// packages/wujie-core/src/sync.ts
export function pushUrlToWindow(id: string, url: string): void {
  let winUrlElement = anchorElementGenerator(window.location.href);
  const queryMap = getAnchorElementQueryMap(winUrlElement);
  
  // æ›´æ–°å‚æ•°
  queryMap[id] = window.encodeURIComponent(url);
  
  const newQuery = "?" + Object.keys(queryMap)
    .map((key) => key + "=" + queryMap[key])
    .join("&");
  winUrlElement.search = newQuery;
  
  // ä½¿ç”¨ pushState æ·»åŠ åŽ†å²è®°å½•
  window.history.pushState(null, "", winUrlElement.href);
  winUrlElement = null;
}
```

## ä½¿ç”¨ç¤ºä¾‹

```typescript
// å¼€å¯è·¯ç”±åŒæ­¥
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  el: '#container',
  sync: true,  // å¼€å¯åŒæ­¥
  prefix: {
    'u': '/user',
  },
});

// å­åº”ç”¨è·¯ç”±å˜åŒ–
// /user/123 â†’ ä¸»åº”ç”¨ URL: ?vue3=%7Bu%7D%2F123

// åˆ·æ–°æµè§ˆå™¨
// ä¸»åº”ç”¨ URL: ?vue3=%7Bu%7D%2F123 â†’ å­åº”ç”¨æ¢å¤åˆ° /user/123
```

## å°ç»“

æ— ç•Œçš„è·¯ç”±åŒæ­¥æœºåˆ¶ï¼š

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|-----|---------|
| å­åº”ç”¨è·¯ç”±å˜åŒ– | é€šè¿‡ history åŠ«æŒåŒæ­¥åˆ°ä¸»åº”ç”¨ URL |
| æµè§ˆå™¨åˆ·æ–° | ä»Žä¸»åº”ç”¨ URL æ¢å¤å­åº”ç”¨è·¯ç”± |
| å‰è¿›åŽé€€ | ç›‘å¬ popstate äº‹ä»¶åŒæ­¥ |
| href è·³è½¬ | ç‰¹æ®Šå¤„ç†ï¼Œé‡æ–°æ¸²æŸ“ iframe |
| åº”ç”¨åˆ‡æ¢ | æ¸…ç†éžæ¿€æ´»åº”ç”¨çš„ URL å‚æ•° |

æ ¸å¿ƒæŠ€å·§ï¼š
1. **URL Query å­˜å‚¨**ï¼šå­åº”ç”¨è·¯ç”±ç¼–ç åŽå­˜å…¥ä¸»åº”ç”¨ URL
2. **çŸ­è·¯å¾„ä¼˜åŒ–**ï¼šé€šè¿‡ prefix é…ç½®ç¼©çŸ­ URL
3. **History åŠ«æŒ**ï¼šæ‹¦æˆª pushState/replaceState å®žçŽ°åŒæ­¥
4. **äº‹ä»¶ç›‘å¬**ï¼šhashchange å’Œ popstate å¤„ç†å‰è¿›åŽé€€

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†æžé€šä¿¡æœºåˆ¶ã€‚

---

> ðŸ“¦ æºç ç‰ˆæœ¬ï¼šwujie v1.0.22
>
> ä¸Šä¸€ç¯‡ï¼šJS éš”ç¦»
>
> ä¸‹ä¸€ç¯‡ï¼šé€šä¿¡æœºåˆ¶
