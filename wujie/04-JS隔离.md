# æ— ç•Œå¾®å‰ç«¯æºç è§£æï¼šJS éš”ç¦»

> æ·±å…¥åˆ†æ Proxy ä»£ç† windowã€documentã€location çš„å®ç°åŸç†ã€‚

## ä»£ç†æ¶æ„

æ— ç•Œé€šè¿‡ Proxy å°† iframe ä¸­çš„ DOM æ“ä½œä»£ç†åˆ° Shadow DOMï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    iframe (JS è¿è¡Œ)                      â”‚
â”‚                                                         â”‚
â”‚   window.xxx        â†’  proxyWindow.xxx                  â”‚
â”‚   document.xxx      â†’  proxyDocument.xxx â†’ shadowRoot   â”‚
â”‚   location.xxx      â†’  proxyLocation.xxx                â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Shadow DOM (DOM æ¸²æŸ“)                   â”‚
â”‚                                                         â”‚
â”‚   å®é™…çš„ DOM æ“ä½œåœ¨è¿™é‡Œæ‰§è¡Œ                               â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## proxyWindow

```typescript
// packages/wujie-core/src/proxy.ts
const proxyWindow = new Proxy(iframe.contentWindow, {
  get: (target: Window, p: PropertyKey): any => {
    // 1. location åŠ«æŒ
    if (p === "location") {
      return target.__WUJIE.proxyLocation;
    }
    
    // 2. self/window è¿”å›ä»£ç†
    if (p === "self" || (p === "window" && Object.getOwnPropertyDescriptor(window, "window").get)) {
      return target.__WUJIE.proxy;
    }
    
    // 3. ä¿ç•™åŸç”Ÿæ–¹æ³•
    if (p === "__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__" || p === "__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__") {
      return target[p];
    }
    
    // 4. ä¸å¯é…ç½®ä¸”ä¸å¯å†™çš„å±æ€§ç›´æ¥è¿”å›
    const descriptor = Object.getOwnPropertyDescriptor(target, p);
    if (descriptor?.configurable === false && descriptor?.writable === false) {
      return target[p];
    }
    
    // 5. ä¿®æ­£ this æŒ‡å‘
    return getTargetValue(target, p);
  },

  set: (target: Window, p: PropertyKey, value: any) => {
    checkProxyFunction(target, value);
    target[p] = value;
    return true;
  },

  has: (target: Window, p: PropertyKey) => p in target,
});
```

`getTargetValue` å¤„ç†å‡½æ•°ç»‘å®šï¼š

```typescript
// packages/wujie-core/src/utils.ts
export function getTargetValue(target: any, p: PropertyKey): any {
  const value = target[p];
  
  // å‡½æ•°éœ€è¦ç»‘å®šæ­£ç¡®çš„ this
  if (typeof value === "function" && !isConstructable(value)) {
    const bindTarget = value.name.startsWith("bound ") ? target : target;
    return value.bind(bindTarget);
  }
  
  return value;
}
```

## proxyDocument

```typescript
// packages/wujie-core/src/proxy.ts
const proxyDocument = new Proxy({}, {
  get: function (_fakeDocument, propKey) {
    const document = window.document;
    const { shadowRoot, proxyLocation } = iframe.contentWindow.__WUJIE;
    
    // iframe åˆå§‹åŒ–å®Œæˆä½† webcomponent æœªæŒ‚è½½ï¼Œä¸­æ­¢æ‰§è¡Œ
    if (!shadowRoot) stopMainAppRun();
    
    const rawCreateElement = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__;
    const rawCreateTextNode = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__;
    
    // 1. createElement / createTextNode
    if (propKey === "createElement" || propKey === "createTextNode") {
      return new Proxy(document[propKey], {
        apply(_createElement, _ctx, args) {
          const rawCreateMethod = propKey === "createElement" ? rawCreateElement : rawCreateTextNode;
          const element = rawCreateMethod.apply(iframe.contentDocument, args);
          patchElementEffect(element, iframe.contentWindow);
          return element;
        },
      });
    }
    
    // 2. documentURI / URL
    if (propKey === "documentURI" || propKey === "URL") {
      return (proxyLocation as Location).href;
    }

    // 3. getElementsByTagName / getElementsByClassName / getElementsByName
    if (propKey === "getElementsByTagName" || propKey === "getElementsByClassName" || propKey === "getElementsByName") {
      return new Proxy(shadowRoot.querySelectorAll, {
        apply(querySelectorAll, _ctx, args) {
          let arg = args[0];
          if (_ctx !== iframe.contentDocument) {
            return _ctx[propKey].apply(_ctx, args);
          }

          // script æ ‡ç­¾ä» iframe è·å–
          if (propKey === "getElementsByTagName" && arg === "script") {
            return iframe.contentDocument.scripts;
          }
          
          // è½¬æ¢é€‰æ‹©å™¨
          if (propKey === "getElementsByClassName") arg = "." + arg;
          if (propKey === "getElementsByName") arg = `[name="${arg}"]`;

          return querySelectorAll.call(shadowRoot, arg);
        },
      });
    }
    
    // 4. getElementById
    if (propKey === "getElementById") {
      return new Proxy(shadowRoot.querySelector, {
        apply(target, ctx, args) {
          if (ctx !== iframe.contentDocument) {
            return ctx[propKey]?.apply(ctx, args);
          }
          // å…ˆä» shadowRoot æŸ¥æ‰¾ï¼Œå†ä» iframe æŸ¥æ‰¾
          return (
            target.call(shadowRoot, `[id="${args[0]}"]`) ||
            iframe.contentWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__.call(
              iframe.contentWindow.document,
              `#${args[0]}`
            )
          );
        },
      });
    }
    
    // 5. querySelector / querySelectorAll
    if (propKey === "querySelector" || propKey === "querySelectorAll") {
      return new Proxy(shadowRoot[propKey], {
        apply(target, ctx, args) {
          if (ctx !== iframe.contentDocument) {
            return ctx[propKey]?.apply(ctx, args);
          }
          // ä¼˜å…ˆ shadowRootï¼Œå…¶æ¬¡ iframeï¼ˆæ’é™¤ baseï¼‰
          return (
            target.apply(shadowRoot, args) ||
            (args[0] === "base" ? null : iframe.contentWindow[rawPropMap[propKey]].call(iframe.contentWindow.document, args[0]))
          );
        },
      });
    }
    
    // 6. documentElement / scrollingElement
    if (propKey === "documentElement" || propKey === "scrollingElement") {
      return shadowRoot.firstElementChild;
    }
    
    // 7. forms / images / links
    if (propKey === "forms") return shadowRoot.querySelectorAll("form");
    if (propKey === "images") return shadowRoot.querySelectorAll("img");
    if (propKey === "links") return shadowRoot.querySelectorAll("a");
    
    // 8. å…¶ä»–å±æ€§åˆ†ç±»å¤„ç†
    const { ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods } =
      documentProxyProperties;
      
    // ä» shadowRoot è·å–
    if (ownerProperties.concat(shadowProperties).includes(propKey.toString())) {
      if (propKey === "activeElement" && shadowRoot.activeElement === null) {
        return shadowRoot.body;
      }
      return shadowRoot[propKey];
    }
    
    // shadowRoot æ–¹æ³•
    if (shadowMethods.includes(propKey.toString())) {
      return getTargetValue(shadowRoot, propKey) ?? getTargetValue(document, propKey);
    }
    
    // ä» window.document è·å–
    if (documentProperties.includes(propKey.toString())) {
      return document[propKey];
    }
    if (documentMethods.includes(propKey.toString())) {
      return getTargetValue(document, propKey);
    }
  },
});
```

## proxyLocation

```typescript
// packages/wujie-core/src/proxy.ts
const proxyLocation = new Proxy({}, {
  get: function (_fakeLocation, propKey) {
    const location = iframe.contentWindow.location;
    
    // 1. åŸŸåç›¸å…³å±æ€§ä» urlElement è·å–
    if (propKey === "host" || propKey === "hostname" || propKey === "protocol" || 
        propKey === "port" || propKey === "origin") {
      return urlElement[propKey];
    }
    
    // 2. href éœ€è¦æ›¿æ¢åŸŸå
    if (propKey === "href") {
      return location[propKey].replace(mainHostPath, appHostPath);
    }
    
    // 3. ç¦ç”¨ reload
    if (propKey === "reload") {
      warn(WUJIE_TIPS_RELOAD_DISABLED);
      return () => null;
    }
    
    // 4. replace éœ€è¦æ›¿æ¢è·¯å¾„
    if (propKey === "replace") {
      return new Proxy(location[propKey], {
        apply(replace, _ctx, args) {
          return replace.call(location, args[0]?.replace(appHostPath, mainHostPath));
        },
      });
    }
    
    return getTargetValue(location, propKey);
  },
  
  set: function (_fakeLocation, propKey, value) {
    // href è·³è½¬éœ€è¦ç‰¹æ®Šå¤„ç†
    if (propKey === "href") {
      return locationHrefSet(iframe, value, appHostPath);
    }
    iframe.contentWindow.location[propKey] = value;
    return true;
  },
  
  ownKeys: function () {
    return Object.keys(iframe.contentWindow.location).filter((key) => key !== "reload");
  },
});
```

## location.href è·³è½¬å¤„ç†

```typescript
// packages/wujie-core/src/proxy.ts
function locationHrefSet(iframe: HTMLIFrameElement, value: string, appHostPath: string): boolean {
  const { shadowRoot, id, degrade, document, degradeAttrs } = iframe.contentWindow.__WUJIE;
  
  // å¤„ç†ç›¸å¯¹è·¯å¾„
  let url = value;
  if (!/^http/.test(url)) {
    let hrefElement = anchorElementGenerator(url);
    url = appHostPath + hrefElement.pathname + hrefElement.search + hrefElement.hash;
  }
  
  // æ ‡è®° href è·³è½¬
  iframe.contentWindow.__WUJIE.hrefFlag = true;
  
  // é‡æ–°æ¸²æŸ“
  if (degrade) {
    const iframeBody = rawDocumentQuerySelector.call(iframe.contentDocument, "body");
    renderElementToContainer(document.documentElement, iframeBody);
    renderIframeReplaceApp(window.decodeURIComponent(url), getDegradeIframe(id).parentElement, degradeAttrs);
  } else {
    renderIframeReplaceApp(url, shadowRoot.host.parentElement, degradeAttrs);
  }
  
  // åŒæ­¥è·¯ç”±
  pushUrlToWindow(id, url);
  return true;
}
```

## é™çº§æ¨¡å¼ä»£ç†

ä¸æ”¯æŒ Proxy æ—¶ä½¿ç”¨ç®€å•å¯¹è±¡ä»£ç†ï¼š

```typescript
// packages/wujie-core/src/proxy.ts
export function localGenerator(
  iframe: HTMLIFrameElement,
  urlElement: HTMLAnchorElement,
  mainHostPath: string,
  appHostPath: string
): { proxyDocument: Object; proxyLocation: Object } {
  const proxyDocument = {};
  const sandbox = iframe.contentWindow.__WUJIE;
  
  // ç‰¹æ®Šå¤„ç†
  Object.defineProperties(proxyDocument, {
    createElement: {
      get: () => function (...args) {
        const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__.apply(
          iframe.contentDocument, args
        );
        patchElementEffect(element, iframe.contentWindow);
        return element;
      },
    },
    
    getElementById: {
      get() {
        return function (...args) {
          const id = args[0];
          return (
            sandbox.document.getElementById(id) ||
            iframe.contentWindow.__WUJIE_RAW_DOCUMENT_HEAD__.querySelector(`#${id}`)
          );
        };
      },
    },
    // ...å…¶ä»–å±æ€§
  });

  // ä»£ç† location
  const proxyLocation = {};
  const location = iframe.contentWindow.location;
  
  // å¸¸é‡å±æ€§
  ["host", "hostname", "port", "protocol"].forEach((key) => {
    proxyLocation[key] = urlElement[key];
  });
  
  Object.defineProperties(proxyLocation, {
    href: {
      get: () => location.href.replace(mainHostPath, appHostPath),
      set: (value) => locationHrefSet(iframe, value, appHostPath),
    },
    reload: {
      get() {
        warn(WUJIE_TIPS_RELOAD_DISABLED);
        return () => null;
      },
    },
  });
  
  return { proxyDocument, proxyLocation };
}
```

## Document å±æ€§åˆ†ç±»

```typescript
// packages/wujie-core/src/common.ts
export const documentProxyProperties = {
  // ä» shadowRoot è·å–çš„å±æ€§
  ownerProperties: ["head", "body"],
  
  shadowProperties: [
    "activeElement", "childElementCount", "children", "firstElementChild",
    "lastElementChild", "pictureInPictureElement", "pointerLockElement",
    "styleSheets",
  ],
  
  shadowMethods: [
    "append", "contains", "getSelection", "elementFromPoint",
    "elementsFromPoint", "getAnimations", "prepend", "replaceChildren",
  ],
  
  // ä» window.document è·å–çš„å±æ€§
  documentProperties: [
    "characterSet", "compatMode", "contentType", "cookie", "currentScript",
    "defaultView", "designMode", "dir", "doctype", "domain", "fullscreen",
    "fullscreenEnabled", "hidden", "implementation", "lastModified",
    "readyState", "referrer", "title", "visibilityState",
  ],
  
  documentMethods: [
    "adoptNode", "close", "createAttribute", "createComment",
    "createDocumentFragment", "createEvent", "createExpression",
    "createNodeIterator", "createNSResolver", "createProcessingInstruction",
    "createRange", "createTreeWalker", "evaluate", "execCommand",
    "exitFullscreen", "exitPictureInPicture", "exitPointerLock",
    "getSelection", "hasFocus", "importNode", "open", "queryCommandEnabled",
    "queryCommandState", "queryCommandSupported", "write", "writeln",
  ],
};
```

## å…ƒç´  patch

```typescript
// packages/wujie-core/src/iframe.ts
export function patchElementEffect(
  element: (HTMLElement | Node | ShadowRoot) & { _hasPatch?: boolean },
  iframeWindow: Window
): void {
  const proxyLocation = iframeWindow.__WUJIE.proxyLocation as Location;
  
  if (element._hasPatch) return;
  
  try {
    Object.defineProperties(element, {
      // baseURI è¿”å›ä»£ç†çš„ location
      baseURI: {
        configurable: true,
        get: () => proxyLocation.protocol + "//" + proxyLocation.host + proxyLocation.pathname,
      },
      // ownerDocument è¿”å› iframe çš„ document
      ownerDocument: {
        configurable: true,
        get: () => iframeWindow.document,
      },
      _hasPatch: { get: () => true },
    });
  } catch (error) {
    console.warn(error);
  }
  
  // è¿è¡Œæ’ä»¶é’©å­
  execHooks(iframeWindow.__WUJIE.plugins, "patchElementHook", element, iframeWindow);
}
```

## å°ç»“

æ— ç•Œçš„ JS éš”ç¦»é€šè¿‡ä¸‰å±‚ä»£ç†å®ç°ï¼š

| ä»£ç†å¯¹è±¡ | ä½œç”¨ | å…³é”®å¤„ç† |
|---------|------|---------|
| proxyWindow | ä»£ç† window | location åŠ«æŒã€self/window è¿”å›ä»£ç† |
| proxyDocument | ä»£ç† document | DOM æŸ¥è¯¢ä»£ç†åˆ° shadowRoot |
| proxyLocation | ä»£ç† location | åŸŸåæ›¿æ¢ã€href è·³è½¬å¤„ç† |

æ ¸å¿ƒæŠ€å·§ï¼š
1. **IIFE åŒ…è£…**ï¼šè„šæœ¬æ‰§è¡Œæ—¶æ›¿æ¢å…¨å±€å˜é‡
2. **å±æ€§åˆ†ç±»**ï¼šä¸åŒå±æ€§ä»ä¸åŒæ¥æºè·å–
3. **å…ƒç´  patch**ï¼šä¿®æ­£ baseURI å’Œ ownerDocument
4. **é™çº§æ–¹æ¡ˆ**ï¼šä¸æ”¯æŒ Proxy æ—¶ä½¿ç”¨ defineProperty

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†æè·¯ç”±åŒæ­¥æœºåˆ¶ã€‚

---

> ğŸ“¦ æºç ç‰ˆæœ¬ï¼šwujie v1.0.22
>
> ä¸Šä¸€ç¯‡ï¼š[CSS éš”ç¦»](https://juejin.cn/post/7588570963295600683)
>
> ä¸‹ä¸€ç¯‡ï¼š[è·¯ç”±åŒæ­¥](https://juejin.cn/post/7588704463621505043)
