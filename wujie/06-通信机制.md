# æ— ç•Œå¾®å‰ç«¯æºç è§£æï¼šé€šä¿¡æœºåˆ¶

> æ·±å…¥åˆ†æ EventBus äº‹ä»¶æ€»çº¿å’Œ props æ•°æ®ä¼ é€’çš„å®ç°åŸç†ã€‚

## é€šä¿¡æ–¹å¼

æ— ç•Œæä¾›ä¸¤ç§é€šä¿¡æ–¹å¼ï¼š

| æ–¹å¼ | åœºæ™¯ | ç‰¹ç‚¹ |
|-----|------|------|
| EventBus | äº‹ä»¶é©±åŠ¨ | å‘å¸ƒè®¢é˜…ï¼Œè§£è€¦ |
| props | æ•°æ®ä¼ é€’ | å•å‘æ•°æ®æµ |

## EventBus å®ç°

```typescript
// packages/wujie-core/src/event.ts
export type EventObj = { [event: string]: Array<Function> };

// å…¨å±€äº‹ä»¶å­˜å‚¨
export const appEventObjMap = (() => {
  if (window.__WUJIE_INJECT?.appEventObjMap) {
    return window.__WUJIE_INJECT.appEventObjMap;
  } else {
    const cacheMap = window.__POWERED_BY_WUJIE__ 
      ? window.__WUJIE.inject.appEventObjMap 
      : new Map<String, EventObj>();
    window.__WUJIE_INJECT = { ...window.__WUJIE_INJECT, appEventObjMap: cacheMap };
    return cacheMap;
  }
})();

export class EventBus {
  private id: string;
  private eventObj: EventObj;

  constructor(id: string) {
    this.id = id;
    this.$clear();
    
    // åˆå§‹åŒ–äº‹ä»¶å¯¹è±¡
    if (!appEventObjMap.get(this.id)) {
      appEventObjMap.set(this.id, {});
    }
    this.eventObj = appEventObjMap.get(this.id);
  }
}
```

## äº‹ä»¶ç›‘å¬

```typescript
// packages/wujie-core/src/event.ts
export class EventBus {
  // ç›‘å¬äº‹ä»¶
  public $on(event: string, fn: Function): EventBus {
    const cbs = this.eventObj[event];
    if (!cbs) {
      this.eventObj[event] = [fn];
      return this;
    }
    // é¿å…é‡å¤æ³¨å†Œ
    if (!cbs.includes(fn)) cbs.push(fn);
    return this;
  }

  // ç›‘å¬æ‰€æœ‰äº‹ä»¶
  public $onAll(fn: (event: string, ...args: Array<any>) => any): EventBus {
    return this.$on(WUJIE_ALL_EVENT, fn);
  }

  // ä¸€æ¬¡æ€§ç›‘å¬
  public $once(event: string, fn: Function): void {
    const on = function (...args: Array<any>) {
      this.$off(event, on);
      fn(...args);
    }.bind(this);
    this.$on(event, on);
  }
}
```

## å–æ¶ˆç›‘å¬

```typescript
// packages/wujie-core/src/event.ts
export class EventBus {
  // å–æ¶ˆç›‘å¬
  public $off(event: string, fn: Function): EventBus {
    const cbs = this.eventObj[event];
    if (!event || !cbs || !cbs.length) {
      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);
      return this;
    }

    let cb;
    let i = cbs.length;
    while (i--) {
      cb = cbs[i];
      if (cb === fn) {
        cbs.splice(i, 1);
        break;
      }
    }
    return this;
  }

  // å–æ¶ˆç›‘å¬æ‰€æœ‰äº‹ä»¶
  public $offAll(fn: Function): EventBus {
    return this.$off(WUJIE_ALL_EVENT, fn);
  }
}
```

## äº‹ä»¶å‘é€

```typescript
// packages/wujie-core/src/event.ts
export class EventBus {
  // å‘é€äº‹ä»¶
  public $emit(event: string, ...args: Array<any>): EventBus {
    let cbs = [];
    let allCbs = [];

    // éå†æ‰€æœ‰åº”ç”¨çš„äº‹ä»¶å¯¹è±¡
    appEventObjMap.forEach((eventObj) => {
      if (eventObj[event]) cbs = cbs.concat(eventObj[event]);
      if (eventObj[WUJIE_ALL_EVENT]) allCbs = allCbs.concat(eventObj[WUJIE_ALL_EVENT]);
    });

    if (!event || (cbs.length === 0 && allCbs.length === 0)) {
      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);
    } else {
      try {
        // æ‰§è¡Œç‰¹å®šäº‹ä»¶å›è°ƒ
        for (let i = 0, l = cbs.length; i < l; i++) cbs[i](...args);
        // æ‰§è¡Œå…¨å±€äº‹ä»¶å›è°ƒ
        for (let i = 0, l = allCbs.length; i < l; i++) allCbs[i](event, ...args);
      } catch (e) {
        error(e);
      }
    }
    return this;
  }
}
```

## æ¸…ç©ºäº‹ä»¶

```typescript
// packages/wujie-core/src/event.ts
export class EventBus {
  // æ¸…ç©ºå½“å‰åº”ç”¨çš„æ‰€æœ‰ç›‘å¬äº‹ä»¶
  public $clear(): EventBus {
    const eventObj = appEventObjMap.get(this.id) ?? {};
    const events = Object.keys(eventObj);
    events.forEach((event) => delete eventObj[event]);
    return this;
  }
}
```

## å…¨å±€ bus

```typescript
// packages/wujie-core/src/index.ts
export const bus = new EventBus(Date.now().toString());
```

ä¸»åº”ç”¨ä½¿ç”¨ï¼š

```typescript
import { bus } from 'wujie';

// ç›‘å¬äº‹ä»¶
bus.$on('user-login', (user) => {
  console.log('ç”¨æˆ·ç™»å½•:', user);
});

// å‘é€äº‹ä»¶
bus.$emit('app-ready', { version: '1.0.0' });
```

## å­åº”ç”¨ bus

```typescript
// packages/wujie-core/src/sandbox.ts
constructor(options) {
  // åˆ›å»ºå­åº”ç”¨ä¸“å± bus
  this.bus = new EventBus(this.id);
  
  // æä¾›ç»™å­åº”ç”¨
  this.provide = { bus: this.bus };
}
```

å­åº”ç”¨ä½¿ç”¨ï¼š

```typescript
// å­åº”ç”¨ä¸­
const { bus } = window.$wujie;

// ç›‘å¬äº‹ä»¶
bus.$on('app-ready', (data) => {
  console.log('ä¸»åº”ç”¨å°±ç»ª:', data);
});

// å‘é€äº‹ä»¶
bus.$emit('user-login', { name: 'John' });
```

## props ä¼ é€’

```typescript
// ä¸»åº”ç”¨
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  el: '#container',
  props: {
    user: { name: 'John', age: 25 },
    api: {
      getUserInfo: () => fetch('/api/user'),
      logout: () => { /* ... */ },
    },
  },
});
```

å­åº”ç”¨è·å–ï¼š

```typescript
// å­åº”ç”¨ä¸­
const { props } = window.$wujie;

console.log(props.user);  // { name: 'John', age: 25 }
props.api.getUserInfo().then(/* ... */);
```

## props æ›´æ–°

```typescript
// packages/wujie-core/src/sandbox.ts
public async active(options): Promise<void> {
  const { props } = options;
  
  // æ›´æ–° props
  this.provide.props = props ?? this.provide.props;
}
```

é‡æ–°æ¿€æ´»æ—¶å¯ä»¥ä¼ é€’æ–°çš„ propsï¼š

```typescript
// æ›´æ–° props
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  el: '#container',
  props: {
    user: { name: 'Jane', age: 30 },  // æ–°æ•°æ®
  },
});
```

## $wujie æ¥å£

```typescript
// packages/wujie-core/src/iframe.ts
function patchIframeVariable(iframeWindow: Window, wujie: WuJie, appHostPath: string): void {
  // å­åº”ç”¨æ¥å£
  iframeWindow.$wujie = wujie.provide;
}

// provide ç»“æ„
this.provide = {
  bus: this.bus,           // äº‹ä»¶æ€»çº¿
  shadowRoot: undefined,   // Shadow DOMï¼ˆæ¿€æ´»åè®¾ç½®ï¼‰
  props: undefined,        // ä¼ é€’çš„æ•°æ®
  location: this.proxyLocation,  // ä»£ç†çš„ location
};
```

## åµŒå¥—åœºæ™¯

å­åº”ç”¨åµŒå¥—æ—¶ï¼Œäº‹ä»¶å¯ä»¥è·¨å±‚ä¼ é€’ï¼š

```typescript
// packages/wujie-core/src/sandbox.ts
constructor(options) {
  // ä¼ é€’ inject ç»™åµŒå¥—å­åº”ç”¨
  if (window.__POWERED_BY_WUJIE__) {
    this.inject = window.__WUJIE.inject;
  } else {
    this.inject = {
      idToSandboxMap: idToSandboxCacheMap,
      appEventObjMap,  // å…±äº«äº‹ä»¶ Map
      mainHostPath: window.location.protocol + "//" + window.location.host,
    };
  }
}
```

äº‹ä»¶å­˜å‚¨å…±äº«ï¼š

```typescript
// packages/wujie-core/src/event.ts
export const appEventObjMap = (() => {
  // åµŒå¥—åœºæ™¯ï¼šä½¿ç”¨çˆ¶åº”ç”¨çš„ appEventObjMap
  if (window.__POWERED_BY_WUJIE__) {
    return window.__WUJIE.inject.appEventObjMap;
  }
  // ä¸»åº”ç”¨ï¼šåˆ›å»ºæ–°çš„ Map
  return new Map<String, EventObj>();
})();
```

## ä½¿ç”¨ç¤ºä¾‹

### ä¸»åº”ç”¨ â†’ å­åº”ç”¨

```typescript
// ä¸»åº”ç”¨
import { bus } from 'wujie';

// å‘é€äº‹ä»¶
bus.$emit('theme-change', { theme: 'dark' });

// å­åº”ç”¨
window.$wujie.bus.$on('theme-change', ({ theme }) => {
  document.body.className = theme;
});
```

### å­åº”ç”¨ â†’ ä¸»åº”ç”¨

```typescript
// å­åº”ç”¨
window.$wujie.bus.$emit('user-logout');

// ä¸»åº”ç”¨
import { bus } from 'wujie';

bus.$on('user-logout', () => {
  router.push('/login');
});
```

### å­åº”ç”¨ â†’ å­åº”ç”¨

```typescript
// å­åº”ç”¨ A
window.$wujie.bus.$emit('cart-update', { count: 5 });

// å­åº”ç”¨ B
window.$wujie.bus.$on('cart-update', ({ count }) => {
  updateCartBadge(count);
});
```

### ç›‘å¬æ‰€æœ‰äº‹ä»¶

```typescript
// ä¸»åº”ç”¨
import { bus } from 'wujie';

bus.$onAll((event, ...args) => {
  console.log(`[Event] ${event}:`, args);
});
```

## å°ç»“

æ— ç•Œçš„é€šä¿¡æœºåˆ¶ï¼š

| ç‰¹æ€§ | EventBus | props |
|-----|----------|-------|
| æ–¹å‘ | åŒå‘ | å•å‘ï¼ˆä¸» â†’ å­ï¼‰ |
| æ—¶æœº | ä»»æ„æ—¶åˆ» | å¯åŠ¨/æ¿€æ´»æ—¶ |
| ç±»å‹ | äº‹ä»¶ | æ•°æ®/å‡½æ•° |
| è§£è€¦ | é«˜ | ä½ |

æ ¸å¿ƒè®¾è®¡ï¼š
1. **å…¨å±€äº‹ä»¶ Map**ï¼šæ‰€æœ‰åº”ç”¨å…±äº«ï¼Œæ”¯æŒè·¨åº”ç”¨é€šä¿¡
2. **åº”ç”¨éš”ç¦»**ï¼šæ¯ä¸ªåº”ç”¨æœ‰ç‹¬ç«‹çš„ eventObj
3. **åµŒå¥—æ”¯æŒ**ï¼šé€šè¿‡ inject ä¼ é€’å…±äº« Map
4. **é“¾å¼è°ƒç”¨**ï¼š$on/$off/$emit è¿”å› this

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†ææ’ä»¶ç³»ç»Ÿã€‚

---

> ğŸ“¦ æºç ç‰ˆæœ¬ï¼šwujie v1.0.22
>
> ä¸Šä¸€ç¯‡ï¼š[è·¯ç”±åŒæ­¥](https://juejin.cn/post/7588704463621505043)
>
> ä¸‹ä¸€ç¯‡ï¼š[æ’ä»¶ç³»ç»Ÿ](https://juejin.cn/post/7588704463621521427)
