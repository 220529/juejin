# æ— ç•Œå¾®å‰ç«¯æºç è§£æï¼šæ’ä»¶ç³»ç»Ÿ

> æ·±å…¥åˆ†æ loader å’Œ hook æœºåˆ¶ï¼Œç†è§£å¦‚ä½•æ‰©å±•æ— ç•Œçš„èƒ½åŠ›ã€‚

## æ’ä»¶ç±»å‹

```typescript
// packages/wujie-core/src/index.ts
export interface plugin {
  // HTML å¤„ç†
  htmlLoader?: (code: string) => string;
  
  // JS å¤„ç†
  jsExcludes?: Array<string | RegExp>;      // æ’é™¤åˆ—è¡¨
  jsIgnores?: Array<string | RegExp>;       // å¿½ç•¥åˆ—è¡¨
  jsBeforeLoaders?: Array<ScriptObjectLoader>;  // å‰ç½®è„šæœ¬
  jsLoader?: (code: string, url: string, base: string) => string;  // ä»£ç å¤„ç†
  jsAfterLoaders?: Array<ScriptObjectLoader>;   // åç½®è„šæœ¬
  
  // CSS å¤„ç†
  cssExcludes?: Array<string | RegExp>;     // æ’é™¤åˆ—è¡¨
  cssIgnores?: Array<string | RegExp>;      // å¿½ç•¥åˆ—è¡¨
  cssBeforeLoaders?: Array<StyleObject>;    // å‰ç½®æ ·å¼
  cssLoader?: (code: string, url: string, base: string) => string;  // ä»£ç å¤„ç†
  cssAfterLoaders?: Array<StyleObject>;     // åç½®æ ·å¼
  
  // äº‹ä»¶é’©å­
  windowAddEventListenerHook?: eventListenerHook;
  windowRemoveEventListenerHook?: eventListenerHook;
  documentAddEventListenerHook?: eventListenerHook;
  documentRemoveEventListenerHook?: eventListenerHook;
  
  // DOM é’©å­
  appendOrInsertElementHook?: <T extends Node>(element: T, iframeWindow: Window) => void;
  patchElementHook?: <T extends Node>(element: T, iframeWindow: Window) => void;
  
  // å±æ€§è¦†ç›–
  windowPropertyOverride?: (iframeWindow: Window) => void;
  documentPropertyOverride?: (iframeWindow: Window) => void;
}
```

## é»˜è®¤æ’ä»¶

```typescript
// packages/wujie-core/src/plugin.ts
function cssRelativePathResolve(code: string, src: string, base: string) {
  const baseUrl = src ? getAbsolutePath(src, base) : base;
  const urlReg = /url\((['"]?)((?:[^()]+|\((?:[^()]+|\([^()]*\))*\))*)(\1)\)/g;

  return code.replace(urlReg, (_m, pre, url, post) => {
    // è·³è¿‡ base64
    if (/^data:/.test(url)) return _m;
    // è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    return `url(${pre}${getAbsolutePath(url, baseUrl)}${post})`;
  });
}

const defaultPlugin = {
  cssLoader: cssRelativePathResolve,
  // ä¿®å¤ view-transition é—®é¢˜
  cssBeforeLoaders: [{ content: "html {view-transition-name: none;}" }],
};

export function getPlugins(plugins: Array<plugin>): Array<plugin> {
  return Array.isArray(plugins) ? [defaultPlugin, ...plugins] : [defaultPlugin];
}
```

## CSS Loader

```typescript
// packages/wujie-core/src/plugin.ts
export function getCssLoader({ plugins, replace }: loaderOption) {
  return (code: string, src: string = "", base: string): string =>
    compose(plugins.map((plugin) => plugin.cssLoader))(
      replace ? replace(code) : code, 
      src, 
      base
    );
}
```

ä½¿ç”¨ compose ç»„åˆå¤šä¸ª loaderï¼š

```typescript
// packages/wujie-core/src/utils.ts
export function compose(fnList: Array<Function>) {
  return function (...args) {
    return fnList.filter(Boolean).reduce((result, fn) => {
      return fn(result, ...args.slice(1));
    }, args[0]);
  };
}
```

## JS Loader

```typescript
// packages/wujie-core/src/plugin.ts
export function getJsLoader({ plugins, replace }: loaderOption) {
  return (code: string, src: string = "", base: string): string =>
    compose(plugins.map((plugin) => plugin.jsLoader))(
      replace ? replace(code) : code, 
      src, 
      base
    );
}
```

## é¢„ç½® Loader

```typescript
// packages/wujie-core/src/plugin.ts
type presetLoadersType = "cssBeforeLoaders" | "cssAfterLoaders" | "jsBeforeLoaders" | "jsAfterLoaders";

export function getPresetLoaders(loaderType: presetLoadersType, plugins: Array<plugin>): plugin[presetLoadersType] {
  const loaders = plugins
    .map((plugin) => plugin[loaderType])
    .filter((loaders) => loaders?.length);
  
  const res = loaders.reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);
  
  // cssBeforeLoaders éœ€è¦åè½¬é¡ºåº
  return loaderType === "cssBeforeLoaders" ? res.reverse() : res;
}
```

## æ’é™¤/å¿½ç•¥åˆ—è¡¨

```typescript
// packages/wujie-core/src/plugin.ts
type effectLoadersType = "jsExcludes" | "cssExcludes" | "jsIgnores" | "cssIgnores";

export function getEffectLoaders(loaderType: effectLoadersType, plugins: Array<plugin>): plugin[effectLoadersType] {
  return plugins
    .map((plugin) => plugin[loaderType])
    .filter((loaders) => loaders?.length)
    .reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);
}

// åˆ¤æ–­ URL æ˜¯å¦åŒ¹é…
export function isMatchUrl(url: string, effectLoaders: plugin[effectLoadersType]): boolean {
  return effectLoaders.some((loader) => 
    typeof loader === "string" ? url === loader : loader.test(url)
  );
}
```

## é’©å­æ‰§è¡Œ

```typescript
// packages/wujie-core/src/utils.ts
export function execHooks(plugins: Array<plugin>, hookName: string, ...args: any[]): void {
  plugins.forEach((plugin) => {
    const hook = plugin[hookName];
    if (typeof hook === "function") {
      hook(...args);
    }
  });
}
```

ä½¿ç”¨ç¤ºä¾‹ï¼š

```typescript
// packages/wujie-core/src/iframe.ts
// äº‹ä»¶ç›‘å¬é’©å­
execHooks(iframeWindow.__WUJIE.plugins, "windowAddEventListenerHook", iframeWindow, type, listener, options);

// å…ƒç´  patch é’©å­
execHooks(iframeWindow.__WUJIE.plugins, "patchElementHook", element, iframeWindow);

// å±æ€§è¦†ç›–é’©å­
execHooks(iframeWindow.__WUJIE.plugins, "windowPropertyOverride", iframeWindow);
```

## æ’ä»¶ä½¿ç”¨ç¤ºä¾‹

### 1. ä¿®æ”¹ JS ä»£ç 

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    jsLoader: (code, url, base) => {
      // æ›¿æ¢ API åœ°å€
      return code.replace(
        /https:\/\/api\.example\.com/g,
        'https://api.proxy.com'
      );
    },
  }],
});
```

### 2. æ³¨å…¥å‰ç½®è„šæœ¬

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    jsBeforeLoaders: [
      {
        content: `
          window.ENV = 'production';
          window.API_BASE = 'https://api.example.com';
        `,
      },
    ],
  }],
});
```

### 3. æ’é™¤ç‰¹å®šè„šæœ¬

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    // æ’é™¤ï¼ˆä¸åŠ è½½ï¼‰
    jsExcludes: [
      'https://cdn.example.com/analytics.js',
      /google-analytics/,
    ],
    // å¿½ç•¥ï¼ˆåŠ è½½ä½†ä¸æ‰§è¡Œï¼‰
    jsIgnores: [
      'https://cdn.example.com/ad.js',
    ],
  }],
});
```

### 4. æ³¨å…¥æ ·å¼

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    cssBeforeLoaders: [
      {
        content: `
          :root {
            --primary-color: #1890ff;
          }
        `,
      },
    ],
    cssAfterLoaders: [
      {
        content: `
          .custom-override {
            display: none !important;
          }
        `,
      },
    ],
  }],
});
```

### 5. è¦†ç›– window å±æ€§

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    windowPropertyOverride: (iframeWindow) => {
      // è¦†ç›– localStorage
      iframeWindow.localStorage = {
        getItem: (key) => window.localStorage.getItem(`vue3_${key}`),
        setItem: (key, value) => window.localStorage.setItem(`vue3_${key}`, value),
        removeItem: (key) => window.localStorage.removeItem(`vue3_${key}`),
        clear: () => { /* åªæ¸…ç†å½“å‰åº”ç”¨çš„æ•°æ® */ },
      };
    },
  }],
});
```

### 6. ç›‘å¬äº‹ä»¶

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    windowAddEventListenerHook: (iframeWindow, type, handler, options) => {
      console.log(`[${iframeWindow.__WUJIE.id}] addEventListener: ${type}`);
    },
    documentAddEventListenerHook: (iframeWindow, type, handler, options) => {
      // é˜»æ­¢æŸäº›äº‹ä»¶
      if (type === 'contextmenu') {
        return false;
      }
    },
  }],
});
```

### 7. å¤„ç† DOM æ’å…¥

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    appendOrInsertElementHook: (element, iframeWindow) => {
      // å¤„ç†åŠ¨æ€æ’å…¥çš„ script
      if (element.tagName === 'SCRIPT') {
        console.log('Script inserted:', element.src);
      }
      // å¤„ç†åŠ¨æ€æ’å…¥çš„ style
      if (element.tagName === 'STYLE') {
        console.log('Style inserted');
      }
    },
  }],
});
```

### 8. å…ƒç´  patch

```typescript
startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [{
    patchElementHook: (element, iframeWindow) => {
      // ä¿®æ”¹å›¾ç‰‡è·¯å¾„
      if (element.tagName === 'IMG') {
        const src = element.getAttribute('src');
        if (src && src.startsWith('/')) {
          element.setAttribute('src', 'https://cdn.example.com' + src);
        }
      }
    },
  }],
});
```

## å¤šæ’ä»¶ç»„åˆ

```typescript
const analyticsPlugin = {
  jsExcludes: [/google-analytics/, /baidu-analytics/],
};

const stylePlugin = {
  cssBeforeLoaders: [{ content: ':root { --theme: dark; }' }],
};

const securityPlugin = {
  windowPropertyOverride: (iframeWindow) => {
    // ç¦ç”¨ eval
    iframeWindow.eval = () => {
      throw new Error('eval is disabled');
    };
  },
};

startApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  plugins: [analyticsPlugin, stylePlugin, securityPlugin],
});
```

## å°ç»“

æ— ç•Œçš„æ’ä»¶ç³»ç»Ÿï¼š

| ç±»å‹ | ä½œç”¨ | æ—¶æœº |
|-----|------|------|
| Loader | å¤„ç†ä»£ç  | åŠ è½½æ—¶ |
| Excludes | æ’é™¤èµ„æº | åŠ è½½å‰ |
| Ignores | å¿½ç•¥æ‰§è¡Œ | æ‰§è¡Œå‰ |
| Hook | æ‹¦æˆªæ“ä½œ | è¿è¡Œæ—¶ |
| Override | è¦†ç›–å±æ€§ | åˆå§‹åŒ–æ—¶ |

æ ¸å¿ƒè®¾è®¡ï¼š
1. **ç»„åˆæ¨¡å¼**ï¼šå¤šä¸ª loader é€šè¿‡ compose ç»„åˆ
2. **é’©å­æœºåˆ¶**ï¼šå…³é”®æ“ä½œæä¾›é’©å­æ‰©å±•
3. **é»˜è®¤æ’ä»¶**ï¼šå†…ç½® CSS è·¯å¾„å¤„ç†
4. **çµæ´»é…ç½®**ï¼šæ”¯æŒå­—ç¬¦ä¸²å’Œæ­£åˆ™åŒ¹é…

---

> ğŸ“¦ æºç ç‰ˆæœ¬ï¼šwujie v1.0.22
>
> ä¸Šä¸€ç¯‡ï¼š[é€šä¿¡æœºåˆ¶](https://juejin.cn/post/7588827110506102827)
>
> ç³»åˆ—å®Œç»“
