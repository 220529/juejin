# æ— ç•Œå¾®å‰ç«¯æºç è§£æžï¼šé¡¹ç›®ä»‹ç»ä¸ŽçŽ¯å¢ƒæ­å»º

> æ— ç•Œæ˜¯è…¾è®¯å¼€æºçš„å¾®å‰ç«¯æ¡†æž¶ï¼ŒåŸºäºŽ Web Components + iframe å®žçŽ°åŽŸç”Ÿéš”ç¦»ã€‚æœ¬ç³»åˆ—å°†æ·±å…¥æºç ï¼Œæ­ç§˜å…¶è®¾è®¡æ€æƒ³ã€‚

## æ— ç•Œæ˜¯ä»€ä¹ˆ

æ— ç•Œï¼ˆwujieï¼‰æ˜¯ä¸€æ¬¾åŸºäºŽ Web Components + iframe çš„å¾®å‰ç«¯æ¡†æž¶ï¼Œå…·å¤‡ï¼š

- **æˆæœ¬ä½Ž**ï¼šä¸»åº”ç”¨å’Œå­åº”ç”¨é€‚é…æˆæœ¬ä½Ž
- **é€Ÿåº¦å¿«**ï¼šå­åº”ç”¨é¦–å±å’Œè¿è¡Œé€Ÿåº¦å¿«
- **åŽŸç”Ÿéš”ç¦»**ï¼šCSS é€šè¿‡ Shadow DOM éš”ç¦»ï¼ŒJS é€šè¿‡ iframe éš”ç¦»
- **åŠŸèƒ½å¼ºå¤§**ï¼šæ”¯æŒä¿æ´»ã€åµŒå¥—ã€å¤šåº”ç”¨æ¿€æ´»ã€vite ç­‰

## ä¸ºä»€ä¹ˆé€‰æ‹© iframe + Web Components

### ä¼ ç»Ÿæ–¹æ¡ˆçš„é—®é¢˜

| æ–¹æ¡ˆ | CSS éš”ç¦» | JS éš”ç¦» | é—®é¢˜ |
|-----|---------|--------|------|
| qiankun | åŠ¨æ€æ ·å¼ | Proxy æ²™ç®± | æ ·å¼æ³„æ¼ã€æ²™ç®±é€ƒé€¸ |
| micro-app | Shadow DOM | Proxy æ²™ç®± | æ²™ç®±ä¸å®Œæ•´ |
| iframe | åŽŸç”Ÿéš”ç¦» | åŽŸç”Ÿéš”ç¦» | è·¯ç”±åŒæ­¥ã€é€šä¿¡å›°éš¾ |

### æ— ç•Œçš„æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸»åº”ç”¨                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Web Component (wujie-app)       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚         Shadow DOM (CSS éš”ç¦»)       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    å­åº”ç”¨ HTML/CSS æ¸²æŸ“åœ¨è¿™é‡Œ        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         éšè—çš„ iframe (JS éš”ç¦»)           â”‚  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚    å­åº”ç”¨ JS è¿è¡Œåœ¨è¿™é‡Œ                    â”‚  â”‚
â”‚  â”‚    æ‹¥æœ‰ç‹¬ç«‹çš„ windowã€documentã€location   â”‚  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ ¸å¿ƒæ€è·¯ï¼š
- **CSS éš”ç¦»**ï¼šå­åº”ç”¨ DOM æ¸²æŸ“åœ¨ Shadow DOM ä¸­
- **JS éš”ç¦»**ï¼šå­åº”ç”¨ JS è¿è¡Œåœ¨ iframe ä¸­
- **DOM ä»£ç†**ï¼šiframe ä¸­çš„ document æ“ä½œä»£ç†åˆ° Shadow DOM

## æºç ä»“åº“

```bash
git clone https://github.com/Tencent/wujie.git
cd wujie
pnpm install
npm run start
```

## é¡¹ç›®ç»“æž„

```
wujie/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ wujie-core/       # æ ¸å¿ƒåŒ…
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ index.ts      # å…¥å£ï¼ŒstartAppã€preloadApp
â”‚   â”‚       â”œâ”€â”€ sandbox.ts    # æ²™ç®±ç±» WuJie
â”‚   â”‚       â”œâ”€â”€ iframe.ts     # iframe åˆ›å»ºå’Œ patch
â”‚   â”‚       â”œâ”€â”€ shadow.ts     # Shadow DOM å¤„ç†
â”‚   â”‚       â”œâ”€â”€ proxy.ts      # window/document/location ä»£ç†
â”‚   â”‚       â”œâ”€â”€ entry.ts      # HTML è§£æžå’Œèµ„æºåŠ è½½
â”‚   â”‚       â”œâ”€â”€ sync.ts       # è·¯ç”±åŒæ­¥
â”‚   â”‚       â”œâ”€â”€ plugin.ts     # æ’ä»¶ç³»ç»Ÿ
â”‚   â”‚       â””â”€â”€ event.ts      # äº‹ä»¶æ€»çº¿
â”‚   â”‚
â”‚   â”œâ”€â”€ wujie-vue2/       # Vue2 ç»„ä»¶
â”‚   â”œâ”€â”€ wujie-vue3/       # Vue3 ç»„ä»¶
â”‚   â””â”€â”€ wujie-react/      # React ç»„ä»¶
â”‚
â”œâ”€â”€ examples/             # ç¤ºä¾‹é¡¹ç›®
â”‚   â”œâ”€â”€ main-vue/         # Vue ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ main-react/       # React ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ vue2/             # Vue2 å­åº”ç”¨
â”‚   â”œâ”€â”€ vue3/             # Vue3 å­åº”ç”¨
â”‚   â””â”€â”€ react17/          # React å­åº”ç”¨
â”‚
â””â”€â”€ docs/                 # æ–‡æ¡£
```

## æ ¸å¿ƒ API

### startApp

å¯åŠ¨å­åº”ç”¨ï¼š

```typescript
import { startApp } from 'wujie';

startApp({
  name: 'vue3',                    // å”¯ä¸€æ ‡è¯†
  url: 'http://localhost:7300/',   // å­åº”ç”¨åœ°å€
  el: '#container',                // æŒ‚è½½å®¹å™¨
  sync: true,                      // è·¯ç”±åŒæ­¥
  alive: true,                     // ä¿æ´»æ¨¡å¼
  props: { data: 'hello' },        // ä¼ é€’ç»™å­åº”ç”¨çš„æ•°æ®
  
  // ç”Ÿå‘½å‘¨æœŸ
  beforeLoad: (appWindow) => {},
  beforeMount: (appWindow) => {},
  afterMount: (appWindow) => {},
  beforeUnmount: (appWindow) => {},
  afterUnmount: (appWindow) => {},
});
```

### preloadApp

é¢„åŠ è½½å­åº”ç”¨ï¼š

```typescript
import { preloadApp } from 'wujie';

preloadApp({
  name: 'vue3',
  url: 'http://localhost:7300/',
  exec: true,  // æ˜¯å¦é¢„æ‰§è¡Œ
});
```

### bus

äº‹ä»¶æ€»çº¿ï¼š

```typescript
import { bus } from 'wujie';

// ä¸»åº”ç”¨
bus.$on('event', (data) => console.log(data));

// å­åº”ç”¨
window.$wujie.bus.$emit('event', { msg: 'hello' });
```

## å­åº”ç”¨æ”¹é€ 

å­åº”ç”¨å‡ ä¹Žä¸éœ€è¦æ”¹é€ ï¼Œåªéœ€å¯¼å‡ºç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼š

```typescript
// main.ts
if (window.__POWERED_BY_WUJIE__) {
  let instance;
  
  window.__WUJIE_MOUNT = () => {
    instance = createApp(App).mount('#app');
  };
  
  window.__WUJIE_UNMOUNT = () => {
    instance.unmount();
  };
} else {
  createApp(App).mount('#app');
}
```

## ç³»åˆ—æ–‡ç« 

æœ¬ç³»åˆ—å°†æ·±å…¥åˆ†æžæ— ç•Œæºç ï¼š

1. **é¡¹ç›®ä»‹ç»**ï¼ˆæœ¬æ–‡ï¼‰- äº†è§£é¡¹ç›®ç»“æž„å’Œæ ¸å¿ƒæ¦‚å¿µ
2. **æž¶æž„æ€»è§ˆ** - startApp å¯åŠ¨æµç¨‹
3. **æ²™ç®±æœºåˆ¶** - iframe æ²™ç®±çš„åˆ›å»ºå’Œ patch
4. **CSS éš”ç¦»** - Shadow DOM å’Œæ ·å¼å¤„ç†
5. **JS éš”ç¦»** - Proxy ä»£ç†å’Œä½œç”¨åŸŸéš”ç¦»
6. **è·¯ç”±åŒæ­¥** - ä¸»å­åº”ç”¨è·¯ç”±åŒæ­¥æœºåˆ¶
7. **é€šä¿¡æœºåˆ¶** - EventBus å’Œ props ä¼ é€’
8. **æ’ä»¶ç³»ç»Ÿ** - loader å’Œ hook æœºåˆ¶

## è°ƒè¯•æŠ€å·§

### 1. å¯åŠ¨ç¤ºä¾‹é¡¹ç›®

```bash
npm run start
```

ä¼šåŒæ—¶å¯åŠ¨ä¸»åº”ç”¨å’Œå¤šä¸ªå­åº”ç”¨ã€‚

### 2. å…³é”®æ–­ç‚¹ä½ç½®

| åœºæ™¯ | æ–‡ä»¶ | å‡½æ•° |
|-----|------|------|
| å¯åŠ¨åº”ç”¨ | `index.ts` | `startApp` |
| åˆ›å»ºæ²™ç®± | `sandbox.ts` | `constructor` |
| åˆ›å»º iframe | `iframe.ts` | `iframeGenerator` |
| ä»£ç† window | `proxy.ts` | `proxyGenerator` |
| æ¸²æŸ“ DOM | `shadow.ts` | `renderTemplateToShadowRoot` |

## ä¸‹ä¸€æ­¥

çŽ¯å¢ƒå‡†å¤‡å¥½äº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†æž startApp çš„å®Œæ•´æµç¨‹ã€‚

---

> ðŸ“¦ æºç åœ°å€ï¼š[github.com/Tencent/wujie](https://github.com/Tencent/wujie)
>
> ä¸‹ä¸€ç¯‡ï¼šæ— ç•Œæž¶æž„æ€»è§ˆ
