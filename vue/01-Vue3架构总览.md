# Vue.js æºç æ­ç§˜ï¼ˆä¸€ï¼‰ï¼šVue3 æ¶æ„æ€»è§ˆ

> æœ¬æ–‡ä»å…¨å±€è§†è§’è§£æ Vue3 çš„æ ¸å¿ƒæ¶æ„ï¼Œå»ºç«‹æºç é˜…è¯»çš„æ•´ä½“è®¤çŸ¥ã€‚

## ä¸€ã€æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Vue Application                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Compiler (ç¼–è¯‘æ—¶)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Parse     â”‚â”€â–ºâ”‚  Transform  â”‚â”€â–ºâ”‚   Codegen   â”‚         â”‚
â”‚  â”‚  (è§£æ)     â”‚  â”‚   (è½¬æ¢)    â”‚  â”‚  (ä»£ç ç”Ÿæˆ)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ render function
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Runtime (è¿è¡Œæ—¶)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Reactivity  â”‚  â”‚   Renderer  â”‚  â”‚  Scheduler  â”‚         â”‚
â”‚  â”‚  (å“åº”å¼)   â”‚  â”‚   (æ¸²æŸ“å™¨)   â”‚  â”‚   (è°ƒåº¦å™¨)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DOM / Platform                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€ç¼–è¯‘æ—¶ vs è¿è¡Œæ—¶

### 2.1 ç¼–è¯‘æ—¶ï¼ˆCompile Timeï¼‰

```typescript
// æ¨¡æ¿
<template>
  <div>{{ msg }}</div>
</template>

// ç¼–è¯‘åçš„ render å‡½æ•°
function render(_ctx) {
  return _createElementVNode("div", null, _toDisplayString(_ctx.msg))
}
```

### 2.2 è¿è¡Œæ—¶ï¼ˆRuntimeï¼‰

```typescript
// è¿è¡Œæ—¶æ‰§è¡Œ render å‡½æ•°
const vnode = render(ctx)

// patch åˆ° DOM
patch(null, vnode, container)
```

## ä¸‰ã€å“åº”å¼ç³»ç»Ÿ

### 3.1 æ ¸å¿ƒ API

```typescript
// reactive - å¯¹è±¡å“åº”å¼
const state = reactive({ count: 0 })

// ref - åŸºæœ¬ç±»å‹å“åº”å¼
const count = ref(0)

// computed - è®¡ç®—å±æ€§
const double = computed(() => count.value * 2)

// effect - å‰¯ä½œç”¨
effect(() => {
  console.log(count.value)
})
```

### 3.2 ä¾èµ–æ”¶é›†ä¸è§¦å‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å“åº”å¼æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    get     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â”‚  Proxy  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  track  â”‚ â”€â”€â–º æ”¶é›†å½“å‰ effect    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”‚ set                                                â”‚
â”‚        â–¼                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â”‚ trigger â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ effects â”‚ â”€â”€â–º æ‰§è¡Œæ‰€æœ‰ effect    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Dep ä¸ Effect

```typescript
// Dep - ä¾èµ–å®¹å™¨
class Dep {
  subs: Set<Subscriber>  // è®¢é˜…è€…é›†åˆ
  
  track() {
    if (activeSub) {
      this.subs.add(activeSub)
    }
  }
  
  trigger() {
    this.subs.forEach(sub => sub.notify())
  }
}

// ReactiveEffect - å‰¯ä½œç”¨
class ReactiveEffect {
  deps: Link[]  // ä¾èµ–é“¾è¡¨
  
  run() {
    activeSub = this
    return this.fn()
  }
  
  notify() {
    this.scheduler ? this.scheduler() : this.run()
  }
}
```

## å››ã€è™šæ‹Ÿ DOM

### 4.1 VNode ç»“æ„

```typescript
interface VNode {
  type: string | Component    // èŠ‚ç‚¹ç±»å‹
  props: object | null        // å±æ€§
  children: VNode[] | string  // å­èŠ‚ç‚¹
  el: Element | null          // çœŸå® DOM
  key: string | number        // diff key
  shapeFlag: number           // èŠ‚ç‚¹ç±»å‹æ ‡è®°
  patchFlag: number           // ä¼˜åŒ–æ ‡è®°
}
```

### 4.2 ShapeFlags

```typescript
enum ShapeFlags {
  ELEMENT = 1,                    // æ™®é€šå…ƒç´ 
  FUNCTIONAL_COMPONENT = 1 << 1,  // å‡½æ•°ç»„ä»¶
  STATEFUL_COMPONENT = 1 << 2,    // æœ‰çŠ¶æ€ç»„ä»¶
  TEXT_CHILDREN = 1 << 3,         // æ–‡æœ¬å­èŠ‚ç‚¹
  ARRAY_CHILDREN = 1 << 4,        // æ•°ç»„å­èŠ‚ç‚¹
  SLOTS_CHILDREN = 1 << 5,        // æ’æ§½å­èŠ‚ç‚¹
  TELEPORT = 1 << 6,              // Teleport
  SUSPENSE = 1 << 7,              // Suspense
  COMPONENT = STATEFUL_COMPONENT | FUNCTIONAL_COMPONENT
}
```

## äº”ã€æ¸²æŸ“å™¨

### 5.1 patch å‡½æ•°

```typescript
const patch = (n1, n2, container) => {
  if (n1 === n2) return
  
  // ç±»å‹ä¸åŒï¼Œå¸è½½æ—§èŠ‚ç‚¹
  if (n1 && !isSameVNodeType(n1, n2)) {
    unmount(n1)
    n1 = null
  }
  
  const { type, shapeFlag } = n2
  
  switch (type) {
    case Text:
      processText(n1, n2, container)
      break
    case Fragment:
      processFragment(n1, n2, container)
      break
    default:
      if (shapeFlag & ShapeFlags.ELEMENT) {
        processElement(n1, n2, container)
      } else if (shapeFlag & ShapeFlags.COMPONENT) {
        processComponent(n1, n2, container)
      }
  }
}
```

### 5.2 ç»„ä»¶æŒ‚è½½

```typescript
const mountComponent = (vnode, container) => {
  // 1. åˆ›å»ºç»„ä»¶å®ä¾‹
  const instance = createComponentInstance(vnode)
  
  // 2. è®¾ç½®ç»„ä»¶ï¼ˆæ‰§è¡Œ setupï¼‰
  setupComponent(instance)
  
  // 3. è®¾ç½®æ¸²æŸ“å‰¯ä½œç”¨
  setupRenderEffect(instance, vnode, container)
}

const setupRenderEffect = (instance, vnode, container) => {
  const effect = new ReactiveEffect(() => {
    if (!instance.isMounted) {
      // é¦–æ¬¡æŒ‚è½½
      const subTree = instance.render()
      patch(null, subTree, container)
      instance.subTree = subTree
      instance.isMounted = true
    } else {
      // æ›´æ–°
      const nextTree = instance.render()
      patch(instance.subTree, nextTree, container)
      instance.subTree = nextTree
    }
  })
  
  effect.run()
}
```

## å…­ã€è°ƒåº¦å™¨

### 6.1 ä»»åŠ¡é˜Ÿåˆ—

```typescript
const queue: SchedulerJob[] = []
let isFlushing = false

function queueJob(job) {
  if (!queue.includes(job)) {
    queue.push(job)
    queueFlush()
  }
}

function queueFlush() {
  if (!isFlushing) {
    isFlushing = true
    Promise.resolve().then(flushJobs)
  }
}

function flushJobs() {
  queue.sort((a, b) => getId(a) - getId(b))
  
  for (const job of queue) {
    job()
  }
  
  queue.length = 0
  isFlushing = false
}
```

### 6.2 nextTick

```typescript
const resolvedPromise = Promise.resolve()

function nextTick(fn?) {
  return fn 
    ? resolvedPromise.then(fn) 
    : resolvedPromise
}
```

## ä¸ƒã€ç»„ä»¶ç³»ç»Ÿ

### 7.1 ç»„ä»¶å®ä¾‹

```typescript
interface ComponentInternalInstance {
  uid: number                    // å”¯ä¸€ ID
  type: Component                // ç»„ä»¶å®šä¹‰
  parent: ComponentInternalInstance | null
  
  // çŠ¶æ€
  data: object                   // data()
  props: object                  // props
  setupState: object             // setup() è¿”å›å€¼
  ctx: object                    // æ¸²æŸ“ä¸Šä¸‹æ–‡
  
  // æ¸²æŸ“
  render: Function               // render å‡½æ•°
  subTree: VNode                 // æ¸²æŸ“çš„ VNode æ ‘
  effect: ReactiveEffect         // æ¸²æŸ“å‰¯ä½œç”¨
  
  // ç”Ÿå‘½å‘¨æœŸ
  isMounted: boolean
  isUnmounted: boolean
  
  // ç”Ÿå‘½å‘¨æœŸé’©å­
  bc: Function[] | null          // beforeCreate
  c: Function[] | null           // created
  bm: Function[] | null          // beforeMount
  m: Function[] | null           // mounted
  bu: Function[] | null          // beforeUpdate
  u: Function[] | null           // updated
  bum: Function[] | null         // beforeUnmount
  um: Function[] | null          // unmounted
}
```

### 7.2 setup æ‰§è¡Œ

```typescript
function setupComponent(instance) {
  const { props, children } = instance.vnode
  
  // åˆå§‹åŒ– props
  initProps(instance, props)
  
  // åˆå§‹åŒ– slots
  initSlots(instance, children)
  
  // æ‰§è¡Œ setup
  const { setup } = instance.type
  if (setup) {
    const setupResult = setup(instance.props, {
      attrs: instance.attrs,
      slots: instance.slots,
      emit: instance.emit,
      expose: instance.expose
    })
    
    handleSetupResult(instance, setupResult)
  }
}
```

## å…«ã€ç¼–è¯‘ä¼˜åŒ–

### 8.1 PatchFlags

```typescript
enum PatchFlags {
  TEXT = 1,              // åŠ¨æ€æ–‡æœ¬
  CLASS = 1 << 1,        // åŠ¨æ€ class
  STYLE = 1 << 2,        // åŠ¨æ€ style
  PROPS = 1 << 3,        // åŠ¨æ€ props
  FULL_PROPS = 1 << 4,   // æœ‰åŠ¨æ€ key
  NEED_HYDRATION = 1 << 5,
  STABLE_FRAGMENT = 1 << 6,
  KEYED_FRAGMENT = 1 << 7,
  UNKEYED_FRAGMENT = 1 << 8,
  NEED_PATCH = 1 << 9,
  DYNAMIC_SLOTS = 1 << 10,
  HOISTED = -1,          // é™æ€æå‡
  BAIL = -2              // é€€å‡ºä¼˜åŒ–
}
```

### 8.2 Block Tree

```typescript
// ç¼–è¯‘ä¼˜åŒ–ï¼šåªè¿½è¸ªåŠ¨æ€èŠ‚ç‚¹
const _hoisted_1 = createVNode("div", null, "static")

function render() {
  return (openBlock(), createBlock("div", null, [
    _hoisted_1,  // é™æ€æå‡
    createVNode("span", null, ctx.msg, PatchFlags.TEXT)  // åŠ¨æ€èŠ‚ç‚¹
  ]))
}
```

## ä¹ã€å®Œæ•´æ¸²æŸ“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vue æ¸²æŸ“æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. createApp(App).mount('#app')                            â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  2. åˆ›å»º VNode                                              â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  3. render(vnode, container)                                â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  4. patch(null, vnode, container)                           â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  5. processComponent â†’ mountComponent                       â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”œâ”€â”€ createComponentInstance                          â”‚
â”‚        â”œâ”€â”€ setupComponent (æ‰§è¡Œ setup)                      â”‚
â”‚        â””â”€â”€ setupRenderEffect                                â”‚
â”‚              â”‚                                              â”‚
â”‚              â–¼                                              â”‚
â”‚  6. ReactiveEffect.run()                                    â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  7. instance.render() â†’ subTree VNode                       â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  8. patch(null, subTree, container)                         â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  9. é€’å½’å¤„ç†å­èŠ‚ç‚¹ â†’ æŒ‚è½½åˆ° DOM                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åã€å°ç»“

Vue3 æ¶æ„çš„æ ¸å¿ƒï¼š

1. **å“åº”å¼ç³»ç»Ÿ**ï¼šåŸºäº Proxyï¼Œä¾èµ–æ”¶é›† + è§¦å‘æ›´æ–°
2. **è™šæ‹Ÿ DOM**ï¼šVNode æè¿° UIï¼Œpatch ç®—æ³•é«˜æ•ˆæ›´æ–°
3. **ç¼–è¯‘ä¼˜åŒ–**ï¼šPatchFlagsã€Block Treeã€é™æ€æå‡
4. **è°ƒåº¦å™¨**ï¼šæ‰¹é‡æ›´æ–°ï¼ŒnextTick å¾®ä»»åŠ¡é˜Ÿåˆ—
5. **ç»„ä»¶ç³»ç»Ÿ**ï¼šsetup + Composition API

---

> ğŸ“¦ æºç åœ°å€ï¼š[github.com/vuejs/core](https://github.com/vuejs/core)
> 
> ä¸‹ä¸€ç¯‡ï¼šå“åº”å¼ç³»ç»Ÿè¯¦è§£
> 
> å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è— ğŸ‘
