# Monorepo å®æˆ˜ï¼šä»åŸç†åˆ°å·¥å…·é“¾å…¨è§£æ

> ä¸ºä»€ä¹ˆ Vueã€Reactã€Vite éƒ½ç”¨ Monorepoï¼Ÿæœ¬æ–‡å‰–ææ ¸å¿ƒä»·å€¼ï¼Œå¯¹æ¯” npm/yarn/pnpm workspaceï¼Œè¯¦è§£ Turborepo ä¸ Changesetsï¼Œæ‰‹æŠŠæ‰‹å¸¦ä½ æ­å»ºä¼ä¸šçº§ Monorepoã€‚

## ä¸€ã€ä»€ä¹ˆæ˜¯ Monorepoï¼Ÿ

### 1.1 ä¸‰ç§ä»£ç ç®¡ç†ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä»£ç ä»“åº“ç®¡ç†ç­–ç•¥                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Monolithï¼ˆå•ä½“åº”ç”¨ï¼‰                                           â”‚
â”‚   ä¸€ä¸ªä»“åº“ï¼Œä¸€ä¸ªé¡¹ç›®ï¼Œä¸€ä¸ªéƒ¨ç½²å•å…ƒ                               â”‚
â”‚   é€‚åˆï¼šå°å‹é¡¹ç›®ã€åˆåˆ›å›¢é˜Ÿ                                       â”‚
â”‚                                                                  â”‚
â”‚   Multi-repoï¼ˆå¤šä»“åº“ï¼‰                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  app   â”‚  â”‚   ui   â”‚  â”‚ utils  â”‚  â”‚ config â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚   é€‚åˆï¼šç‹¬ç«‹å›¢é˜Ÿã€ç‹¬ç«‹å‘å¸ƒå‘¨æœŸ                                   â”‚
â”‚                                                                  â”‚
â”‚   Monorepoï¼ˆå•ä»“å¤šåŒ…ï¼‰                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”‚                   â”‚
â”‚   â”‚  â”‚ app  â”‚  â”‚  ui  â”‚  â”‚utils â”‚  â”‚configâ”‚ â”‚                   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚   é€‚åˆï¼šå…³è”ç´§å¯†çš„å¤šåŒ…ã€ç»Ÿä¸€æŠ€æœ¯æ ˆ                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è°åœ¨ç”¨ Monorepoï¼Ÿ

| é¡¹ç›® | åŒ…ç®¡ç†å™¨ | ä»»åŠ¡ç¼–æ’ | åŒ…æ•°é‡ |
|-----|---------|---------|-------|
| Vue | pnpm | è‡ªå®šä¹‰è„šæœ¬ | 10+ |
| React | yarn | è‡ªå®šä¹‰è„šæœ¬ | 30+ |
| Babel | yarn | Lerna | 140+ |
| Vite | pnpm | è‡ªå®šä¹‰è„šæœ¬ | 10+ |
| Next.js | pnpm | Turborepo | 20+ |
| NestJS | npm | Lerna | 20+ |

## äºŒã€ä¸ºä»€ä¹ˆé€‰æ‹© Monorepoï¼Ÿ

### 2.1 Multi-repo çš„ç—›ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Multi-repo çš„é—®é¢˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   1. ä»£ç å…±äº«å›°éš¾                                                â”‚
â”‚      æ”¹ utils ä¸€è¡Œ â†’ å‘ç‰ˆ â†’ æ›´æ–°ä¾èµ– â†’ æµ‹è¯• â†’ éƒ¨ç½²              â”‚
â”‚      ğŸ˜± ä¸€ä¸ªå°æ”¹åŠ¨è¦èµ°å®Œæ•´å‘å¸ƒæµç¨‹                               â”‚
â”‚                                                                  â”‚
â”‚   2. ä¾èµ–ç‰ˆæœ¬åœ°ç‹±                                                â”‚
â”‚      app-1: utils@1.0.0 | app-2: utils@2.0.0                    â”‚
â”‚      ğŸ˜± ç‰ˆæœ¬ä¸ä¸€è‡´ï¼ŒBug éš¾å¤ç°                                   â”‚
â”‚                                                                  â”‚
â”‚   3. å·¥å…·é“¾é‡å¤é…ç½®                                              â”‚
â”‚      æ¯ä¸ªä»“åº“ï¼šESLint + TypeScript + Jest + CI/CD               â”‚
â”‚      ğŸ˜± é…ç½®ä¸ä¸€è‡´ï¼Œç»´æŠ¤æˆæœ¬é«˜                                   â”‚
â”‚                                                                  â”‚
â”‚   4. è·¨ä»“åº“é‡æ„å›°éš¾                                              â”‚
â”‚      æ”¹ utils API â†’ åŒæ—¶æ”¹ app-1, app-2, app-3                  â”‚
â”‚      ğŸ˜± å¤šä¸ª PRï¼Œéš¾ä»¥åŸå­æäº¤                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Monorepo çš„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|-----|------|
| ä»£ç å…±äº«ç®€å• | æœ¬åœ°é“¾æ¥ï¼Œæ”¹äº†ç«‹åˆ»ç”Ÿæ•ˆï¼Œæ— éœ€å‘ç‰ˆ |
| åŸå­æäº¤ | ä¸€ä¸ª commit åŒæ—¶æ”¹å¤šä¸ªåŒ…ï¼Œä¿æŒä¸€è‡´ |
| ç»Ÿä¸€å·¥å…·é“¾ | æ ¹ç›®å½•ä¸€ä»½é…ç½®ï¼Œæ‰€æœ‰åŒ…å…±äº« |
| ç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬ | æ‰€æœ‰åŒ…ç”¨åŒä¸€ç‰ˆæœ¬ï¼Œé¿å…å†²çª |
| æ›´å¥½çš„å¯è§æ€§ | æ‰€æœ‰ä»£ç åœ¨ä¸€èµ·ï¼Œæ–¹ä¾¿æœç´¢ç†è§£ |

### 2.3 Monorepo çš„æŒ‘æˆ˜

| æŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|
| ä»“åº“ä½“ç§¯å¤§ | Git sparse checkoutã€shallow clone |
| æ„å»ºæ…¢ | Turborepo/Nx ç¼“å­˜ã€å¢é‡æ„å»º |
| æƒé™ç®¡ç† | CODEOWNERSã€CI æ£€æŸ¥ |
| CI æ—¶é—´é•¿ | åªæ„å»ºå˜æ›´çš„åŒ… |

## ä¸‰ã€Workspace å·¥å…·å¯¹æ¯”ï¼šnpm vs yarn vs pnpm

### 3.1 ä¸‰è€…éƒ½æ”¯æŒ Workspace

```yaml
# npm (v7+) / yarn - package.json
{
  "workspaces": ["packages/*", "apps/*"]
}

# pnpm - pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'apps/*'
```

### 3.2 æ ¸å¿ƒå·®å¼‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Workspace å®ç°å·®å¼‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   npm/yarnï¼šæ‰å¹³åŒ– + ç¬¦å·é“¾æ¥                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ node_modules/                           â”‚                   â”‚
â”‚   â”‚ â”œâ”€â”€ @my/ui â†’ ../packages/ui             â”‚ â† ç¬¦å·é“¾æ¥        â”‚
â”‚   â”‚ â”œâ”€â”€ @my/utils â†’ ../packages/utils       â”‚                   â”‚
â”‚   â”‚ â”œâ”€â”€ react/                              â”‚ â† æå‡åˆ°é¡¶å±‚      â”‚
â”‚   â”‚ â””â”€â”€ lodash/                             â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚   âš ï¸ å¹½çµä¾èµ–ï¼šå¯ä»¥è®¿é—®æœªå£°æ˜çš„åŒ…                               â”‚
â”‚                                                                  â”‚
â”‚   pnpmï¼šä¸‰å±‚ç»“æ„ + ç¡¬é“¾æ¥                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚ node_modules/                           â”‚                   â”‚
â”‚   â”‚ â”œâ”€â”€ @my/ui â†’ .pnpm/@my+ui/...           â”‚ â† åªæœ‰ç›´æ¥ä¾èµ–    â”‚
â”‚   â”‚ â”œâ”€â”€ @my/utils â†’ .pnpm/@my+utils/...     â”‚                   â”‚
â”‚   â”‚ â””â”€â”€ .pnpm/                              â”‚ â† æ‰€æœ‰ä¾èµ–åœ¨è¿™é‡Œ  â”‚
â”‚   â”‚     â”œâ”€â”€ @my+ui/node_modules/            â”‚                   â”‚
â”‚   â”‚     â”‚   â”œâ”€â”€ @my/ui â†’ <store>            â”‚ â† ç¡¬é“¾æ¥          â”‚
â”‚   â”‚     â”‚   â””â”€â”€ react â†’ ../../react/...     â”‚                   â”‚
â”‚   â”‚     â””â”€â”€ react@18.2.0/...                â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚   âœ… ä¸¥æ ¼æ¨¡å¼ï¼šåªèƒ½è®¿é—®å£°æ˜çš„ä¾èµ–                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å‘½ä»¤å¯¹æ¯”

| æ“ä½œ | npm | yarn | pnpm |
|-----|-----|------|------|
| å®‰è£…æ‰€æœ‰ä¾èµ– | `npm install` | `yarn` | `pnpm install` |
| åœ¨æŒ‡å®šåŒ…æ‰§è¡Œ | `npm -w @my/ui run build` | `yarn workspace @my/ui build` | `pnpm --filter @my/ui build` |
| åœ¨æ‰€æœ‰åŒ…æ‰§è¡Œ | `npm -ws run build` | `yarn workspaces run build` | `pnpm -r run build` |
| æ·»åŠ ä¾èµ–åˆ°åŒ… | `npm -w @my/ui add lodash` | `yarn workspace @my/ui add lodash` | `pnpm add lodash --filter @my/ui` |
| æ·»åŠ åˆ°æ ¹ç›®å½• | `npm add -D typescript` | `yarn add -D -W typescript` | `pnpm add -D -w typescript` |
| æ·»åŠ å†…éƒ¨åŒ… | `npm -w @my/web add @my/ui` | `yarn workspace @my/web add @my/ui@*` | `pnpm add @my/ui --filter @my/web` |

### 3.4 å†…éƒ¨åŒ…å¼•ç”¨

```json
// npm/yarn - ä½¿ç”¨ * æˆ–å…·ä½“ç‰ˆæœ¬
{
  "dependencies": {
    "@my/ui": "*",
    "@my/utils": "^1.0.0"
  }
}

// pnpm - ä½¿ç”¨ workspace åè®®ï¼ˆæ¨èï¼‰
{
  "dependencies": {
    "@my/ui": "workspace:*",      // ä»»æ„ç‰ˆæœ¬
    "@my/utils": "workspace:^"    // å…¼å®¹ç‰ˆæœ¬
  }
}
// å‘å¸ƒæ—¶è‡ªåŠ¨æ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·
```

### 3.5 Filter èƒ½åŠ›å¯¹æ¯”

```bash
# npm - åŸºç¡€è¿‡æ»¤
npm -w @my/ui -w @my/utils run build

# yarn - åŸºç¡€è¿‡æ»¤
yarn workspaces foreach -pt run build  # å¹¶è¡Œ + æ‹“æ‰‘æ’åº

# pnpm - å¼ºå¤§çš„ filter è¯­æ³• ğŸ”¥
pnpm --filter @my/ui run build           # æŒ‡å®šåŒ…
pnpm --filter "@my/*" run build          # åŒ¹é…æ¨¡å¼
pnpm --filter "...@my/web" run build     # web åŠå…¶æ‰€æœ‰ä¾èµ–
pnpm --filter "@my/web..." run build     # web åŠä¾èµ–å®ƒçš„åŒ…
pnpm --filter "...[origin/main]" build   # ç›¸å¯¹ main æœ‰å˜æ›´çš„åŒ…
pnpm --filter "!@my/docs" run build      # æ’é™¤æŸä¸ªåŒ…
```

### 3.6 å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§ | npm | yarn | pnpm |
|-----|-----|------|------|
| Workspace æ”¯æŒ | v7+ | v1+ | âœ… |
| ä¾èµ–éš”ç¦» | âŒ æ‰å¹³åŒ– | âŒ æ‰å¹³åŒ– | âœ… ä¸¥æ ¼ |
| å¹½çµä¾èµ– | âš ï¸ å­˜åœ¨ | âš ï¸ å­˜åœ¨ | âœ… è§£å†³ |
| ç£ç›˜å ç”¨ | é«˜ | é«˜ | ä½ï¼ˆç¡¬é“¾æ¥ï¼‰ |
| å®‰è£…é€Ÿåº¦ | æ…¢ | ä¸­ | å¿« |
| Filter è¯­æ³• | åŸºç¡€ | åŸºç¡€ | å¼ºå¤§ |
| å†…éƒ¨åŒ…åè®® | * | * | workspace:* |

**æ¨è**ï¼šæ–°é¡¹ç›®ç”¨ pnpmï¼Œè€é¡¹ç›®æŒ‰ç°çŠ¶ã€‚

## å››ã€ä»»åŠ¡ç¼–æ’å·¥å…·å¯¹æ¯”

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ä»»åŠ¡ç¼–æ’ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ²¡æœ‰ä»»åŠ¡ç¼–æ’çš„é—®é¢˜                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   ä¾èµ–å…³ç³»ï¼šweb â†’ ui â†’ utils                                    â”‚
â”‚                                                                  â”‚
â”‚   pnpm -r run buildï¼š                                           â”‚
â”‚   â€¢ ä¸çŸ¥é“ä¾èµ–é¡ºåºï¼Œå¯èƒ½ web å…ˆäº ui æ„å»º â†’ å¤±è´¥                â”‚
â”‚   â€¢ æ²¡æœ‰å¹¶è¡Œï¼Œä¸²è¡Œæ‰§è¡Œ â†’ æ…¢                                     â”‚
â”‚   â€¢ æ²¡æœ‰ç¼“å­˜ï¼Œæ¯æ¬¡å…¨é‡æ„å»º â†’ æ›´æ…¢                               â”‚
â”‚                                                                  â”‚
â”‚   Turborepo/Nxï¼š                                                â”‚
â”‚   â€¢ åˆ†æä¾èµ–å›¾ï¼ŒæŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ                                  â”‚
â”‚   â€¢ æ— ä¾èµ–çš„ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ                                        â”‚
â”‚   â€¢ ç¼“å­˜æ„å»ºç»“æœï¼Œæœªå˜æ›´ç›´æ¥è·³è¿‡                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä¸»æµå·¥å…·å¯¹æ¯”

| å·¥å…· | å®šä½ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|-----|------|------|------|
| Turborepo | ä»»åŠ¡ç¼–æ’ | ç®€å•ã€ç¼“å­˜å¼ºã€Vercel ç»´æŠ¤ | åŠŸèƒ½ç›¸å¯¹å°‘ |
| Nx | å…¨åŠŸèƒ½ | åŠŸèƒ½å…¨ã€æ’ä»¶å¤šã€å¯è§†åŒ– | å­¦ä¹ æ›²çº¿é™¡ã€é…ç½®å¤æ‚ |
| Lerna | ç‰ˆæœ¬å‘å¸ƒ | è€ç‰Œã€ç¨³å®š | ä»»åŠ¡ç¼–æ’å¼±ï¼Œç°ç”± Nx ç»´æŠ¤ |
| Rush | å…¨åŠŸèƒ½ | å¾®è½¯å‡ºå“ã€è¶…å¤§è§„æ¨¡ | é…ç½®å¤æ‚ã€ç”Ÿæ€å° |

### 4.3 Turborepo è¯¦è§£

```json
// turbo.json
{
  "$schema": "https://turbo.build/schema.json",
  "tasks": {
    "build": {
      "dependsOn": ["^build"],     // ğŸ”¥ å…ˆæ„å»ºä¾èµ–ï¼ˆ^è¡¨ç¤ºä¸Šæ¸¸ï¼‰
      "outputs": ["dist/**"],      // ğŸ”¥ ç¼“å­˜è¿™äº›è¾“å‡º
      "inputs": [                  // è¿™äº›æ–‡ä»¶å˜äº†æ‰é‡æ–°æ„å»º
        "src/**",
        "package.json",
        "tsconfig.json"
      ]
    },
    "dev": {
      "cache": false,              // å¼€å‘æ¨¡å¼ä¸ç¼“å­˜
      "persistent": true           // æŒä¹…è¿è¡Œï¼ˆä¸é€€å‡ºï¼‰
    },
    "test": {
      "dependsOn": ["build"],      // å…ˆ build å† test
      "outputs": ["coverage/**"]
    },
    "lint": {
      "outputs": []                // æ— è¾“å‡ºï¼Œä½†ä»å¯ç¼“å­˜æ‰§è¡Œç»“æœ
    }
  }
}
```

### 4.4 Turborepo ç¼“å­˜åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¼“å­˜æœºåˆ¶                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   ç¼“å­˜ Key = hash(                                              â”‚
â”‚     inputs æ–‡ä»¶å†…å®¹,                                            â”‚
â”‚     ä¾èµ–åŒ…çš„æ„å»º hash,                                          â”‚
â”‚     ç¯å¢ƒå˜é‡,                                                    â”‚
â”‚     turbo.json é…ç½®                                             â”‚
â”‚   )                                                              â”‚
â”‚                                                                  â”‚
â”‚   æ‰§è¡Œæµç¨‹ï¼š                                                     â”‚
â”‚   1. è®¡ç®—å½“å‰ hash                                              â”‚
â”‚   2. æŸ¥æ‰¾ç¼“å­˜ .turbo/cache/{hash}                               â”‚
â”‚   3. å‘½ä¸­ â†’ å¤åˆ¶ outputsï¼Œè·³è¿‡æ‰§è¡Œï¼ˆ0msï¼‰                       â”‚
â”‚   4. æœªå‘½ä¸­ â†’ æ‰§è¡Œä»»åŠ¡ï¼Œä¿å­˜ outputs                            â”‚
â”‚                                                                  â”‚
â”‚   è¿œç¨‹ç¼“å­˜ï¼š                                                     â”‚
â”‚   â€¢ Vercel Remote Cacheï¼ˆå®˜æ–¹æ‰˜ç®¡ï¼‰                             â”‚
â”‚   â€¢ è‡ªå»º S3/OSS                                                 â”‚
â”‚   â€¢ å›¢é˜Ÿæˆå‘˜ A æ„å»ºè¿‡ â†’ æˆå‘˜ B ç›´æ¥ç”¨ç¼“å­˜                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 å¸¸ç”¨å‘½ä»¤

```bash
# æ„å»ºæ‰€æœ‰åŒ…
turbo run build

# åªæ„å»ºæŒ‡å®šåŒ…åŠå…¶ä¾èµ–
turbo run build --filter=@my/web

# å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡
turbo run build test lint

# æŸ¥çœ‹ä»»åŠ¡ä¾èµ–å›¾
turbo run build --graph

# å¿½ç•¥ç¼“å­˜
turbo run build --force

# åªæ‰§è¡Œæœ‰å˜æ›´çš„åŒ…ï¼ˆCI å¸¸ç”¨ï¼‰
turbo run build --filter="...[origin/main]"

# è¾“å‡ºç¼“å­˜ç»Ÿè®¡
turbo run build --summarize
```

## äº”ã€Changesets ç‰ˆæœ¬å‘å¸ƒ

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ

```
åœºæ™¯ï¼šä¿®å¤äº† utils çš„ä¸€ä¸ª bug

éœ€è¦åšçš„äº‹ï¼š
1. utils: 1.0.0 â†’ 1.0.1
2. ä¾èµ– utils çš„ ui æ›´æ–°ä¾èµ–ç‰ˆæœ¬
3. ä¾èµ– ui çš„ web ä¹Ÿæ›´æ–°
4. ç”Ÿæˆ CHANGELOG
5. å‘å¸ƒåˆ° npm
6. æ‰“ Git tag

ğŸ˜± æ‰‹åŠ¨åšå¤ªå®¹æ˜“å‡ºé”™
```

### 5.2 å·¥ä½œæµç¨‹

```bash
# 1. å¼€å‘å®Œæˆåï¼Œæ·»åŠ  changeset
pnpm changeset

# äº¤äº’å¼é€‰æ‹©ï¼š
# ? Which packages would you like to include? @my/utils
# ? What type of change? patch
# ? Summary: Fixed date formatting bug
```

```markdown
<!-- ç”Ÿæˆæ–‡ä»¶ï¼š.changeset/happy-dog-123.md -->
---
"@my/utils": patch
---

Fixed date formatting bug in `formatDate` function.
```

```bash
# 2. PR åˆå¹¶åï¼Œæ›´æ–°ç‰ˆæœ¬
pnpm changeset version

# è‡ªåŠ¨æ›´æ–°ï¼š
# - packages/utils/package.json: 1.0.0 â†’ 1.0.1
# - packages/utils/CHANGELOG.md
# - ä¾èµ– utils çš„åŒ…ä¹Ÿæ›´æ–°ä¾èµ–ç‰ˆæœ¬

# 3. å‘å¸ƒ
pnpm changeset publish

# è‡ªåŠ¨ï¼šnpm publish + git tag
```

### 5.3 é…ç½®æ–‡ä»¶

```json
// .changeset/config.json
{
  "$schema": "https://unpkg.com/@changesets/config/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "fixed": [],              // å›ºå®šç‰ˆæœ¬ï¼šè¿™äº›åŒ…å§‹ç»ˆåŒä¸€ç‰ˆæœ¬
  "linked": [               // è”åŠ¨ç‰ˆæœ¬ï¼šä¸€ä¸ªå‘ç‰ˆï¼Œå…³è”çš„éƒ½å‘
    ["@my/ui", "@my/theme"]
  ],
  "ignore": ["@my/web"]     // ä¸å‘å¸ƒçš„åŒ…ï¼ˆç§æœ‰åº”ç”¨ï¼‰
}
```

### 5.4 CI è‡ªåŠ¨åŒ–

```yaml
# .github/workflows/release.yml
- uses: changesets/action@v1
  with:
    publish: pnpm release
    version: pnpm changeset version
    commit: "chore: version packages"
    title: "chore: version packages"
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

# æ•ˆæœï¼š
# 1. æœ‰ changeset æ–‡ä»¶æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º Version PR
# 2. Version PR åˆå¹¶åï¼Œè‡ªåŠ¨å‘å¸ƒåˆ° npm
```

## å…­ã€å®æˆ˜ï¼šå®Œæ•´é¡¹ç›®ç»“æ„

### 6.1 ç›®å½•ç»“æ„

```
my-monorepo/
â”œâ”€â”€ .changeset/
â”‚   â””â”€â”€ config.json
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â”œâ”€â”€ ci.yml
â”‚       â””â”€â”€ release.yml
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                 # Next.js åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â””â”€â”€ admin/               # Vite åº”ç”¨
â”‚       â””â”€â”€ ...
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ui/                  # ç»„ä»¶åº“ï¼ˆå‘å¸ƒåˆ° npmï¼‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ utils/               # å·¥å…·åº“ï¼ˆå‘å¸ƒåˆ° npmï¼‰
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ tsconfig/            # å…±äº«é…ç½®ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
â”‚       â”œâ”€â”€ base.json
â”‚       â”œâ”€â”€ react.json
â”‚       â””â”€â”€ package.json
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ turbo.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ .npmrc
```

### 6.2 æ ¹ç›®å½•é…ç½®

```json
// package.json
{
  "name": "my-monorepo",
  "private": true,
  "packageManager": "pnpm@9.0.0",
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "turbo run test",
    "lint": "turbo run lint",
    "changeset": "changeset",
    "version": "changeset version",
    "release": "turbo run build && changeset publish"
  },
  "devDependencies": {
    "@changesets/cli": "^2.27.0",
    "turbo": "^2.0.0",
    "typescript": "^5.4.0"
  }
}
```

```yaml
# pnpm-workspace.yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

```ini
# .npmrc
auto-install-peers=true
strict-peer-dependencies=false
```

### 6.3 å…±äº« TypeScript é…ç½®

```json
// packages/tsconfig/base.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "skipLibCheck": true,
    "declaration": true,
    "sourceMap": true,
    "esModuleInterop": true
  }
}

// packages/tsconfig/react.json
{
  "extends": "./base.json",
  "compilerOptions": {
    "jsx": "react-jsx",
    "lib": ["DOM", "DOM.Iterable", "ES2020"]
  }
}
```

```json
// packages/ui/tsconfig.json
{
  "extends": "@my/tsconfig/react.json",
  "compilerOptions": { "outDir": "dist" },
  "include": ["src"]
}
```

### 6.4 ç»„ä»¶åº“é…ç½®

```json
// packages/ui/package.json
{
  "name": "@my/ui",
  "version": "0.1.0",
  "main": "./dist/index.js",
  "module": "./dist/index.mjs",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "scripts": {
    "build": "tsup src/index.ts --format cjs,esm --dts",
    "dev": "tsup src/index.ts --format cjs,esm --dts --watch"
  },
  "dependencies": {
    "@my/utils": "workspace:*"
  },
  "peerDependencies": {
    "react": "^18.0.0"
  },
  "devDependencies": {
    "@my/tsconfig": "workspace:*",
    "tsup": "^8.0.0"
  }
}
```

### 6.5 åº”ç”¨é…ç½®

```json
// apps/web/package.json
{
  "name": "@my/web",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build"
  },
  "dependencies": {
    "@my/ui": "workspace:*",
    "@my/utils": "workspace:*",
    "next": "^14.0.0",
    "react": "^18.0.0"
  },
  "devDependencies": {
    "@my/tsconfig": "workspace:*"
  }
}
```

## ä¸ƒã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 7.1 å¹½çµä¾èµ–

```bash
# é—®é¢˜ï¼šCannot find module 'lodash'
# åŸå› ï¼špnpm ä¸¥æ ¼æ¨¡å¼ï¼Œä¸å…è®¸è®¿é—®æœªå£°æ˜çš„ä¾èµ–

# è§£å†³ï¼šæ˜¾å¼æ·»åŠ 
pnpm add lodash --filter @my/utils
```

### 7.2 TypeScript è·¯å¾„è§£æ

```json
// é—®é¢˜ï¼šIDE æ— æ³•è§£æ workspace åŒ…

// è§£å†³ï¼šæ ¹ç›®å½• tsconfig.json é…ç½® paths
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@my/ui": ["packages/ui/src"],
      "@my/utils": ["packages/utils/src"]
    }
  }
}
```

### 7.3 æ„å»ºé¡ºåºé”™è¯¯

```json
// é—®é¢˜ï¼šweb æ„å»ºæ—¶ ui è¿˜æ²¡æ„å»ºå®Œ

// è§£å†³ï¼šturbo.json é…ç½®ä¾èµ–
{
  "tasks": {
    "build": {
      "dependsOn": ["^build"]  // ^è¡¨ç¤ºå…ˆæ„å»ºä¾èµ–
    }
  }
}
```

### 7.4 å¼€å‘æ—¶çƒ­æ›´æ–°

```javascript
// é—®é¢˜ï¼šæ”¹äº† packages/uiï¼Œapps/web æ²¡æœ‰çƒ­æ›´æ–°

// è§£å†³æ–¹æ¡ˆ 1ï¼šNext.js transpilePackages
// next.config.js
module.exports = {
  transpilePackages: ['@my/ui', '@my/utils']
}

// è§£å†³æ–¹æ¡ˆ 2ï¼šåŒ…ä½¿ç”¨ --watch æ¨¡å¼
// packages/ui/package.json
"scripts": {
  "dev": "tsup src/index.ts --watch"
}
```

### 7.5 æŸäº›åŒ…ä¸å…¼å®¹ pnpm

```ini
# é—®é¢˜ï¼šæŸäº›è€åŒ…ä¾èµ–æ‰å¹³åŒ–ç»“æ„

# è§£å†³ï¼š.npmrc é…ç½®æå‡
public-hoist-pattern[]=*eslint*
public-hoist-pattern[]=*prettier*

# æœ€åæ‰‹æ®µï¼ˆä¸æ¨èï¼‰
shamefully-hoist=true
```

## å…«ã€æœ€ä½³å®è·µ

### 8.1 ç›®å½•è§„èŒƒ

```
âœ… æ¨è
apps/       # å¯éƒ¨ç½²çš„åº”ç”¨ï¼ˆprivate: trueï¼‰
packages/   # å¯å‘å¸ƒçš„åŒ…
tools/      # å†…éƒ¨å·¥å…·è„šæœ¬

âŒ é¿å…
src/        # ä¸è¦åœ¨æ ¹ç›®å½•æ”¾æºç 
lib/        # å‘½åä¸æ¸…æ™°
```

### 8.2 å‘½åè§„èŒƒ

```json
// âœ… ä½¿ç”¨ scope
"@company/ui"
"@company/utils"

// âŒ æ—  scope
"my-ui"
"company-utils"
```

### 8.3 ä¾èµ–ç®¡ç†

```bash
# å…±äº«å¼€å‘ä¾èµ–æ”¾æ ¹ç›®å½•
pnpm add typescript eslint prettier -D -w

# åŒ…ç‰¹æœ‰ä¾èµ–æ”¾åŒ…å†…
pnpm add react --filter @my/ui
```

### 8.4 å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šåŒ…ç®¡ç†å™¨

```json
// package.json
{
  "packageManager": "pnpm@9.0.0",
  "scripts": {
    "preinstall": "npx only-allow pnpm"
  }
}
```

## ä¹ã€æ€»ç»“

### 9.1 å·¥å…·é€‰å‹é€ŸæŸ¥

| éœ€æ±‚ | æ¨è |
|-----|------|
| åŒ…ç®¡ç† | pnpm workspace |
| ä»»åŠ¡ç¼–æ’ | Turborepoï¼ˆç®€å•ï¼‰/ Nxï¼ˆå¤æ‚ï¼‰ |
| ç‰ˆæœ¬å‘å¸ƒ | Changesets |
| è€é¡¹ç›® | ä¿æŒç°æœ‰å·¥å…· |

### 9.2 æ¨èç»„åˆ

```
å°å‹é¡¹ç›®ï¼ˆ< 10 åŒ…ï¼‰ï¼špnpm workspace
ä¸­å‹é¡¹ç›®ï¼ˆ10-50 åŒ…ï¼‰ï¼špnpm + Turborepo
å¤§å‹é¡¹ç›® / éœ€å‘ npmï¼špnpm + Turborepo + Changesets
è¶…å¤§å‹é¡¹ç›®ï¼špnpm + Nx
```

### 9.3 ä¸€å¥è¯æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚   Monorepo = ä¸€ä¸ªä»“åº“ + å¤šä¸ªåŒ… + ç»Ÿä¸€ç®¡ç†                       â”‚
â”‚                                                                  â”‚
â”‚   pnpm workspaceï¼šä¾èµ–å®‰è£… + æœ¬åœ°é“¾æ¥ + ä¸¥æ ¼éš”ç¦»                â”‚
â”‚   Turborepoï¼šä»»åŠ¡ç¼–æ’ + æ„å»ºç¼“å­˜ + å¢é‡æ„å»º                     â”‚
â”‚   Changesetsï¼šç‰ˆæœ¬ç®¡ç† + CHANGELOG + npm å‘å¸ƒ                   â”‚
â”‚                                                                  â”‚
â”‚   ä¸‰è€…ç»„åˆ = 2025 å¹´ Monorepo æœ€ä½³å®è·µ                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

> å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼æœ‰é—®é¢˜è¯„è®ºåŒºè§ ğŸ‰
