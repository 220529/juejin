# Egg.js æºç æ­ç§˜ï¼ˆäº”ï¼‰ï¼šæ’ä»¶ç³»ç»Ÿ

> æœ¬æ–‡æ·±å…¥ Plugin åŠ è½½æºç ï¼Œè§£æ Egg.js æ’ä»¶çš„å‘ç°ã€åŠ è½½ã€ä¾èµ–è§£æå’Œå¯ç”¨æµç¨‹ã€‚

## ä¸€ã€æ’ä»¶ç³»ç»Ÿæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ’ä»¶åŠ è½½æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  loadEggPlugins()    â”€â”€â–º åŠ è½½æ¡†æ¶å†…ç½®æ’ä»¶                    â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  loadAppPlugins()    â”€â”€â–º åŠ è½½åº”ç”¨ config/plugin.js          â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  loadCustomPlugins() â”€â”€â–º åŠ è½½ç¯å¢ƒå˜é‡/è‡ªå®šä¹‰æ’ä»¶             â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  mergePluginConfig() â”€â”€â–º åˆå¹¶ package.json ä¸­çš„ eggPlugin   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  getOrderPlugins()   â”€â”€â–º ä¾èµ–æ’åºï¼Œç”ŸæˆåŠ è½½é¡ºåº              â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  this.plugins        â”€â”€â–º æœ€ç»ˆå¯ç”¨çš„æ’ä»¶åˆ—è¡¨                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€æ’ä»¶é…ç½®

### 2.1 config/plugin.js

```typescript
// config/plugin.ts
export default {
  // ç®€å†™å½¢å¼
  session: true,
  
  // å®Œæ•´é…ç½®
  redis: {
    enable: true,
    package: '@eggjs/redis',
  },
  
  // æœ¬åœ°è·¯å¾„
  custom: {
    enable: true,
    path: path.join(__dirname, '../lib/plugin/custom'),
  },
  
  // ç¯å¢ƒé™åˆ¶
  development: {
    enable: true,
    package: '@eggjs/development',
    env: ['local', 'unittest'],
  },
};
```

### 2.2 æ’ä»¶ä¿¡æ¯ç»“æ„

```typescript
interface EggPluginInfo {
  name: string;              // æ’ä»¶å
  enable: boolean;           // æ˜¯å¦å¯ç”¨
  package?: string;          // npm åŒ…å
  path?: string;             // æœ¬åœ°è·¯å¾„
  dependencies: string[];    // ä¾èµ–çš„æ’ä»¶
  optionalDependencies: string[];  // å¯é€‰ä¾èµ–
  env: string[];             // é™åˆ¶ç¯å¢ƒ
  from: string;              // é…ç½®æ¥æº
  version?: string;          // ç‰ˆæœ¬å·
  implicitEnable?: boolean;  // æ˜¯å¦éšå¼å¯ç”¨
  dependents?: string[];     // è¢«å“ªäº›æ’ä»¶ä¾èµ–
}
```

## ä¸‰ã€æ’ä»¶åŠ è½½å…¥å£

```typescript
// packages/core/src/loader/egg_loader.ts
async loadPlugin(): Promise<void> {
  this.timing.start('Load Plugin');

  // æŸ¥æ‰¾ç›®å½•
  this.lookupDirs = this.getLookupDirs();
  this.allPlugins = {};
  
  // ä¸‰å±‚åŠ è½½
  this.eggPlugins = await this.loadEggPlugins();
  this.appPlugins = await this.loadAppPlugins();
  this.customPlugins = this.loadCustomPlugins();

  // åˆå¹¶æ’ä»¶é…ç½®
  this.#extendPlugins(this.allPlugins, this.eggPlugins);
  this.#extendPlugins(this.allPlugins, this.appPlugins);
  this.#extendPlugins(this.allPlugins, this.customPlugins);

  // å¤„ç†æ¯ä¸ªæ’ä»¶
  const enabledPluginNames: string[] = [];
  const plugins: Record<string, EggPluginInfo> = {};
  
  for (const name in this.allPlugins) {
    const plugin = this.allPlugins[name];
    
    // è§£ææ’ä»¶è·¯å¾„
    plugin.path = this.getPluginPath(plugin);
    
    // åˆå¹¶ package.json ä¸­çš„ eggPlugin é…ç½®
    await this.#mergePluginConfig(plugin);
    
    // ç¯å¢ƒè¿‡æ»¤
    if (env && plugin.env.length > 0 && !plugin.env.includes(env)) {
      plugin.enable = false;
      continue;
    }
    
    plugins[name] = plugin;
    if (plugin.enable) {
      enabledPluginNames.push(name);
    }
  }

  // ä¾èµ–æ’åº
  this.orderPlugins = this.getOrderPlugins(plugins, enabledPluginNames, this.appPlugins);
  
  // æœ€ç»ˆå¯ç”¨çš„æ’ä»¶
  this.plugins = enablePlugins;
  this.timing.end('Load Plugin');
}
```

## å››ã€æ’ä»¶å‘ç°

### 4.1 æŸ¥æ‰¾ç›®å½•

```typescript
protected getLookupDirs(): Set<string> {
  const lookupDirs = new Set<string>();
  
  // åº”ç”¨ç›®å½•
  lookupDirs.add(this.options.baseDir);
  
  // æ¡†æ¶ç›®å½•ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
  for (let i = this.eggPaths.length - 1; i >= 0; i--) {
    lookupDirs.add(this.eggPaths[i]);
  }
  
  // å½“å‰å·¥ä½œç›®å½•
  lookupDirs.add(process.cwd());
  
  return lookupDirs;
}
```

### 4.2 åŠ è½½æ¡†æ¶æ’ä»¶

```typescript
protected async loadEggPlugins(): Promise<Record<string, EggPluginInfo>> {
  const eggPluginConfigPaths = this.eggPaths.map(
    eggPath => path.join(eggPath, 'config/plugin.default')
  );
  return await this.readPluginConfigs(eggPluginConfigPaths);
}
```

### 4.3 åŠ è½½åº”ç”¨æ’ä»¶

```typescript
protected async loadAppPlugins(): Promise<Record<string, EggPluginInfo>> {
  return await this.readPluginConfigs(
    path.join(this.options.baseDir, 'config/plugin.default')
  );
}
```

### 4.4 åŠ è½½è‡ªå®šä¹‰æ’ä»¶

```typescript
protected loadCustomPlugins(): Record<string, EggPluginInfo> {
  let customPlugins = {};
  
  // ä»ç¯å¢ƒå˜é‡åŠ è½½
  if (process.env.EGG_PLUGINS) {
    customPlugins = JSON.parse(process.env.EGG_PLUGINS);
  }
  
  // ä» options.plugins åŠ è½½
  if (this.options.plugins) {
    customPlugins = { ...customPlugins, ...this.options.plugins };
  }
  
  return customPlugins;
}
```

## äº”ã€é…ç½®æ–‡ä»¶è¯»å–

```typescript
protected async readPluginConfigs(configPaths: string[]): Promise<Record<string, EggPluginInfo>> {
  const plugins: Record<string, EggPluginInfo> = {};
  
  // æ”¯æŒå¤šç¯å¢ƒé…ç½®
  // plugin.default.js
  // plugin.${scope}.js
  // plugin.${env}.js
  // plugin.${scope}_${env}.js
  for (const filename of this.getTypeFiles('plugin')) {
    for (let configPath of configPaths) {
      configPath = path.join(path.dirname(configPath), filename);
      
      const filepath = this.resolveModule(configPath);
      if (!filepath) continue;
      
      const config = await utils.loadFile(filepath);
      
      // æ ‡å‡†åŒ–é…ç½®
      for (const name in config) {
        this.#normalizePluginConfig(config, name, filepath);
      }
      
      this.#extendPlugins(plugins, config);
    }
  }
  
  return plugins;
}
```

### 5.1 é…ç½®æ ‡å‡†åŒ–

```typescript
#normalizePluginConfig(plugins: Record<string, EggPluginInfo | boolean>, name: string, configPath: string): void {
  const plugin = plugins[name];
  
  // ç®€å†™å½¢å¼ï¼šplugin_name: false
  if (typeof plugin === 'boolean') {
    plugins[name] = {
      name,
      enable: plugin,
      dependencies: [],
      optionalDependencies: [],
      env: [],
      from: configPath,
    };
    return;
  }
  
  // å®Œæ•´é…ç½®
  if (!('enable' in plugin)) {
    plugin.enable = true;
  }
  plugin.name = name;
  plugin.dependencies = plugin.dependencies || [];
  plugin.optionalDependencies = plugin.optionalDependencies || [];
  plugin.env = plugin.env || [];
  plugin.from = plugin.from || configPath;
}
```

## å…­ã€æ’ä»¶è·¯å¾„è§£æ

```typescript
protected getPluginPath(plugin: EggPluginInfo): string {
  // ä¼˜å…ˆä½¿ç”¨é…ç½®çš„ path
  if (plugin.path) {
    return plugin.path;
  }
  
  return this.#resolvePluginPath(plugin);
}

#resolvePluginPath(plugin: EggPluginInfo): string {
  const name = plugin.package || plugin.name;
  
  try {
    // åœ¨ lookupDirs ä¸­æŸ¥æ‰¾
    const pluginPkgFile = utils.resolvePath(`${name}/package.json`, {
      paths: [...this.lookupDirs],
    });
    return path.dirname(pluginPkgFile);
  } catch (err) {
    throw new Error(
      `Can not find plugin ${name} in "${[...this.lookupDirs].join(', ')}"`,
      { cause: err }
    );
  }
}
```

## ä¸ƒã€package.json é…ç½®åˆå¹¶

```typescript
async #mergePluginConfig(plugin: EggPluginInfo): Promise<void> {
  const pluginPackage = path.join(plugin.path, 'package.json');
  
  if (await utils.existsPath(pluginPackage)) {
    const pkg = await readJSON(pluginPackage);
    const eggPluginConfig = pkg.eggPlugin;
    
    if (pkg.version) {
      plugin.version = pkg.version;
    }
    
    // å¤„ç† ESM/CJS å¯¼å‡ºè·¯å¾„
    plugin.path = await this.#formatPluginPathFromPackageJSON(plugin.path, pkg);
  }
  
  if (!eggPluginConfig) return;
  
  // åˆå¹¶ä¾èµ–é…ç½®
  for (const key of ['dependencies', 'optionalDependencies', 'env']) {
    const values = eggPluginConfig[key];
    const existsValues = plugin[key];
    if (Array.isArray(values) && !existsValues?.length) {
      plugin[key] = values;
    }
  }
}
```

### 7.1 æ’ä»¶ package.json ç¤ºä¾‹

```json
{
  "name": "@eggjs/session",
  "version": "5.0.0",
  "eggPlugin": {
    "name": "session",
    "dependencies": ["security"],
    "optionalDependencies": ["redis"],
    "env": []
  },
  "exports": {
    ".": "./src/index.ts",
    "./app": "./src/app.ts",
    "./config/config.default": "./src/config/config.default.ts"
  }
}
```

## å…«ã€ä¾èµ–æ’åº

```typescript
protected getOrderPlugins(
  allPlugins: Record<string, EggPluginInfo>,
  enabledPluginNames: string[],
  appPlugins: Record<string, EggPluginInfo>,
): EggPluginInfo[] {
  if (enabledPluginNames.length === 0) {
    return [];
  }
  
  // ä½¿ç”¨ sequencify è¿›è¡Œæ‹“æ‰‘æ’åº
  const result = sequencify(allPlugins, enabledPluginNames);
  
  // æ£€æŸ¥é”™è¯¯
  if (result.sequence.length === 0) {
    const err = new Error(
      `sequencify plugins has problem, missing: [${result.missingTasks}], recursive: [${result.recursiveDependencies}]`
    );
    throw err;
  }
  
  // å¤„ç†éšå¼å¯ç”¨çš„æ’ä»¶
  const implicitEnabledPlugins: string[] = [];
  const requireMap: Record<string, string[]> = {};
  
  for (const name of result.sequence) {
    // è®°å½•ä¾èµ–å…³ç³»
    for (const depName of allPlugins[name].dependencies) {
      if (!requireMap[depName]) {
        requireMap[depName] = [];
      }
      requireMap[depName].push(name);
    }
    
    // éšå¼å¯ç”¨
    if (!allPlugins[name].enable) {
      implicitEnabledPlugins.push(name);
      allPlugins[name].enable = true;
      allPlugins[name].implicitEnable = true;
    }
  }
  
  // è®°å½•è¢«ä¾èµ–å…³ç³»
  for (const [name, dependents] of Object.entries(requireMap)) {
    allPlugins[name].dependents = dependents;
  }
  
  return result.sequence.map(name => allPlugins[name]);
}
```

### 8.1 sequencify ç®—æ³•

```typescript
// packages/core/src/utils/sequencify.ts
export function sequencify(
  tasks: Record<string, { dependencies: string[]; optionalDependencies?: string[] }>,
  names: string[],
): { sequence: string[]; missingTasks: string[]; recursiveDependencies: string[] } {
  const sequence: string[] = [];
  const missingTasks: string[] = [];
  const recursiveDependencies: string[] = [];
  const visited = new Set<string>();
  const visiting = new Set<string>();
  
  function visit(name: string): void {
    if (visited.has(name)) return;
    if (visiting.has(name)) {
      recursiveDependencies.push(name);
      return;
    }
    
    const task = tasks[name];
    if (!task) {
      missingTasks.push(name);
      return;
    }
    
    visiting.add(name);
    
    // å…ˆè®¿é—®ä¾èµ–
    for (const dep of task.dependencies) {
      visit(dep);
    }
    
    // å¯é€‰ä¾èµ–
    for (const dep of task.optionalDependencies || []) {
      if (tasks[dep]) {
        visit(dep);
      }
    }
    
    visiting.delete(name);
    visited.add(name);
    sequence.push(name);
  }
  
  for (const name of names) {
    visit(name);
  }
  
  return { sequence, missingTasks, recursiveDependencies };
}
```

## ä¹ã€æ’ä»¶ç›®å½•ç»“æ„

```
plugin/
â”œâ”€â”€ package.json          # æ’ä»¶å…ƒä¿¡æ¯
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ app.ts            # ç”Ÿå‘½å‘¨æœŸé’©å­
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ config.default.ts  # é»˜è®¤é…ç½®
â”‚   â””â”€â”€ app/
â”‚       â”œâ”€â”€ extend/       # æ‰©å±•
â”‚       â”‚   â””â”€â”€ application.ts
â”‚       â””â”€â”€ middleware/   # ä¸­é—´ä»¶
â”‚           â””â”€â”€ xxx.ts
```

### 9.1 æ’ä»¶ app.ts ç¤ºä¾‹

```typescript
// plugins/session/src/app.ts
import type { ILifecycleBoot, Application } from 'egg';

export default class AppBoot implements ILifecycleBoot {
  private readonly app;

  constructor(app: Application) {
    this.app = app;
  }

  configWillLoad(): void {
    // éªŒè¯é…ç½®
    SessionConfig.parse(this.app.config.session);
    
    // æ³¨å†Œä¸­é—´ä»¶
    this.app.config.coreMiddleware.push('session');
    
    // ç›‘å¬äº‹ä»¶
    this.app.on('session:missed', ({ ctx, key }) => {
      ctx.coreLogger.warn('[session][missed] key(%s)', key);
    });
  }
}
```

## åã€æ’ä»¶é…ç½®åˆå¹¶

```
ä¼˜å…ˆçº§ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡†æ¶ plugin.default.js                                     â”‚
â”‚        â†“                                                    â”‚
â”‚  æ¡†æ¶ plugin.${env}.js                                      â”‚
â”‚        â†“                                                    â”‚
â”‚  åº”ç”¨ plugin.default.js                                     â”‚
â”‚        â†“                                                    â”‚
â”‚  åº”ç”¨ plugin.${env}.js                                      â”‚
â”‚        â†“                                                    â”‚
â”‚  process.env.EGG_PLUGINS                                    â”‚
â”‚        â†“                                                    â”‚
â”‚  options.plugins                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åä¸€ã€è°ƒè¯•æŠ€å·§

### 11.1 å…³é”®æ–­ç‚¹

```typescript
// æ’ä»¶åŠ è½½å…¥å£
packages/core/src/loader/egg_loader.ts â†’ loadPlugin

// è·¯å¾„è§£æ
packages/core/src/loader/egg_loader.ts â†’ getPluginPath

// ä¾èµ–æ’åº
packages/core/src/loader/egg_loader.ts â†’ getOrderPlugins
```

### 11.2 æŸ¥çœ‹åŠ è½½çš„æ’ä»¶

```typescript
// å¯åŠ¨åæŸ¥çœ‹
console.log(app.loader.plugins);
console.log(app.loader.orderPlugins);

// è¾“å‡ºç¤ºä¾‹ï¼š
// {
//   session: { name: 'session', enable: true, path: '...', dependencies: [] },
//   security: { name: 'security', enable: true, path: '...', dependencies: [] },
// }
```

## åäºŒã€å°ç»“

Egg.js æ’ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒï¼š

1. **ä¸‰å±‚åŠ è½½**ï¼šæ¡†æ¶æ’ä»¶ â†’ åº”ç”¨æ’ä»¶ â†’ è‡ªå®šä¹‰æ’ä»¶
2. **é…ç½®åˆå¹¶**ï¼šplugin.js + package.json eggPlugin
3. **ä¾èµ–æ’åº**ï¼šsequencify æ‹“æ‰‘æ’åºï¼Œè‡ªåŠ¨å¤„ç†ä¾èµ–
4. **éšå¼å¯ç”¨**ï¼šè¢«ä¾èµ–çš„æ’ä»¶è‡ªåŠ¨å¯ç”¨
5. **ç¯å¢ƒè¿‡æ»¤**ï¼šé€šè¿‡ env é…ç½®é™åˆ¶æ’ä»¶ç”Ÿæ•ˆç¯å¢ƒ

---

> ğŸ“¦ æºç åœ°å€ï¼š[github.com/eggjs/egg](https://github.com/eggjs/egg)
> 
> ä¸‹ä¸€ç¯‡ï¼šä¸­é—´ä»¶æœºåˆ¶è¯¦è§£
> 
> å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è— ğŸ‘
