# Egg.js æºç æ­ç§˜ï¼ˆäºŒï¼‰ï¼šå¤šè¿›ç¨‹æ¨¡å‹

> æœ¬æ–‡æ·±å…¥ @eggjs/cluster æºç ï¼Œè§£æ Egg.js çš„å¤šè¿›ç¨‹æ¶æ„ã€‚

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹ï¼Ÿ

Node.js æ˜¯å•çº¿ç¨‹çš„ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚Egg.js é€šè¿‡å¤šè¿›ç¨‹æ¨¡å‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```
å•è¿›ç¨‹æ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Node.js è¿›ç¨‹               â”‚
â”‚                                         â”‚
â”‚  CPU Core 1  âœ“                          â”‚
â”‚  CPU Core 2  âœ— (é—²ç½®)                   â”‚
â”‚  CPU Core 3  âœ— (é—²ç½®)                   â”‚
â”‚  CPU Core 4  âœ— (é—²ç½®)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤šè¿›ç¨‹æ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Master                                 â”‚
â”‚    â”œâ”€â”€ Agent Worker (1ä¸ª)               â”‚
â”‚    â”œâ”€â”€ App Worker 1  â”€â”€â–º CPU Core 1     â”‚
â”‚    â”œâ”€â”€ App Worker 2  â”€â”€â–º CPU Core 2     â”‚
â”‚    â”œâ”€â”€ App Worker 3  â”€â”€â–º CPU Core 3     â”‚
â”‚    â””â”€â”€ App Worker 4  â”€â”€â–º CPU Core 4     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€ä¸‰ç§è¿›ç¨‹è§’è‰²

### 2.1 Master è¿›ç¨‹

ä¸»è¿›ç¨‹ï¼Œè´Ÿè´£è¿›ç¨‹ç®¡ç†ï¼š

```typescript
// packages/cluster/src/master.ts
export class Master extends ReadyEventEmitter {
  options: MasterOptions;
  workerManager: WorkerManager;
  messenger: Messenger;
  agentWorker: ProcessAgentWorker | WorkerThreadsAgentWorker;
  appWorker: ProcessAppWorker | WorkerThreadsAppWorker;

  async #start(options?: ClusterOptions) {
    // 1. è§£æé…ç½®
    this.options = await parseOptions(options);
    
    // 2. åˆå§‹åŒ– Worker ç®¡ç†å™¨
    this.workerManager = new WorkerManager();
    this.messenger = new Messenger(this, this.workerManager);
    
    // 3. æ£€æµ‹ç«¯å£
    await this.detectPorts();
    
    // 4. å¯åŠ¨ Agent
    this.forkAgentWorker();
    
    // 5. Agent å°±ç»ªåå¯åŠ¨ Worker
    this.once('agent-start', this.forkAppWorkers.bind(this));
  }
}
```

### 2.2 Agent è¿›ç¨‹

ä»£ç†è¿›ç¨‹ï¼Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œè´Ÿè´£ï¼š
- åå°ä»»åŠ¡
- é•¿è¿æ¥ç»´æŠ¤
- å®šæ—¶ä»»åŠ¡è°ƒåº¦

```typescript
// packages/egg/src/lib/agent.ts
export class Agent extends EggApplicationCore {
  constructor(options?: Omit<EggApplicationCoreOptions, 'type'>) {
    super({
      ...options,
      type: 'agent',
    });

    // ä¿æŒ Agent å­˜æ´»
    this.#agentAliveHandler = setInterval(() => {
      this.coreLogger.info('[]');
    }, 24 * 60 * 60 * 1000);
  }
}
```

### 2.3 Worker è¿›ç¨‹

å·¥ä½œè¿›ç¨‹ï¼Œå¤šä¸ªå®ä¾‹ï¼ˆé»˜è®¤ç­‰äº CPU æ ¸å¿ƒæ•°ï¼‰ï¼Œè´Ÿè´£ï¼š
- å¤„ç† HTTP è¯·æ±‚
- æ‰§è¡Œä¸šåŠ¡é€»è¾‘

```typescript
// packages/egg/src/lib/application.ts
export class Application extends EggApplicationCore {
  server?: http.Server;

  constructor(options?: Omit<EggApplicationCoreOptions, 'type'>) {
    super({
      ...options,
      type: 'application',
    });
  }

  onServer(server: http.Server): void {
    this.server = server;
    
    // ä¼˜é›…é€€å‡º
    graceful({
      server: [server],
      error: (err, throwErrorCount) => {
        this.coreLogger.error(err);
      },
    });
  }
}
```

## ä¸‰ã€å¯åŠ¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Master.#start()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. parseOptions()                                          â”‚
â”‚     - è§£æ baseDirã€frameworkã€workers ç­‰é…ç½®               â”‚
â”‚     - é»˜è®¤ workers = os.cpus().length                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. detectPorts()                                           â”‚
â”‚     - æ£€æµ‹ clusterPortï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰                         â”‚
â”‚     - æ£€æµ‹ stickyWorkerPortï¼ˆsticky æ¨¡å¼ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. forkAgentWorker()                                       â”‚
â”‚     - fork Agent è¿›ç¨‹                                       â”‚
â”‚     - ç­‰å¾… agent-start äº‹ä»¶                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. forkAppWorkers()                                        â”‚
â”‚     - fork N ä¸ª Worker è¿›ç¨‹                                 â”‚
â”‚     - ç­‰å¾…æ‰€æœ‰ Worker å¯åŠ¨å®Œæˆ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ready()                                                 â”‚
â”‚     - å‘é€ egg-ready æ¶ˆæ¯ç»™æ‰€æœ‰è¿›ç¨‹                         â”‚
â”‚     - åº”ç”¨å¯åŠ¨å®Œæˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å››ã€è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰

### 4.1 Messenger

```typescript
// packages/cluster/src/utils/messenger.ts
export class Messenger extends EventEmitter {
  send(data: {
    action: string;
    to: 'parent' | 'app' | 'agent';
    data?: any;
    receiverWorkerId?: string;
  }): void {
    switch (data.to) {
      case 'parent':
        // å‘é€ç»™çˆ¶è¿›ç¨‹
        process.send?.(data);
        break;
      case 'app':
        // å‘é€ç»™æ‰€æœ‰ Worker
        this.sendToAppWorker(data);
        break;
      case 'agent':
        // å‘é€ç»™ Agent
        this.sendToAgentWorker(data);
        break;
    }
  }
}
```

### 4.2 é€šä¿¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Master                               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Messenger                         â”‚   â”‚
â”‚  â”‚                                                      â”‚   â”‚
â”‚  â”‚  sendToAppWorker()  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   â”‚
â”‚  â”‚  sendToAgentWorker() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   â”‚
â”‚  â”‚  broadcast() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                    â”‚
         â”‚ IPC                                â”‚ IPC
         â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Agent       â”‚                â”‚    Worker 1     â”‚
â”‚                 â”‚                â”‚                 â”‚
â”‚  messenger.on() â”‚                â”‚  messenger.on() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ¶ˆæ¯ç±»å‹

| æ¶ˆæ¯ | æ–¹å‘ | è¯´æ˜ |
|-----|------|------|
| egg-ready | Master â†’ All | åº”ç”¨å¯åŠ¨å®Œæˆ |
| egg-pids | Master â†’ All | åŒæ­¥è¿›ç¨‹ ID |
| agent-start | Agent â†’ Master | Agent å¯åŠ¨å®Œæˆ |
| app-start | Worker â†’ Master | Worker å¯åŠ¨å®Œæˆ |
| agent-worker-died | Master â†’ Parent | Agent å¼‚å¸¸é€€å‡º |
| app-worker-died | Master â†’ Parent | Worker å¼‚å¸¸é€€å‡º |

## äº”ã€è¿›ç¨‹å®ˆæŠ¤

### 5.1 Worker å¼‚å¸¸å¤„ç†

```typescript
// packages/cluster/src/master.ts
onAppExit(data: { workerId: number; code: number; signal: string }): void {
  const worker = this.workerManager.getWorker(data.workerId)!;
  
  const err = new Error(
    `[master] app_worker#${worker.id}:${worker.workerId} died ` +
    `(code: ${worker.exitCode}, signal: ${data.signal})`
  );
  this.logger.error(err);

  // æ¸…ç† Worker
  worker.clean();
  this.workerManager.deleteWorker(data.workerId);

  // é€šçŸ¥ Agent
  this.messenger.send({
    action: 'egg-pids',
    to: 'agent',
    data: this.workerManager.getListeningWorkerIds(),
  });

  // cfork ä¼šè‡ªåŠ¨é‡å¯ Workerï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
  if (this.appWorker.isAllWorkerStarted) {
    this.messenger.send({
      action: 'app-worker-died',
      to: 'parent',
    });
  }
}
```

### 5.2 Agent å¼‚å¸¸å¤„ç†

```typescript
onAgentExit(data: { code: number; signal: string }): void {
  if (this.closed) return;

  const err = new Error(
    `[master] agent_worker died (code: ${data.code}, signal: ${data.signal})`
  );
  this.logger.error(err);

  // æ¸…ç† Agent
  this.agentWorker.clean();
  this.workerManager.deleteAgent();

  if (this.isStarted) {
    // 1 ç§’åé‡å¯ Agent
    this.log('[master] try to start a new agent_worker after 1s ...');
    setTimeout(() => {
      this.forkAgentWorker();
    }, 1000);
  } else {
    // å¯åŠ¨é˜¶æ®µå¤±è´¥ï¼Œç›´æ¥é€€å‡º
    process.exit(1);
  }
}
```

## å…­ã€ä¼˜é›…é€€å‡º

```typescript
// packages/cluster/src/master.ts
async close(): Promise<void> {
  this.closed = true;
  
  // 15 ç§’è¶…æ—¶å¼ºåˆ¶é€€å‡º
  setTimeout(() => {
    this.log('[master] close timeout, exiting with code:2');
    process.exit(2);
  }, 15000);

  try {
    await this._doClose();
    process.exit(0);
  } catch (e) {
    this.logger.error('[master] close with error: ', e);
    process.exit(1);
  }
}

async _doClose(): Promise<void> {
  const appTimeout = parseInt(process.env.EGG_APP_CLOSE_TIMEOUT || '5000');
  const agentTimeout = parseInt(process.env.EGG_AGENT_CLOSE_TIMEOUT || '5000');

  // 1. å…ˆå…³é—­ Worker
  await this.killAppWorkers(appTimeout);
  
  // 2. å†å…³é—­ Agent
  await this.killAgentWorker(agentTimeout);
}
```

## ä¸ƒã€å¯åŠ¨æ¨¡å¼

Egg.js v4 æ”¯æŒä¸¤ç§å¯åŠ¨æ¨¡å¼ï¼š

### 7.1 Process æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

ä½¿ç”¨ `child_process.fork()` åˆ›å»ºå­è¿›ç¨‹ï¼š

```typescript
startByProcess(): void {
  this.agentWorker = new ProcessAgentWorker(this.options, {
    log: this.log.bind(this),
    logger: this.logger,
    messenger: this.messenger,
  });

  this.appWorker = new ProcessAppWorker(this.options, {
    log: this.log.bind(this),
    logger: this.logger,
    messenger: this.messenger,
    isProduction: this.isProduction,
  });
}
```

### 7.2 Worker Threads æ¨¡å¼

ä½¿ç”¨ `worker_threads` åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼š

```typescript
startByWorkerThreads(): void {
  this.agentWorker = new WorkerThreadsAgentWorker(this.options, {
    log: this.log.bind(this),
    logger: this.logger,
    messenger: this.messenger,
  });

  this.appWorker = new WorkerThreadsAppWorker(this.options, {
    log: this.log.bind(this),
    logger: this.logger,
    messenger: this.messenger,
    isProduction: this.isProduction,
  });
}
```

## å…«ã€Sticky æ¨¡å¼

ç”¨äº WebSocket ç­‰éœ€è¦ä¼šè¯ä¿æŒçš„åœºæ™¯ï¼š

```typescript
startMasterSocketServer(cb: (err?: Error) => void): void {
  net.createServer({ pauseOnConnect: true }, (connection) => {
    // æ ¹æ® IP é€‰æ‹©å›ºå®šçš„ Worker
    const worker = this.stickyWorker(connection.remoteAddress);
    worker.instance.send('sticky-session:connection', connection);
  }).listen(this.#realPort, cb);
}

stickyWorker(ip: string): AppProcessWorker | AppThreadWorker {
  const workerNumbers = this.options.workers;
  const ws = this.workerManager.listWorkerIds();

  // æ ¹æ® IP è®¡ç®— hash
  let s = '';
  for (let i = 0; i < ip.length; i++) {
    if (!isNaN(parseInt(ip[i]))) {
      s += ip[i];
    }
  }
  const pid = ws[Number(s) % workerNumbers];
  return this.workerManager.getWorker(pid)!;
}
```

## ä¹ã€è°ƒè¯•æŠ€å·§

### 9.1 å…³é”®æ–­ç‚¹

```typescript
// Master å¯åŠ¨
packages/cluster/src/master.ts â†’ Master.#start

// Agent å¯åŠ¨
packages/cluster/src/agent_worker.ts â†’ AgentWorker

// Worker å¯åŠ¨
packages/cluster/src/app_worker.ts â†’ AppWorker

// è¿›ç¨‹é€šä¿¡
packages/cluster/src/utils/messenger.ts â†’ Messenger.send
```

### 9.2 æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€

```bash
# æŸ¥çœ‹ Egg è¿›ç¨‹
ps aux | grep egg

# æŸ¥çœ‹è¿›ç¨‹æ ‘
pstree -p <master_pid>
```

## åã€å°ç»“

Egg.js å¤šè¿›ç¨‹æ¨¡å‹çš„æ ¸å¿ƒï¼š

1. **ä¸‰ç§è§’è‰²**ï¼šMasterï¼ˆç®¡ç†ï¼‰ã€Agentï¼ˆåå°ï¼‰ã€Workerï¼ˆè¯·æ±‚ï¼‰
2. **è¿›ç¨‹å®ˆæŠ¤**ï¼šå¼‚å¸¸è‡ªåŠ¨é‡å¯ï¼Œä¿è¯æœåŠ¡å¯ç”¨
3. **IPC é€šä¿¡**ï¼šMessenger å°è£…è¿›ç¨‹é—´æ¶ˆæ¯
4. **ä¼˜é›…é€€å‡º**ï¼šå…ˆå…³ Workerï¼Œå†å…³ Agent
5. **ä¸¤ç§æ¨¡å¼**ï¼šProcessï¼ˆè¿›ç¨‹ï¼‰å’Œ Worker Threadsï¼ˆçº¿ç¨‹ï¼‰

---

> ğŸ“¦ æºç åœ°å€ï¼š[github.com/eggjs/egg](https://github.com/eggjs/egg)
> 
> ä¸‹ä¸€ç¯‡ï¼šLoader æœºåˆ¶è¯¦è§£
> 
> å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è— ğŸ‘
