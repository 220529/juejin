# Egg.js æºç æ­ç§˜ï¼ˆå…­ï¼‰ï¼šä¸­é—´ä»¶æœºåˆ¶

> æœ¬æ–‡æ·±å…¥ Middleware åŠ è½½æºç ï¼Œè§£æ Egg.js ä¸­é—´ä»¶çš„åŠ è½½ã€é…ç½®ã€æ´‹è‘±æ¨¡å‹æ‰§è¡Œæµç¨‹ã€‚

## ä¸€ã€ä¸­é—´ä»¶æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ´‹è‘±æ¨¡å‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚    Request â”€â”€â–º  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚                 â”‚  meta                           â”‚         â”‚
â”‚                 â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚                 â”‚  â”‚  security               â”‚    â”‚         â”‚
â”‚                 â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚         â”‚
â”‚                 â”‚  â”‚  â”‚  session        â”‚    â”‚    â”‚         â”‚
â”‚                 â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚    â”‚         â”‚
â”‚                 â”‚  â”‚  â”‚  â”‚ router  â”‚    â”‚    â”‚    â”‚         â”‚
â”‚                 â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚    â”‚         â”‚
â”‚                 â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚         â”‚
â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚    Response â—„â”€â”€                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€ä¸­é—´ä»¶åˆ†ç±»

```typescript
// config/config.default.ts
export default {
  // æ ¸å¿ƒä¸­é—´ä»¶ï¼ˆæ¡†æ¶/æ’ä»¶æä¾›ï¼‰
  coreMiddleware: [
    'meta',
    'siteFile',
    'notfound',
    'bodyParser',
    'overrideMethod',
  ],
  
  // åº”ç”¨ä¸­é—´ä»¶ï¼ˆåº”ç”¨è‡ªå®šä¹‰ï¼‰
  middleware: [
    'auth',
    'logger',
  ],
};
```

## ä¸‰ã€ä¸­é—´ä»¶åŠ è½½

```typescript
// packages/core/src/loader/egg_loader.ts
async loadMiddleware(opt?: Partial<FileLoaderOptions>): Promise<void> {
  this.timing.start('Load Middleware');
  const app = this.app;

  // 1. åŠ è½½ä¸­é—´ä»¶æ–‡ä»¶åˆ° app.middlewares
  const middlewarePaths = this.getLoadUnits().map(
    unit => path.join(unit.path, 'app/middleware')
  );
  
  await this.loadToApp(middlewarePaths, 'middlewares', {
    call: false,        // ä¸ç«‹å³è°ƒç”¨
    override: true,     // å…è®¸è¦†ç›–
    caseStyle: CaseStyle.lower,
    directory: middlewarePaths,
  });

  // 2. è®¾ç½® app.middleware ä»£ç†
  for (const name in app.middlewares) {
    Object.defineProperty(app.middleware, name, {
      get() {
        return app.middlewares[name];
      },
      enumerable: false,
      configurable: false,
    });
  }

  // 3. æŒ‰é¡ºåºä½¿ç”¨ä¸­é—´ä»¶
  const middlewareNames = this.config.coreMiddleware.concat(this.config.appMiddleware);
  
  for (const name of middlewareNames) {
    const createMiddleware = app.middlewares[name];
    if (!createMiddleware) {
      throw new TypeError(`Middleware ${name} not found`);
    }
    
    // è·å–ä¸­é—´ä»¶é…ç½®
    const options = this.config[name] || {};
    
    // åˆ›å»ºä¸­é—´ä»¶å®ä¾‹
    let mw = createMiddleware(options, app);
    mw._name = name;
    
    // åŒ…è£…ä¸­é—´ä»¶ï¼ˆenable/match/ignoreï¼‰
    mw = wrapMiddleware(mw, options);
    
    if (mw) {
      app.use(mw);
    }
  }

  // 4. æ·»åŠ è·¯ç”±ä¸­é—´ä»¶ï¼ˆæœ€åæ‰§è¡Œï¼‰
  const routerMw = this.app.router.middleware();
  routerMw._name = 'routerMiddleware';
  this.app.use(routerMw);
  
  this.timing.end('Load Middleware');
}
```

## å››ã€ä¸­é—´ä»¶ç¼–å†™

### 4.1 åŸºæœ¬ç»“æ„

```typescript
// app/middleware/auth.ts
import type { Context, MiddlewareFunc, EggCore } from 'egg';

interface AuthOptions {
  enable: boolean;
  ignore?: string[];
}

export default (options: AuthOptions, app: EggCore): MiddlewareFunc => {
  return async function auth(ctx: Context, next: () => Promise<void>): Promise<void> {
    // å‰ç½®é€»è¾‘
    const token = ctx.get('Authorization');
    if (!token) {
      ctx.throw(401, 'Unauthorized');
    }
    
    ctx.user = await app.jwt.verify(token);
    
    // æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    await next();
    
    // åç½®é€»è¾‘
    ctx.set('X-Response-Time', `${Date.now() - ctx.starttime}ms`);
  };
};
```

### 4.2 é…ç½®ä¸­é—´ä»¶

```typescript
// config/config.default.ts
export default {
  middleware: ['auth'],
  
  auth: {
    enable: true,
    ignore: ['/api/login', '/api/register'],
  },
};
```

## äº”ã€ä¸­é—´ä»¶åŒ…è£…

```typescript
// packages/core/src/loader/egg_loader.ts
function wrapMiddleware(mw: MiddlewareFunc, options: MiddlewareOptions): MiddlewareFunc | null {
  // 1. enable æ§åˆ¶
  if (options.enable === false) {
    return null;
  }
  
  // 2. match/ignore è·¯ç”±åŒ¹é…
  if (options.match || options.ignore) {
    const match = pathMatching(options);
    
    const originMw = mw;
    mw = async (ctx, next) => {
      if (!match(ctx)) {
        return next();
      }
      return originMw(ctx, next);
    };
    mw._name = originMw._name;
  }
  
  return mw;
}
```

### 5.1 è·¯ç”±åŒ¹é…

```typescript
// @eggjs/path-matching
interface PathMatchingOptions {
  match?: string | RegExp | Function | Array<string | RegExp | Function>;
  ignore?: string | RegExp | Function | Array<string | RegExp | Function>;
}

// ä½¿ç”¨ç¤ºä¾‹
const options = {
  match: '/api',           // å­—ç¬¦ä¸²å‰ç¼€
  match: /^\/api/,         // æ­£åˆ™
  match: ctx => ctx.path.startsWith('/api'),  // å‡½æ•°
  match: ['/api', '/admin'],  // æ•°ç»„
  
  ignore: '/health',       // å¿½ç•¥è·¯å¾„
};
```

## å…­ã€æ ¸å¿ƒä¸­é—´ä»¶

### 6.1 meta ä¸­é—´ä»¶

```typescript
// packages/egg/src/app/middleware/meta.ts
export default (options: MetaMiddlewareOptions): MiddlewareFunc => {
  return async function meta(ctx, next): Promise<void> {
    if (options.logging) {
      ctx.coreLogger.info('[meta] request started');
    }
    
    await next();
    
    // å“åº”æ—¶é—´
    ctx.set('x-readtime', Date.now() - ctx.starttime);
  };
};
```

### 6.2 bodyParser ä¸­é—´ä»¶

```typescript
// è§£æè¯·æ±‚ä½“
export default (options: BodyParserOptions): MiddlewareFunc => {
  return async function bodyParser(ctx, next): Promise<void> {
    if (ctx.request.body !== undefined) {
      return next();
    }
    
    const body = await parse(ctx, options);
    ctx.request.body = body;
    
    await next();
  };
};
```

### 6.3 notfound ä¸­é—´ä»¶

```typescript
// 404 å¤„ç†
export default (options: NotfoundOptions): MiddlewareFunc => {
  return async function notfound(ctx, next): Promise<void> {
    await next();
    
    if (ctx.status === 404 && !ctx.body) {
      if (ctx.acceptJSON) {
        ctx.body = { message: 'Not Found' };
      } else {
        ctx.body = 'Not Found';
      }
    }
  };
};
```

## ä¸ƒã€ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‰§è¡Œé¡ºåº                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  coreMiddleware (æ¡†æ¶å®šä¹‰)                                   â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ meta          â”€â”€â–º è¯·æ±‚å…ƒä¿¡æ¯                         â”‚
â”‚    â”œâ”€â”€ siteFile      â”€â”€â–º é™æ€æ–‡ä»¶                           â”‚
â”‚    â”œâ”€â”€ notfound      â”€â”€â–º 404 å¤„ç†                           â”‚
â”‚    â”œâ”€â”€ bodyParser    â”€â”€â–º è¯·æ±‚ä½“è§£æ                         â”‚
â”‚    â””â”€â”€ overrideMethod â”€â”€â–º æ–¹æ³•è¦†ç›–                          â”‚
â”‚                                                             â”‚
â”‚  appMiddleware (åº”ç”¨å®šä¹‰)                                    â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ auth          â”€â”€â–º è®¤è¯                               â”‚
â”‚    â””â”€â”€ logger        â”€â”€â–º æ—¥å¿—                               â”‚
â”‚                                                             â”‚
â”‚  routerMiddleware (æœ€åæ‰§è¡Œ)                                 â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ router        â”€â”€â–º è·¯ç”±åˆ†å‘                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.1 è°ƒæ•´é¡ºåº

```typescript
// app.ts
export default class AppBoot {
  configWillLoad() {
    // åœ¨ bodyParser ä¹‹å‰æ’å…¥è‡ªå®šä¹‰ä¸­é—´ä»¶
    const index = this.app.config.coreMiddleware.indexOf('bodyParser');
    this.app.config.coreMiddleware.splice(index, 0, 'custom');
  }
}
```

## å…«ã€Koa ä¸­é—´ä»¶æœºåˆ¶

### 8.1 compose å‡½æ•°

```typescript
// koa-compose
function compose(middleware: MiddlewareFunc[]): MiddlewareFunc {
  return function(ctx, next) {
    let index = -1;
    
    function dispatch(i: number): Promise<void> {
      if (i <= index) {
        return Promise.reject(new Error('next() called multiple times'));
      }
      index = i;
      
      let fn = middleware[i];
      if (i === middleware.length) {
        fn = next;
      }
      if (!fn) {
        return Promise.resolve();
      }
      
      try {
        return Promise.resolve(fn(ctx, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err);
      }
    }
    
    return dispatch(0);
  };
}
```

### 8.2 app.use

```typescript
// @eggjs/koa
class Application {
  middleware: MiddlewareFunc[] = [];
  
  use(fn: MiddlewareFunc): this {
    this.middleware.push(fn);
    return this;
  }
  
  callback(): (req, res) => void {
    const fn = compose(this.middleware);
    
    return (req, res) => {
      const ctx = this.createContext(req, res);
      return this.handleRequest(ctx, fn);
    };
  }
}
```

## ä¹ã€æ’ä»¶ä¸­é—´ä»¶

### 9.1 æ³¨å†Œæ–¹å¼

```typescript
// plugins/session/src/app.ts
export default class AppBoot {
  configWillLoad() {
    // æ·»åŠ åˆ° coreMiddleware
    this.app.config.coreMiddleware.push('session');
  }
}
```

### 9.2 ä¸­é—´ä»¶å®ç°

```typescript
// plugins/session/src/app/middleware/session.ts
import { createSession } from 'koa-session';

export default createSession;
```

## åã€è°ƒè¯•æŠ€å·§

### 10.1 å…³é”®æ–­ç‚¹

```typescript
// ä¸­é—´ä»¶åŠ è½½
packages/core/src/loader/egg_loader.ts â†’ loadMiddleware

// ä¸­é—´ä»¶åŒ…è£…
packages/core/src/loader/egg_loader.ts â†’ wrapMiddleware

// Koa compose
node_modules/koa-compose/index.js â†’ compose
```

### 10.2 æŸ¥çœ‹ä¸­é—´ä»¶åˆ—è¡¨

```typescript
// å¯åŠ¨åæŸ¥çœ‹
console.log(app.config.coreMiddleware);
console.log(app.config.appMiddleware);
console.log(Object.keys(app.middlewares));

// æŸ¥çœ‹ä¸­é—´ä»¶æ ˆ
console.log(app.middleware.map(m => m._name));
```

### 10.3 ä¸­é—´ä»¶æ‰§è¡Œæ—¥å¿—

```typescript
// config/config.local.ts
export default {
  meta: {
    logging: true,
  },
};
```

## åä¸€ã€å°ç»“

Egg.js ä¸­é—´ä»¶æœºåˆ¶çš„æ ¸å¿ƒï¼š

1. **ä¸¤ç±»ä¸­é—´ä»¶**ï¼šcoreMiddlewareï¼ˆæ¡†æ¶ï¼‰+ appMiddlewareï¼ˆåº”ç”¨ï¼‰
2. **æ´‹è‘±æ¨¡å‹**ï¼šåŸºäº Koa composeï¼Œè¯·æ±‚ä»å¤–åˆ°å†…ï¼Œå“åº”ä»å†…åˆ°å¤–
3. **é…ç½®é©±åŠ¨**ï¼šenable/match/ignore æ§åˆ¶ä¸­é—´ä»¶è¡Œä¸º
4. **é¡ºåºå¯æ§**ï¼šé€šè¿‡ configWillLoad è°ƒæ•´æ‰§è¡Œé¡ºåº
5. **è·¯ç”±æœ€å**ï¼šrouterMiddleware å§‹ç»ˆåœ¨æœ€åæ‰§è¡Œ

---

> ğŸ“¦ æºç åœ°å€ï¼š[github.com/eggjs/egg](https://github.com/eggjs/egg)
> 
> ä¸‹ä¸€ç¯‡ï¼šContext æ‰©å±•æœºåˆ¶
> 
> å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è— ğŸ‘
