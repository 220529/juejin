# Egg.js æºç æ­ç§˜ï¼ˆå››ï¼‰ï¼šç”Ÿå‘½å‘¨æœŸ

> æœ¬æ–‡æ·±å…¥ Lifecycle æºç ï¼Œè§£æ Egg.js åº”ç”¨çš„å¯åŠ¨å’Œå…³é—­æµç¨‹ã€‚

## ä¸€ã€ç”Ÿå‘½å‘¨æœŸæ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åº”ç”¨å¯åŠ¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  configWillLoad  â”€â”€â–º é…ç½®å³å°†åŠ è½½ï¼Œæœ€åä¿®æ”¹é…ç½®çš„æœºä¼š        â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  configDidLoad   â”€â”€â–º é…ç½®åŠ è½½å®Œæˆï¼Œæ’ä»¶å·²åŠ è½½                â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  didLoad         â”€â”€â–º æ‰€æœ‰æ–‡ä»¶åŠ è½½å®Œæˆï¼ˆå¼‚æ­¥ï¼‰                â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  willReady       â”€â”€â–º å³å°†å°±ç»ªï¼Œå¯åŠ¨è‡ªå®šä¹‰æœåŠ¡ï¼ˆå¼‚æ­¥ï¼‰        â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  didReady        â”€â”€â–º åº”ç”¨å°±ç»ªï¼Œå¯ä»¥å¤„ç†è¯·æ±‚                  â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  serverDidReady  â”€â”€â–º HTTP æœåŠ¡å™¨å¯åŠ¨å®Œæˆ                     â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      åº”ç”¨å…³é—­                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  beforeClose     â”€â”€â–º åº”ç”¨å…³é—­å‰ï¼Œæ¸…ç†èµ„æº                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€Lifecycle ç±»

```typescript
// packages/core/src/lifecycle.ts
export class Lifecycle extends EventEmitter {
  #bootHooks: (BootImplClass | ILifecycleBoot)[];
  #boots: ILifecycleBoot[];
  #closeFunctionSet: Set<FunWithFullPath>;
  loadReady: Ready;
  bootReady: Ready;

  constructor(options: Partial<LifecycleOptions>) {
    super();
    this.options = options as LifecycleOptions;
    this.#bootHooks = [];
    this.#boots = [];
    this.#closeFunctionSet = new Set();

    // åˆå§‹åŒ– Ready å¯¹è±¡
    this.#initReady();

    // åº”ç”¨å°±ç»ªåè§¦å‘ didReady
    this.ready((err) => {
      this.triggerDidReady(err);
    });
  }
}
```

## ä¸‰ã€Boot ç±»

å¼€å‘è€…é€šè¿‡ Boot ç±»å®šä¹‰ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š

```typescript
// packages/core/src/lifecycle.ts
export interface ILifecycleBoot {
  fullPath?: string;
  configWillLoad?(): void;
  configDidLoad?(): void;
  didLoad?(): Promise<void>;
  willReady?(): Promise<void>;
  didReady?(err?: Error): Promise<void>;
  serverDidReady?(): Promise<void>;
  beforeClose?(): Promise<void>;
}
```

### 3.1 ä½¿ç”¨ç¤ºä¾‹

```typescript
// app.ts
import { Boot } from 'egg';

export default class AppBoot extends Boot {
  // åŒæ­¥é’©å­
  configWillLoad() {
    // ä¿®æ”¹é…ç½®
    this.app.config.custom = 'value';
  }

  configDidLoad() {
    // é…ç½®å·²åŠ è½½
    console.log('config loaded:', this.app.config.env);
  }

  // å¼‚æ­¥é’©å­
  async didLoad() {
    // åˆå§‹åŒ–æ•°æ®åº“
    await this.app.mysql.init();
  }

  async willReady() {
    // é¢„çƒ­ç¼“å­˜
    await this.app.cache.warmup();
  }

  async didReady() {
    // åº”ç”¨å·²å°±ç»ª
    this.app.logger.info('App is ready!');
  }

  async serverDidReady() {
    // æœåŠ¡å™¨å·²å¯åŠ¨
    const { port } = this.app.server.address();
    this.app.logger.info(`Server listening on ${port}`);
  }

  async beforeClose() {
    // æ¸…ç†èµ„æº
    await this.app.mysql.close();
  }
}
```

## å››ã€é’©å­æ³¨å†Œ

### 4.1 addBootHook

```typescript
addBootHook(bootHootOrBootClass: BootImplClass | ILifecycleBoot): void {
  assert(this.#init === false, 'do not add hook when lifecycle has been initialized');
  this.#bootHooks.push(bootHootOrBootClass);
}
```

### 4.2 init

åˆå§‹åŒ–æ—¶å®ä¾‹åŒ–æ‰€æœ‰ Boot ç±»ï¼š

```typescript
init(): void {
  assert(this.#init === false, 'lifecycle have been init');
  this.#init = true;
  
  this.#boots = this.#bootHooks.map((BootHootOrBootClass) => {
    let instance = BootHootOrBootClass as ILifecycleBoot;
    
    // å¦‚æœæ˜¯ç±»ï¼Œå®ä¾‹åŒ–
    if (isClass(BootHootOrBootClass)) {
      instance = new BootHootOrBootClass(this.app);
      if (!instance.fullPath && 'fullPath' in BootHootOrBootClass) {
        instance.fullPath = BootHootOrBootClass.fullPath as string;
      }
    }
    
    return instance;
  });
}
```

## äº”ã€é’©å­è§¦å‘

### 5.1 configWillLoadï¼ˆåŒæ­¥ï¼‰

```typescript
triggerConfigWillLoad(): void {
  for (const boot of this.#boots) {
    if (typeof boot.configWillLoad === 'function') {
      boot.configWillLoad();
    }
  }
  // ç´§æ¥ç€è§¦å‘ configDidLoad
  this.triggerConfigDidLoad();
}
```

### 5.2 configDidLoadï¼ˆåŒæ­¥ï¼‰

```typescript
triggerConfigDidLoad(): void {
  for (const boot of this.#boots) {
    if (typeof boot.configDidLoad === 'function') {
      boot.configDidLoad();
    }
    // æ³¨å†Œ beforeClose
    if (typeof boot.beforeClose === 'function') {
      const beforeClose = boot.beforeClose.bind(boot);
      this.registerBeforeClose(beforeClose, boot.fullPath);
    }
  }
  // ç´§æ¥ç€è§¦å‘ didLoad
  this.triggerDidLoad();
}
```

### 5.3 didLoadï¼ˆå¼‚æ­¥ï¼‰

```typescript
triggerDidLoad(): void {
  // å¯åŠ¨ loadReady
  this.loadReady.start();
  
  for (const boot of this.#boots) {
    if (typeof boot.didLoad === 'function') {
      const didLoad = boot.didLoad.bind(boot);
      this.#registerReadyCallback({
        scope: didLoad,
        ready: this.loadReady,
        timingKeyPrefix: 'Did Load',
        scopeFullName: boot.fullPath + ':didLoad',
      });
    }
  }
}
```

### 5.4 willReadyï¼ˆå¼‚æ­¥ï¼‰

```typescript
triggerWillReady(): void {
  // å¯åŠ¨ bootReady
  this.bootReady.start();
  
  for (const boot of this.#boots) {
    if (typeof boot.willReady === 'function') {
      const willReady = boot.willReady.bind(boot);
      this.#registerReadyCallback({
        scope: willReady,
        ready: this.bootReady,
        timingKeyPrefix: 'Will Ready',
        scopeFullName: boot.fullPath + ':willReady',
      });
    }
  }
}
```

### 5.5 didReadyï¼ˆå¼‚æ­¥ï¼‰

```typescript
triggerDidReady(err?: Error): Promise<void> {
  return (async () => {
    for (const boot of this.#boots) {
      if (typeof boot.didReady === 'function') {
        try {
          await boot.didReady(err);
        } catch (err) {
          this.emit('error', err);
        }
      }
    }
  })();
}
```

### 5.6 serverDidReadyï¼ˆå¼‚æ­¥ï¼‰

```typescript
triggerServerDidReady(): Promise<void> {
  return (async () => {
    for (const boot of this.#boots) {
      if (typeof boot.serverDidReady !== 'function') {
        continue;
      }
      try {
        await boot.serverDidReady();
      } catch (err) {
        this.emit('error', err);
      }
    }
  })();
}
```

## å…­ã€Ready æœºåˆ¶

### 6.1 initReady

```typescript
#initReady(): void {
  // loadReady: didLoad é˜¶æ®µ
  this.loadReady = new Ready({ timeout: this.readyTimeout, lazyStart: true });
  this.#delegateReadyEvent(this.loadReady);
  
  this.loadReady.ready((err?: Error) => {
    if (err) {
      this.ready(err);
    } else {
      // loadReady å®Œæˆåè§¦å‘ willReady
      this.triggerWillReady();
    }
  });

  // bootReady: willReady é˜¶æ®µ
  this.bootReady = new Ready({ timeout: this.readyTimeout, lazyStart: true });
  this.#delegateReadyEvent(this.bootReady);
  
  this.bootReady.ready((err?: Error) => {
    // bootReady å®Œæˆååº”ç”¨å°±ç»ª
    this.ready(err || true);
  });
}
```

### 6.2 registerReadyCallback

```typescript
#registerReadyCallback(args: {
  scope: Fun;
  ready: Ready;
  timingKeyPrefix: string;
  scopeFullName?: string;
}): void {
  const { scope, ready, timingKeyPrefix, scopeFullName } = args;
  const name = scopeFullName || utils.getCalleeFromStack(true, 4);
  
  // å¼€å§‹è®¡æ—¶
  this.timing.start(`${timingKeyPrefix} in ${name}`);
  
  // æ³¨å†Œå›è°ƒ
  const done = ready.readyCallback(name);

  // å¼‚æ­¥æ‰§è¡Œ
  process.nextTick(async () => {
    try {
      await utils.callFn(scope);
      done();
      this.timing.end(`${timingKeyPrefix} in ${name}`);
    } catch (e) {
      done(e as Error);
      this.timing.end(`${timingKeyPrefix} in ${name}`);
    }
  });
}
```

## ä¸ƒã€å…³é—­æµç¨‹

### 7.1 registerBeforeClose

```typescript
registerBeforeClose(fn: FunWithFullPath, fullPath?: string): void {
  assert(typeof fn === 'function', 'argument should be function');
  assert(this.#isClosed === false, 'app has been closed');
  
  if (fullPath) {
    fn.fullPath = fullPath;
  }
  this.#closeFunctionSet.add(fn);
}
```

### 7.2 close

```typescript
async close(): Promise<void> {
  // é€†åºæ‰§è¡Œå…³é—­å‡½æ•°ï¼ˆå…ˆæ³¨å†Œçš„åæ‰§è¡Œï¼‰
  const closeFns = Array.from(this.#closeFunctionSet);
  
  for (const fn of closeFns.reverse()) {
    await utils.callFn(fn);
    this.#closeFunctionSet.delete(fn);
  }
  
  // è§¦å‘ close äº‹ä»¶
  this.app.emit('close');
  
  // ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
  this.removeAllListeners();
  this.app.removeAllListeners();
  
  this.#isClosed = true;
}
```

## å…«ã€å®Œæ•´å¯åŠ¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application å¯åŠ¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  new Application()                                          â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ new Lifecycle()                                      â”‚
â”‚    â”‚     â””â”€â”€ #initReady()                                   â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ new EggLoader()                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  loader.load()                                              â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ loadPlugin()                                         â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ loadConfig()                                         â”‚
â”‚    â”‚     â””â”€â”€ lifecycle.triggerConfigWillLoad()              â”‚
â”‚    â”‚           â””â”€â”€ boot.configWillLoad() â† åŒæ­¥             â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ lifecycle.triggerConfigDidLoad()                     â”‚
â”‚    â”‚     â””â”€â”€ boot.configDidLoad() â† åŒæ­¥                    â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€ loadExtend()                                         â”‚
â”‚    â”œâ”€â”€ loadService()                                        â”‚
â”‚    â”œâ”€â”€ loadMiddleware()                                     â”‚
â”‚    â”œâ”€â”€ loadController()                                     â”‚
â”‚    â””â”€â”€ loadRouter()                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lifecycle.triggerDidLoad()                                 â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ boot.didLoad() â† å¼‚æ­¥ï¼Œç­‰å¾…æ‰€æœ‰å®Œæˆ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lifecycle.triggerWillReady()                               â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ boot.willReady() â† å¼‚æ­¥ï¼Œç­‰å¾…æ‰€æœ‰å®Œæˆ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app.ready()                                                â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ boot.didReady() â† å¼‚æ­¥ï¼Œä¸é˜»å¡                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server.listen()                                            â”‚
â”‚    â”‚                                                        â”‚
â”‚    â””â”€â”€ boot.serverDidReady() â† å¼‚æ­¥ï¼Œä¸é˜»å¡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¹ã€è¶…æ—¶å¤„ç†

```typescript
// é»˜è®¤è¶…æ—¶æ—¶é—´ 10 ç§’
const eggReadyTimeoutEnv = Number.parseInt(
  process.env.EGG_READY_TIMEOUT_ENV || '10000'
);
this.readyTimeout = eggReadyTimeoutEnv;

// è¶…æ—¶äº‹ä»¶
this.on('ready_timeout', (id) => {
  this.logger.warn(
    '[egg/core/lifecycle:ready_timeout] %s seconds later %s was still unable to finish.',
    this.readyTimeout / 1000,
    id
  );
});
```

## åã€è°ƒè¯•æŠ€å·§

### 10.1 å…³é”®æ–­ç‚¹

```typescript
// ç”Ÿå‘½å‘¨æœŸåˆå§‹åŒ–
packages/core/src/lifecycle.ts â†’ constructor

// é’©å­è§¦å‘
packages/core/src/lifecycle.ts â†’ triggerConfigWillLoad
packages/core/src/lifecycle.ts â†’ triggerDidLoad
packages/core/src/lifecycle.ts â†’ triggerWillReady

// å…³é—­æµç¨‹
packages/core/src/lifecycle.ts â†’ close
```

### 10.2 æŸ¥çœ‹å¯åŠ¨è€—æ—¶

```typescript
// å¯åŠ¨å®ŒæˆåæŸ¥çœ‹ timing
console.log(app.timing.toJSON());

// è¾“å‡ºç¤ºä¾‹ï¼š
// {
//   "application Start": { start: 0, end: 1234 },
//   "Did Load in app.ts:didLoad": { start: 100, end: 500 },
//   "Will Ready in app.ts:willReady": { start: 500, end: 1000 },
// }
```

## åä¸€ã€å°ç»“

Egg.js ç”Ÿå‘½å‘¨æœŸçš„æ ¸å¿ƒï¼š

1. **7 ä¸ªé’©å­**ï¼šconfigWillLoad â†’ configDidLoad â†’ didLoad â†’ willReady â†’ didReady â†’ serverDidReady â†’ beforeClose
2. **åŒæ­¥/å¼‚æ­¥**ï¼šconfigWillLoadã€configDidLoad åŒæ­¥ï¼Œå…¶ä»–å¼‚æ­¥
3. **Ready æœºåˆ¶**ï¼šloadReadyï¼ˆdidLoadï¼‰å’Œ bootReadyï¼ˆwillReadyï¼‰ä¸¤é˜¶æ®µ
4. **è¶…æ—¶å¤„ç†**ï¼šé»˜è®¤ 10 ç§’è¶…æ—¶ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
5. **å…³é—­é¡ºåº**ï¼šé€†åºæ‰§è¡Œ beforeClose

---

> ğŸ“¦ æºç åœ°å€ï¼š[github.com/eggjs/egg](https://github.com/eggjs/egg)
> 
> ä¸‹ä¸€ç¯‡ï¼šæ’ä»¶ç³»ç»Ÿè¯¦è§£
> 
> å¦‚æœè§‰å¾—æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è— ğŸ‘
