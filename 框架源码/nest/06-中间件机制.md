# NestJS æºç è§£æï¼šä¸­é—´ä»¶æœºåˆ¶

> æ·±å…¥ MiddlewareModule å’Œ MiddlewareBuilderï¼Œæ­ç§˜ä¸­é—´ä»¶çš„æ³¨å†Œä¸æ‰§è¡Œã€‚

## ä¸­é—´ä»¶åŸºç¡€

NestJS ä¸­é—´ä»¶ä¸ Express ä¸­é—´ä»¶å…¼å®¹ï¼š

```typescript
@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request...');
    next();
  }
}
```

## ä¸­é—´ä»¶æ³¨å†Œ

åœ¨æ¨¡å—ä¸­é…ç½®ä¸­é—´ä»¶ï¼š

```typescript
@Module({
  imports: [CatsModule],
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware, AuthMiddleware)
      .exclude({ path: 'cats', method: RequestMethod.GET })
      .forRoutes(CatsController);
  }
}
```

## MiddlewareBuilder

æ„å»ºä¸­é—´ä»¶é…ç½®ï¼š

```typescript
// packages/core/middleware/builder.ts
export class MiddlewareBuilder implements MiddlewareConsumer {
  private readonly middlewareCollection = new Set<MiddlewareConfiguration>();

  public apply(
    ...middleware: Array<Type<any> | Function | Array<Type<any> | Function>>
  ): MiddlewareConfigProxy {
    return new MiddlewareBuilder.ConfigProxy(
      this,
      middleware.flat(),
      this.routeInfoPathExtractor,
    );
  }

  public build(): MiddlewareConfiguration[] {
    return [...this.middlewareCollection];
  }

  // å†…éƒ¨ä»£ç†ç±»
  private static readonly ConfigProxy = class implements MiddlewareConfigProxy {
    private excludedRoutes: RouteInfo[] = [];

    constructor(
      private readonly builder: MiddlewareBuilder,
      private readonly middleware: Array<Type<any> | Function>,
      private routeInfoPathExtractor: RouteInfoPathExtractor,
    ) {}

    // æ’é™¤è·¯ç”±
    public exclude(...routes: Array<string | RouteInfo>): MiddlewareConfigProxy {
      this.excludedRoutes = [
        ...this.excludedRoutes,
        ...this.getRoutesFlatList(routes).reduce((excludedRoutes, route) => {
          for (const routePath of this.routeInfoPathExtractor.extractPathFrom(route)) {
            excludedRoutes.push({ ...route, path: routePath });
          }
          return excludedRoutes;
        }, [] as RouteInfo[]),
      ];
      return this;
    }

    // åº”ç”¨åˆ°è·¯ç”±
    public forRoutes(
      ...routes: Array<string | Type<any> | RouteInfo>
    ): MiddlewareConsumer {
      const forRoutes = this.getRoutesFlatList(routes);

      // æ·»åŠ åˆ°é›†åˆ
      this.builder.middlewareCollection.add({
        middleware: this.middleware,
        forRoutes,
        excludedRoutes: this.excludedRoutes,
      });

      return this.builder;
    }
  };
}
```

## MiddlewareModule

æ³¨å†Œå’Œè§£æä¸­é—´ä»¶ï¼š

```typescript
// packages/core/middleware/middleware-module.ts
export class MiddlewareModule {
  public async register(
    middlewareContainer: MiddlewareContainer,
    container: NestContainer,
    config: ApplicationConfig,
    injector: Injector,
    httpAdapter: HttpServer,
    graphInspector: GraphInspector,
  ) {
    const modules = container.getModules();

    // éå†æ‰€æœ‰æ¨¡å—
    for (const [token, moduleRef] of modules) {
      const instance = moduleRef.instance;

      // è°ƒç”¨ configure æ–¹æ³•
      if (instance && isFunction(instance.configure)) {
        const middlewareBuilder = new MiddlewareBuilder(
          this.routesMapper,
          httpAdapter,
          this.routeInfoPathExtractor,
        );

        await instance.configure(middlewareBuilder);

        // æ”¶é›†ä¸­é—´ä»¶é…ç½®
        const middlewareConfigs = middlewareBuilder.build();
        middlewareContainer.insertConfig(middlewareConfigs, token);
      }
    }

    // è§£æä¸­é—´ä»¶å®ä¾‹
    await this.resolver.resolveInstances(middlewareContainer, container);

    // æ³¨å†Œåˆ° HTTP é€‚é…å™¨
    await this.registerMiddleware(middlewareContainer, httpAdapter);
  }

  // æ³¨å†Œä¸­é—´ä»¶åˆ°è·¯ç”±
  private async registerMiddleware(
    middlewareContainer: MiddlewareContainer,
    httpAdapter: HttpServer,
  ) {
    const configs = middlewareContainer.getConfigurations();

    for (const [moduleKey, moduleConfigs] of configs) {
      for (const config of moduleConfigs) {
        await this.registerRouteMiddleware(
          middlewareContainer,
          config,
          moduleKey,
          httpAdapter,
        );
      }
    }
  }

  private async registerRouteMiddleware(
    middlewareContainer: MiddlewareContainer,
    config: MiddlewareConfiguration,
    moduleKey: string,
    httpAdapter: HttpServer,
  ) {
    const { forRoutes, middleware, excludedRoutes } = config;

    for (const route of forRoutes) {
      // è·å–ä¸­é—´ä»¶å®ä¾‹
      const middlewareInstances = await this.resolveMiddleware(
        middlewareContainer,
        middleware,
        moduleKey,
      );

      // ç»‘å®šåˆ°è·¯ç”±
      for (const middlewareInstance of middlewareInstances) {
        this.bindHandler(
          middlewareInstance,
          route,
          httpAdapter,
          excludedRoutes,
        );
      }
    }
  }
}
```

## MiddlewareResolver

è§£æä¸­é—´ä»¶å®ä¾‹ï¼š

```typescript
// packages/core/middleware/resolver.ts
export class MiddlewareResolver {
  public async resolveInstances(
    middlewareContainer: MiddlewareContainer,
    container: NestContainer,
  ) {
    const configs = middlewareContainer.getConfigurations();

    for (const [moduleKey, moduleConfigs] of configs) {
      const moduleRef = container.getModules().get(moduleKey);

      for (const config of moduleConfigs) {
        await this.resolveMiddlewareInstances(
          config.middleware,
          moduleRef,
          middlewareContainer,
        );
      }
    }
  }

  private async resolveMiddlewareInstances(
    middleware: Array<Type<any> | Function>,
    moduleRef: Module,
    middlewareContainer: MiddlewareContainer,
  ) {
    for (const metatype of middleware) {
      // å‡½æ•°ä¸­é—´ä»¶ç›´æ¥ä½¿ç”¨
      if (!isClass(metatype)) {
        continue;
      }

      // ç±»ä¸­é—´ä»¶éœ€è¦å®ä¾‹åŒ–
      const wrapper = moduleRef.middlewares.get(metatype);
      if (wrapper) {
        await this.injector.loadInstance(
          wrapper,
          moduleRef.middlewares,
          moduleRef,
        );
      }
    }
  }
}
```

## ä¸­é—´ä»¶æ‰§è¡Œ

### ç»‘å®šåˆ° HTTP é€‚é…å™¨

```typescript
// packages/core/middleware/middleware-module.ts
private bindHandler(
  middlewareInstance: NestMiddleware | Function,
  routeInfo: RouteInfo,
  httpAdapter: HttpServer,
  excludedRoutes: RouteInfo[],
) {
  const { path, method } = routeInfo;

  // åˆ›å»ºä¸­é—´ä»¶å¤„ç†å‡½æ•°
  const handler = isFunction(middlewareInstance)
    ? middlewareInstance
    : middlewareInstance.use.bind(middlewareInstance);

  // åŒ…è£…æ’é™¤é€»è¾‘
  const wrappedHandler = this.createExcludedMiddleware(
    handler,
    excludedRoutes,
  );

  // æ³¨å†Œåˆ°é€‚é…å™¨
  const routerMethod = this.routerMethodFactory.get(httpAdapter, method);
  routerMethod.call(httpAdapter, path, wrappedHandler);
}

// åˆ›å»ºæ’é™¤ä¸­é—´ä»¶
private createExcludedMiddleware(
  handler: Function,
  excludedRoutes: RouteInfo[],
) {
  if (!excludedRoutes.length) {
    return handler;
  }

  return (req: any, res: any, next: Function) => {
    const isExcluded = excludedRoutes.some(route =>
      this.isRouteExcluded(req, route),
    );

    if (isExcluded) {
      return next();
    }
    return handler(req, res, next);
  };
}
```

## å‡½æ•°ä¸­é—´ä»¶

é™¤äº†ç±»ä¸­é—´ä»¶ï¼Œè¿˜æ”¯æŒå‡½æ•°ä¸­é—´ä»¶ï¼š

```typescript
// å‡½æ•°ä¸­é—´ä»¶
export function logger(req: Request, res: Response, next: NextFunction) {
  console.log('Request...');
  next();
}

// ä½¿ç”¨
consumer.apply(logger).forRoutes('*');
```

## å…¨å±€ä¸­é—´ä»¶

```typescript
// main.ts
const app = await NestFactory.create(AppModule);
app.use(helmet());
app.use(compression());
```

å…¨å±€ä¸­é—´ä»¶ç›´æ¥æ³¨å†Œåˆ° HTTP é€‚é…å™¨ï¼š

```typescript
// packages/core/nest-application.ts
public use(...args: any[]): this {
  this.httpAdapter.use(...args);
  return this;
}
```

## ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº

```
1. å…¨å±€ä¸­é—´ä»¶ (app.use)
   â†“
2. æ¨¡å—ä¸­é—´ä»¶ (æŒ‰æ¨¡å—è·ç¦»æ’åºï¼Œè·ç¦»å°çš„å…ˆæ‰§è¡Œ)
   â†“
3. è·¯ç”±ä¸­é—´ä»¶ (æŒ‰ forRoutes é¡ºåº)
   â†“
4. Guards
   â†“
5. Interceptors
   â†“
6. Pipes
   â†“
7. Route Handler
```

æºç ä¸­æŒ‰æ¨¡å—è·ç¦»æ’åºï¼š

```typescript
// packages/core/middleware/middleware-module.ts
const entriesSortedByDistance = [...configs.entries()].sort(
  ([moduleA], [moduleB]) => {
    const moduleARef = this.container.getModuleByKey(moduleA)!;
    const moduleBRef = this.container.getModuleByKey(moduleB)!;
    const isModuleAGlobal = moduleARef.distance === Number.MAX_VALUE;
    const isModuleBGlobal = moduleBRef.distance === Number.MAX_VALUE;
    
    if (isModuleAGlobal && isModuleBGlobal) return 0;
    if (isModuleAGlobal) return -1;  // å…¨å±€æ¨¡å—ä¼˜å…ˆ
    if (isModuleBGlobal) return 1;
    
    return moduleARef.distance - moduleBRef.distance;
  },
);
```

## è·¯ç”±é€šé…ç¬¦

```typescript
consumer
  .apply(LoggerMiddleware)
  .forRoutes({ path: 'ab*cd', method: RequestMethod.ALL });
```

è·¯å¾„åŒ¹é…ä½¿ç”¨ `path-to-regexp`ï¼š

```typescript
// packages/core/middleware/route-info-path-extractor.ts
public extractPathFrom(route: RouteInfo): string[] {
  const { path } = route;

  // å¤„ç†é€šé…ç¬¦
  if (path.includes('*')) {
    return this.extractPathsFromWildcard(path);
  }

  return [path];
}
```

## ä¸­é—´ä»¶ä¸å®ˆå«çš„åŒºåˆ«

| ç‰¹æ€§ | ä¸­é—´ä»¶ | å®ˆå« |
|-----|-------|------|
| æ‰§è¡Œæ—¶æœº | è·¯ç”±åŒ¹é…å‰ | è·¯ç”±åŒ¹é…å |
| è®¿é—®ä¸Šä¸‹æ–‡ | req, res, next | ExecutionContext |
| è¿”å›å€¼ | void | boolean |
| ä¾èµ–æ³¨å…¥ | æ”¯æŒ | æ”¯æŒ |
| é€‚ç”¨åœºæ™¯ | é€šç”¨å¤„ç† | æƒé™æ§åˆ¶ |

## æ€»ç»“

NestJS ä¸­é—´ä»¶æœºåˆ¶çš„æ ¸å¿ƒï¼š

1. **MiddlewareBuilder**ï¼šæ„å»ºä¸­é—´ä»¶é…ç½®
2. **MiddlewareModule**ï¼šæ³¨å†Œå’Œè§£æä¸­é—´ä»¶
3. **MiddlewareResolver**ï¼šå®ä¾‹åŒ–ç±»ä¸­é—´ä»¶
4. **æ‰§è¡Œé¡ºåº**ï¼šå…¨å±€ â†’ æ¨¡å— â†’ è·¯ç”±
5. **è·¯ç”±åŒ¹é…**ï¼šæ”¯æŒé€šé…ç¬¦å’Œæ’é™¤è§„åˆ™
6. **å…¼å®¹æ€§**ï¼šä¸ Express ä¸­é—´ä»¶å®Œå…¨å…¼å®¹

ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†æ AOP å®ç°ï¼ˆGuardã€Pipeã€Interceptorï¼‰ã€‚

---

> ğŸ“¦ æºç ä½ç½®ï¼š`packages/core/middleware/`
>
> ä¸‹ä¸€ç¯‡ï¼šNestJS AOP å®ç°
