# Lerna æºç è§£æžï¼šé¡¹ç›®ä»‹ç»ä¸ŽçŽ¯å¢ƒæ­å»º

> Lerna æ˜¯ä¸€ä¸ªå¿«é€Ÿã€çŽ°ä»£çš„ monorepo ç®¡ç†å·¥å…·ï¼Œç”¨äºŽç®¡ç†å’Œå‘å¸ƒå¤šä¸ª JavaScript/TypeScript åŒ…ã€‚æœ¬ç³»åˆ—åŸºäºŽ Lerna 9.x æºç è¿›è¡Œåˆ†æžã€‚

## Lerna æ˜¯ä»€ä¹ˆ

Lerna æ˜¯ä¸€ä¸ªä¼˜åŒ– monorepo å·¥ä½œæµçš„å·¥å…·ï¼Œå…·å¤‡ï¼š

- **ç‰ˆæœ¬ç®¡ç†**ï¼šç»Ÿä¸€ç‰ˆæœ¬æˆ–ç‹¬ç«‹ç‰ˆæœ¬æ¨¡å¼
- **å˜æ›´æ£€æµ‹**ï¼šåŸºäºŽ git æ£€æµ‹å˜æ›´çš„åŒ…
- **æ‰¹é‡å‘å¸ƒ**ï¼šä¸€é”®å‘å¸ƒå¤šä¸ªåŒ…åˆ° npm
- **ä»»åŠ¡ç¼–æŽ’**ï¼šæ‹“æ‰‘æŽ’åºæ‰§è¡Œè„šæœ¬
- **Nx é›†æˆ**ï¼šåˆ©ç”¨ Nx å®žçŽ°ä»»åŠ¡ç¼“å­˜å’Œå¹¶è¡Œæ‰§è¡Œ

## ä¸ºä»€ä¹ˆé€‰æ‹© Lerna

### Monorepo å·¥å…·å¯¹æ¯”

| å·¥å…· | ç‰ˆæœ¬ç®¡ç† | å‘å¸ƒ | ä»»åŠ¡ç¼–æŽ’ | ç¼“å­˜ |
|-----|---------|------|---------|------|
| Lerna | âœ… | âœ… | âœ… | âœ… (Nx) |
| Nx | âŒ | âŒ | âœ… | âœ… |
| Turborepo | âŒ | âŒ | âœ… | âœ… |
| pnpm workspace | âŒ | âŒ | åŸºç¡€ | âŒ |
| Rush | âœ… | âœ… | âœ… | âœ… |

### Lerna çš„ä¼˜åŠ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Lerna Monorepo                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     lerna.json                             â”‚  â”‚
â”‚  â”‚   version: "independent" | "1.0.0"                        â”‚  â”‚
â”‚  â”‚   packages: ["packages/*"]                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  package-a  â”‚  â”‚  package-b  â”‚  â”‚  package-c  â”‚            â”‚
â”‚   â”‚  v1.0.0     â”‚  â”‚  v1.2.0     â”‚  â”‚  v2.0.0     â”‚            â”‚
â”‚   â”‚             â”‚â”€â”€â–¶â”‚  deps: a   â”‚â”€â”€â–¶â”‚  deps: b   â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                  â”‚
â”‚   lerna version â”€â”€â–¶ lerna publish â”€â”€â–¶ npm registry             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æºç ä»“åº“

```bash
git clone https://github.com/lerna/lerna.git
cd lerna
npm install
npm run build
```

## é¡¹ç›®ç»“æž„

Lerna è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ª monorepoï¼š

```
lerna/
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ lerna/                # ä¸»åŒ…ï¼ˆCLI å…¥å£ï¼‰
â”‚       â””â”€â”€ src/
â”‚           â”œâ”€â”€ cli.ts            # CLI å…¥å£
â”‚           â”œâ”€â”€ commands/         # å‘½ä»¤å®žçŽ°
â”‚           â””â”€â”€ index.ts          # å¯¼å‡º
â”‚
â”œâ”€â”€ libs/
â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒåŠŸèƒ½åº“
â”‚   â”‚   â””â”€â”€ src/lib/
â”‚   â”‚       â”œâ”€â”€ command/          # Command åŸºç±»
â”‚   â”‚       â”œâ”€â”€ project/          # Project é¡¹ç›®ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ package.ts        # Package åŒ…ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ npm-publish.ts    # npm å‘å¸ƒ
â”‚   â”‚       â”œâ”€â”€ npm-dist-tag.ts   # npm tag ç®¡ç†
â”‚   â”‚       â”œâ”€â”€ collect-updates/  # å˜æ›´æ£€æµ‹
â”‚   â”‚       â”œâ”€â”€ conventional-commits/  # è¯­ä¹‰åŒ–æäº¤
â”‚   â”‚       â””â”€â”€ run-projects-topologically.ts  # æ‹“æ‰‘æ‰§è¡Œ
â”‚   â”‚
â”‚   â”œâ”€â”€ commands/             # å‘½ä»¤å®žçŽ°
â”‚   â”‚   â”œâ”€â”€ publish/          # lerna publish
â”‚   â”‚   â”œâ”€â”€ version/          # lerna version
â”‚   â”‚   â”œâ”€â”€ run/              # lerna run
â”‚   â”‚   â”œâ”€â”€ exec/             # lerna exec
â”‚   â”‚   â”œâ”€â”€ init/             # lerna init
â”‚   â”‚   â”œâ”€â”€ list/             # lerna list
â”‚   â”‚   â”œâ”€â”€ changed/          # lerna changed
â”‚   â”‚   â”œâ”€â”€ diff/             # lerna diff
â”‚   â”‚   â”œâ”€â”€ import/           # lerna import
â”‚   â”‚   â””â”€â”€ clean/            # lerna clean
â”‚   â”‚
â”‚   â”œâ”€â”€ child-process/        # å­è¿›ç¨‹ç®¡ç†
â”‚   â””â”€â”€ nx-plugin/            # Nx æ’ä»¶
â”‚
â”œâ”€â”€ lerna.json                # Lerna é…ç½®
â”œâ”€â”€ nx.json                   # Nx é…ç½®
â””â”€â”€ website/                  # æ–‡æ¡£ç«™ç‚¹
```

## æ ¸å¿ƒå‘½ä»¤

### lerna init

åˆå§‹åŒ– monorepoï¼š

```bash
lerna init
# æˆ–ç‹¬ç«‹ç‰ˆæœ¬æ¨¡å¼
lerna init --independent
```

### lerna version

ç‰ˆæœ¬ç®¡ç†ï¼š

```bash
# äº¤äº’å¼é€‰æ‹©ç‰ˆæœ¬
lerna version

# æŒ‡å®šç‰ˆæœ¬ç±»åž‹
lerna version patch
lerna version minor
lerna version major

# é¢„å‘å¸ƒç‰ˆæœ¬
lerna version prerelease --preid beta

# è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼ˆåŸºäºŽ commitï¼‰
lerna version --conventional-commits
```

### lerna publish

å‘å¸ƒåˆ° npmï¼š

```bash
# ç‰ˆæœ¬ + å‘å¸ƒ
lerna publish

# ä»…å‘å¸ƒï¼ˆå·²æœ‰ç‰ˆæœ¬ï¼‰
lerna publish from-git
lerna publish from-package

# Canary å‘å¸ƒ
lerna publish --canary
```

### lerna run

è¿è¡Œè„šæœ¬ï¼š

```bash
# æ‰€æœ‰åŒ…è¿è¡Œ build
lerna run build

# æŒ‡å®šåŒ…
lerna run test --scope=package-a

# æ‹“æ‰‘æŽ’åºæ‰§è¡Œ
lerna run build --stream
```

## é…ç½®æ–‡ä»¶

### lerna.json

```json
{
  "$schema": "node_modules/lerna/schemas/lerna-schema.json",
  "version": "independent",
  "packages": ["packages/*"],
  "command": {
    "version": {
      "conventionalCommits": true,
      "message": "chore(release): publish %s"
    },
    "publish": {
      "registry": "https://registry.npmjs.org"
    }
  }
}
```

### ç‰ˆæœ¬æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç‰ˆæœ¬æ¨¡å¼                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Fixed Mode (å›ºå®šæ¨¡å¼)                                          â”‚
â”‚   - æ‰€æœ‰åŒ…å…±äº«åŒä¸€ç‰ˆæœ¬å·                                          â”‚
â”‚   - lerna.json: "version": "1.0.0"                              â”‚
â”‚   - é€‚åˆï¼šç´§å¯†è€¦åˆçš„åŒ…                                            â”‚
â”‚                                                                  â”‚
â”‚   Independent Mode (ç‹¬ç«‹æ¨¡å¼)                                    â”‚
â”‚   - æ¯ä¸ªåŒ…ç‹¬ç«‹ç‰ˆæœ¬å·                                              â”‚
â”‚   - lerna.json: "version": "independent"                        â”‚
â”‚   - é€‚åˆï¼šæ¾è€¦åˆçš„å·¥å…·é›†                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç³»åˆ—æ–‡ç« 

æœ¬ç³»åˆ—å°†æ·±å…¥åˆ†æž Lerna 9.x æºç ï¼š

1. **é¡¹ç›®ä»‹ç»**ï¼ˆæœ¬æ–‡ï¼‰- äº†è§£é¡¹ç›®ç»“æž„å’Œæ ¸å¿ƒæ¦‚å¿µ
2. **æž¶æž„æ€»è§ˆ** - Command åŸºç±»å’Œå‘½ä»¤æ‰§è¡Œæµç¨‹
3. **ç‰ˆæœ¬ç®¡ç†** - lerna version å®žçŽ°
4. **å‘å¸ƒæµç¨‹** - lerna publish å®žçŽ°
5. **å˜æ›´æ£€æµ‹** - collectUpdates ç®—æ³•
6. **ä»»åŠ¡ç¼–æŽ’** - æ‹“æ‰‘æŽ’åºå’Œå¹¶è¡Œæ‰§è¡Œ
7. **Nx é›†æˆ** - ä»»åŠ¡ç¼“å­˜å’Œåˆ†å¸ƒå¼æ‰§è¡Œ

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è°ƒè¯•æ—¥å¿—

```bash
# è¯¦ç»†æ—¥å¿—
lerna version --loglevel verbose

# è°ƒè¯•æ—¥å¿—
lerna version --loglevel silly
```

### 2. å…³é”®æ–­ç‚¹ä½ç½®

| åœºæ™¯ | æ–‡ä»¶ | å‡½æ•° |
|-----|------|------|
| å‘½ä»¤æ‰§è¡Œ | `libs/core/src/lib/command/` | `Command.execute` |
| ç‰ˆæœ¬ç®¡ç† | `libs/commands/version/` | `VersionCommand` |
| å‘å¸ƒæµç¨‹ | `libs/commands/publish/` | `PublishCommand` |
| å˜æ›´æ£€æµ‹ | `libs/core/src/lib/collect-updates/` | `collectProjectUpdates` |

## ä¸‹ä¸€æ­¥

çŽ¯å¢ƒå‡†å¤‡å¥½äº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†åˆ†æž Command åŸºç±»å’Œå‘½ä»¤æ‰§è¡Œæµç¨‹ã€‚

---

> ðŸ“¦ æºç åœ°å€ï¼š[github.com/lerna/lerna](https://github.com/lerna/lerna)
>
> ä¸‹ä¸€ç¯‡ï¼šLerna æž¶æž„æ€»è§ˆ
