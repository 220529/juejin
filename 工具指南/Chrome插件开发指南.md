# Chrome æ’ä»¶å¼€å‘å®æˆ˜ï¼š5 åˆ†é’Ÿä¸Šæ‰‹ + åŸç†æ·±åº¦è§£æ

> æœ¬æ–‡å¸¦ä½ ä»é›¶åšå‡ºç¬¬ä¸€ä¸ªæ’ä»¶ï¼Œå†æ·±å…¥ç†è§£åº•å±‚è¿è¡Œæœºåˆ¶ã€‚

## ä¸€ã€5 åˆ†é’Ÿåšå‡ºä½ çš„ç¬¬ä¸€ä¸ªæ’ä»¶

Chrome æ’ä»¶æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ”¾å‡ ä¸ªæ–‡ä»¶ã€‚

### æœ€å°ç»“æ„ï¼ˆåªéœ€ 2 ä¸ªæ–‡ä»¶ï¼‰

```
hello-extension/
â”œâ”€â”€ manifest.json   â† æ’ä»¶çš„"èº«ä»½è¯"
â””â”€â”€ popup.html      â† ç‚¹å‡»å›¾æ ‡å¼¹å‡ºçš„é¡µé¢
```

### åŠ¨æ‰‹åš

**1. åˆ›å»º manifest.json**

```json
{
  "manifest_version": 3,
  "name": "Hello æ’ä»¶",
  "version": "1.0.0",
  "action": {
    "default_popup": "popup.html"
  }
}
```

**2. åˆ›å»º popup.html**

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    body { width: 200px; padding: 20px; text-align: center; }
  </style>
</head>
<body>
  <h2>ğŸ‰ æˆåŠŸäº†ï¼</h2>
</body>
</html>
```

**3. åŠ è½½åˆ° Chrome**

1. åœ°å€æ è¾“å…¥ `chrome://extensions/`
2. æ‰“å¼€å³ä¸Šè§’ã€Œå¼€å‘è€…æ¨¡å¼ã€
3. ç‚¹å‡»ã€ŒåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºã€
4. é€‰æ‹©æ–‡ä»¶å¤¹

ç‚¹å‡»å·¥å…·æ å›¾æ ‡ï¼Œçœ‹åˆ°å¼¹çª—å°±æˆåŠŸäº†ï¼

---

## äºŒã€ç†è§£æ’ä»¶çš„è¿è¡Œæœºåˆ¶

### 2.1 æ’ä»¶çš„ä¸‰ä¸ªè¿è¡Œç¯å¢ƒ

Chrome æ’ä»¶æœ‰ä¸‰ä¸ªç‹¬ç«‹çš„è¿è¡Œç¯å¢ƒï¼Œå®ƒä»¬å„å¸å…¶èŒï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Chrome æµè§ˆå™¨                           â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚    Popup       â”‚  ç”¨æˆ·ç•Œé¢                                 â”‚
â”‚  â”‚   (å¼¹çª—é¡µé¢)    â”‚  â€¢ ç‚¹å‡»å›¾æ ‡æ—¶åˆ›å»ºï¼Œå…³é—­å³é”€æ¯              â”‚
â”‚  â”‚                â”‚  â€¢ æœ‰è‡ªå·±ç‹¬ç«‹çš„ DOM å’Œ JS ä¸Šä¸‹æ–‡           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚          â”‚                                                   â”‚
â”‚          â”‚ chrome.scripting.executeScript()                  â”‚
â”‚          â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ç½‘é¡µ (Web Page)                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚              Content Script                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚              (æ³¨å…¥çš„è„šæœ¬)                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  âœ… å¯ä»¥è®¿é—®ç½‘é¡µ DOM                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  âœ… å¯ä»¥è¯»å– localStorage / Cookie                 â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  âœ… å‘èµ·è¯·æ±‚æ—¶è‡ªåŠ¨æºå¸¦è¯¥ç½‘ç«™çš„ç™»å½•æ€                â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  âŒ ä¸èƒ½è®¿é—®ç½‘é¡µçš„ JS å˜é‡                         â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â”‚  Background    â”‚  åå°æœåŠ¡                                 â”‚
â”‚  â”‚ (Service Worker)â”‚  â€¢ ç›‘å¬æµè§ˆå™¨äº‹ä»¶ï¼ˆæ ‡ç­¾åˆ‡æ¢ã€å®‰è£…ç­‰ï¼‰      â”‚
â”‚  â”‚                â”‚  â€¢ å¤„ç†è·¨é¡µé¢çš„é€»è¾‘                        â”‚
â”‚  â”‚                â”‚  â€¢ æŒ‰éœ€å”¤é†’ï¼Œç©ºé—²æ—¶ä¼‘çœ                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸ºä»€ä¹ˆè¦æœ‰ Content Scriptï¼Ÿ

è¿™æ˜¯å¾ˆå¤šæ–°æ‰‹å›°æƒ‘çš„ç‚¹ã€‚çœ‹è¿™ä¸ªåœºæ™¯ï¼š

> éœ€æ±‚ï¼šåšä¸€ä¸ªæ’ä»¶ï¼Œç‚¹å‡»æŒ‰é’®åè·å–å½“å‰ç½‘é¡µçš„ Cookie

**é”™è¯¯åšæ³•**ï¼šç›´æ¥åœ¨ popup.js é‡Œè¯»

```javascript
// âŒ è¿™æ ·æ‹¿åˆ°çš„æ˜¯æ’ä»¶è‡ªå·±çš„ Cookieï¼Œä¸æ˜¯ç½‘é¡µçš„
document.cookie  // ç©ºçš„
```

**æ­£ç¡®åšæ³•**ï¼šæ³¨å…¥ä»£ç åˆ°ç½‘é¡µæ‰§è¡Œ

```javascript
// âœ… æŠŠä»£ç æ³¨å…¥åˆ°ç½‘é¡µä¸Šä¸‹æ–‡æ‰§è¡Œ
chrome.scripting.executeScript({
  target: { tabId: tab.id },
  func: () => document.cookie  // è¿™è¡Œä»£ç åœ¨ç½‘é¡µé‡Œæ‰§è¡Œ
});
```

**åŸç†å›¾è§£**ï¼š

```
Popup çš„ä¸–ç•Œ                    ç½‘é¡µçš„ä¸–ç•Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ popup.js    â”‚                â”‚ example.com â”‚
â”‚             â”‚                â”‚             â”‚
â”‚ document    â”‚                â”‚ document    â”‚
â”‚ .cookie     â”‚                â”‚ .cookie     â”‚
â”‚   â†“         â”‚                â”‚   â†“         â”‚
â”‚  ç©ºçš„       â”‚   æ³¨å…¥ä»£ç  â†’    â”‚ "token=xxx" â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ç‹¬ç«‹æ²™ç®±                        ç½‘é¡µä¸Šä¸‹æ–‡
```

### 2.3 ä¸‰ç§ç¯å¢ƒçš„èƒ½åŠ›å¯¹æ¯”

| èƒ½åŠ› | Popup | Content Script | Background |
|------|:-----:|:--------------:|:----------:|
| æ˜¾ç¤ºç•Œé¢ | âœ… | âŒ | âŒ |
| è®¿é—®ç½‘é¡µ DOM | âŒ | âœ… | âŒ |
| è¯»å–ç½‘é¡µ Cookie | âŒ | âœ… | âŒ |
| å‘è¯·æ±‚å¸¦ç½‘é¡µç™»å½•æ€ | âŒ | âœ… | âŒ |
| ä½¿ç”¨ Chrome APIs | âœ… | éƒ¨åˆ† | âœ… |
| æŒä¹…è¿è¡Œ | âŒ | âŒ | âœ… |

---

## ä¸‰ã€æƒé™ç³»ç»Ÿè¯¦è§£

### 3.1 æƒé™å£°æ˜

åœ¨ manifest.json ä¸­å£°æ˜éœ€è¦çš„æƒé™ï¼š

```json
{
  "permissions": ["activeTab", "scripting", "storage"],
  "host_permissions": ["https://example.com/*"]
}
```

### 3.2 å¸¸ç”¨æƒé™é€ŸæŸ¥

| æƒé™ | ç”¨é€” | ä»€ä¹ˆæ—¶å€™éœ€è¦ |
|------|------|-------------|
| `activeTab` | è®¿é—®å½“å‰æ ‡ç­¾é¡µ | è·å–é¡µé¢ URLã€æ ‡é¢˜ |
| `scripting` | æ³¨å…¥è„šæœ¬åˆ°ç½‘é¡µ | æ“ä½œç½‘é¡µå†…å®¹ |
| `storage` | å­˜å‚¨æ•°æ® | ä¿å­˜ç”¨æˆ·è®¾ç½® |
| `cookies` | è¯»å†™ Cookie | ç®¡ç†ç™»å½•æ€ |
| `tabs` | ç®¡ç†æ‰€æœ‰æ ‡ç­¾é¡µ | æ‰¹é‡æ“ä½œæ ‡ç­¾ |
| `notifications` | å‘é€é€šçŸ¥ | æé†’ç”¨æˆ· |

### 3.3 host_permissions çš„ä½œç”¨

```json
"host_permissions": ["https://example.com/*"]
```

è¿™è¡Œé…ç½®å†³å®šäº†ï¼š
- ä½ çš„æ’ä»¶èƒ½å¾€å“ªäº›ç½‘ç«™æ³¨å…¥ä»£ç 
- ä½ çš„æ’ä»¶èƒ½è®¿é—®å“ªäº›ç½‘ç«™çš„ Cookie

**æœ€å°æƒé™åŸåˆ™**ï¼šåªç”³è¯·éœ€è¦çš„åŸŸåï¼Œä¸è¦ç”¨ `<all_urls>`

---

## å››ã€æ•°æ®é€šä¿¡æœºåˆ¶

### 4.1 Popup â†’ Content Scriptï¼ˆæœ€å¸¸ç”¨ï¼‰

```javascript
// popup.js
const [result] = await chrome.scripting.executeScript({
  target: { tabId: tab.id },
  func: (param) => {
    // è¿™æ®µä»£ç åœ¨ç½‘é¡µé‡Œæ‰§è¡Œ
    console.log('æ”¶åˆ°å‚æ•°:', param);
    return document.title;
  },
  args: ['hello']  // ä¼ å‚
});

console.log('ç½‘é¡µæ ‡é¢˜:', result.result);
```

### 4.2 å„ç»„ä»¶é—´é€šä¿¡

```javascript
// å‘é€æ¶ˆæ¯
chrome.runtime.sendMessage({ action: 'getData' });

// æ¥æ”¶æ¶ˆæ¯
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'getData') {
    sendResponse({ data: 'hello' });
  }
});
```

### 4.3 æ•°æ®å­˜å‚¨

```javascript
// å­˜å‚¨ï¼ˆå¼‚æ­¥ï¼‰
await chrome.storage.local.set({ token: 'xxx' });

// è¯»å–
const { token } = await chrome.storage.local.get('token');

// ç›‘å¬å˜åŒ–
chrome.storage.onChanged.addListener((changes) => {
  console.log('æ•°æ®å˜äº†:', changes);
});
```

---

## äº”ã€å®æˆ˜æ¡ˆä¾‹ï¼šAPI è°ƒç”¨å™¨

### 5.1 éœ€æ±‚

åšä¸€ä¸ªæ’ä»¶ï¼Œåœ¨ `erp.example.com` ç½‘ç«™ä¸Šä¸€é”®è°ƒç”¨ APIï¼Œè‡ªåŠ¨æºå¸¦ç™»å½•æ€ã€‚

### 5.2 éš¾ç‚¹åˆ†æ

```
ç›´æ¥ä» popup.js å‘è¯·æ±‚ï¼š
  popup.js â†’ fetch(erp.example.com) â†’ âŒ è·¨åŸŸï¼Œæ²¡æœ‰ Cookie

è§£å†³æ–¹æ¡ˆï¼š
  popup.js â†’ æ³¨å…¥ä»£ç åˆ°ç½‘é¡µ â†’ åœ¨ç½‘é¡µé‡Œ fetch â†’ âœ… åŒæºï¼Œæœ‰ Cookie
```

### 5.3 æ ¸å¿ƒä»£ç 

```javascript
// popup.js
document.getElementById('btn').onclick = async () => {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  
  const [result] = await chrome.scripting.executeScript({
    target: { tabId: tab.id },
    func: async (apiParams) => {
      // â†“â†“â†“ è¿™æ®µä»£ç åœ¨ç½‘é¡µä¸Šä¸‹æ–‡æ‰§è¡Œ â†“â†“â†“
      
      // è¯»å– Cookie ä¸­çš„ token
      const getToken = () => {
        const match = document.cookie.match(/token=([^;]+)/);
        return match ? match[1] : '';
      };
      
      // å‘èµ·è¯·æ±‚ï¼ˆè‡ªåŠ¨æºå¸¦ Cookieï¼‰
      const response = await fetch('/api/data', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${getToken()}`,
          'Content-Type': 'application/json'
        },
        credentials: 'include',
        body: JSON.stringify(apiParams)
      });
      
      return await response.json();
    },
    args: [{ key: 'value' }]
  });
  
  console.log('API è¿”å›:', result.result);
};
```

### 5.4 manifest.json

```json
{
  "manifest_version": 3,
  "name": "API è°ƒç”¨å™¨",
  "version": "1.0.0",
  "action": { "default_popup": "popup.html" },
  "permissions": ["activeTab", "scripting"],
  "host_permissions": ["https://erp.example.com/*"]
}
```

---

## å…­ã€è°ƒè¯•æŠ€å·§

| è°ƒè¯•ç›®æ ‡ | æ–¹æ³• |
|----------|------|
| Popup é¡µé¢ | å³é”®æ’ä»¶å›¾æ ‡ â†’ æ£€æŸ¥å¼¹å‡ºå†…å®¹ |
| æ³¨å…¥çš„ä»£ç  | ç½‘é¡µ F12 â†’ Console |
| Background | æ‰©å±•ç®¡ç†é¡µ â†’ ç‚¹å‡»ã€ŒService Workerã€|
| ç½‘ç»œè¯·æ±‚ | ç½‘é¡µ F12 â†’ Network |

**çƒ­æ›´æ–°**ï¼šä¿®æ”¹ä»£ç åï¼Œå» `chrome://extensions/` ç‚¹åˆ·æ–°æŒ‰é’®

---

## ä¸ƒã€å¸¸è§å‘ç‚¹

### 7.1 å›¾æ ‡ä¸æ˜¾ç¤º

```
âŒ icon.svg   â†’ Chrome ä¸æ”¯æŒ SVG
âœ… icon.png   â†’ å¿…é¡»æ˜¯ PNGï¼Œå»ºè®® 128x128
```

### 7.2 ä»£ç ä¸ç”Ÿæ•ˆ

```javascript
// âŒ é”™è¯¯ï¼šexecuteScript çš„ func ä¸èƒ½å¼•ç”¨å¤–éƒ¨å˜é‡
const url = 'https://api.com';
chrome.scripting.executeScript({
  func: () => fetch(url)  // url æ˜¯ undefinedï¼
});

// âœ… æ­£ç¡®ï¼šé€šè¿‡ args ä¼ å‚
chrome.scripting.executeScript({
  func: (url) => fetch(url),
  args: ['https://api.com']
});
```

### 7.3 è·¨åŸŸé—®é¢˜

```
ç—‡çŠ¶ï¼šfetch æŠ¥ CORS é”™è¯¯
åŸå› ï¼šä» popup.js ç›´æ¥è¯·æ±‚å…¶ä»–åŸŸå
è§£å†³ï¼šç”¨ executeScript æ³¨å…¥åˆ°ç›®æ ‡ç½‘é¡µæ‰§è¡Œ
```

---

## å…«ã€å‘å¸ƒåˆ° Chrome å•†åº—

1. æ³¨å†Œå¼€å‘è€…è´¦å·ï¼ˆä¸€æ¬¡æ€§ $5ï¼‰
2. æ‰“åŒ…æˆ zipï¼ˆä¸å« node_modulesï¼‰
3. ä¸Šä¼ åˆ° [Chrome Web Store](https://chrome.google.com/webstore/devconsole)
4. å¡«å†™æè¿°ã€æˆªå›¾ã€éšç§æ”¿ç­–
5. ç­‰å¾…å®¡æ ¸ï¼ˆ1-3 å¤©ï¼‰

---

## ä¹ã€æ€»ç»“

```
Chrome æ’ä»¶ = manifest.json + ç•Œé¢ + é€»è¾‘

ä¸‰ä¸ªè¿è¡Œç¯å¢ƒï¼š
â”œâ”€â”€ Popup      â†’ ç”¨æˆ·ç•Œé¢ï¼Œç‚¹å‡»å›¾æ ‡æ˜¾ç¤º
â”œâ”€â”€ Content    â†’ æ³¨å…¥ç½‘é¡µï¼Œæ“ä½œé¡µé¢å†…å®¹
â””â”€â”€ Background â†’ åå°æœåŠ¡ï¼Œç›‘å¬äº‹ä»¶

æ ¸å¿ƒæŠ€èƒ½ï¼š
â”œâ”€â”€ chrome.scripting.executeScript â†’ æ³¨å…¥ä»£ç åˆ°ç½‘é¡µ
â”œâ”€â”€ chrome.storage â†’ å­˜å‚¨æ•°æ®
â””â”€â”€ chrome.runtime.sendMessage â†’ ç»„ä»¶é—´é€šä¿¡
```

æŒæ¡è¿™äº›ï¼Œä½ å°±èƒ½å¼€å‘ 90% çš„ Chrome æ’ä»¶äº†ã€‚

## å‚è€ƒèµ„æ–™

- [Chrome æ‰©å±•å®˜æ–¹æ–‡æ¡£](https://developer.chrome.com/docs/extensions/)
- [Chrome APIs å‚è€ƒ](https://developer.chrome.com/docs/extensions/reference/)
- [æœ¬æ–‡å®æˆ˜é¡¹ç›®æºç ï¼šFlow Runner](https://github.com/220529/flow-runner)
