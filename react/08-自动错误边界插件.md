# å®ç°ä¸€ä¸ªè‡ªåŠ¨æ³¨å…¥ ErrorBoundary çš„ Babel æ’ä»¶

> React çš„ ErrorBoundary å¾ˆå¥½ç”¨ï¼Œä½†æ¯ä¸ªç»„ä»¶éƒ½æ‰‹åŠ¨åŒ…è£¹å¤ªç¹çã€‚æœ¬æ–‡å®ç°ä¸€ä¸ª Babel æ’ä»¶ï¼Œè‡ªåŠ¨ä¸ºç»„ä»¶æ³¨å…¥é”™è¯¯è¾¹ç•Œã€‚

## ç—›ç‚¹

React 16 å¼•å…¥äº† ErrorBoundaryï¼Œä½†ä½¿ç”¨èµ·æ¥å¾ˆéº»çƒ¦ï¼š

```jsx
// æ¯ä¸ªå¯èƒ½å‡ºé”™çš„ç»„ä»¶éƒ½è¦æ‰‹åŠ¨åŒ…è£¹
<ErrorBoundary>
  <UserAvatar />
</ErrorBoundary>
<ErrorBoundary>
  <UserBio />
</ErrorBoundary>
<ErrorBoundary>
  <UserSettings />
</ErrorBoundary>
```

èƒ½ä¸èƒ½è‡ªåŠ¨åŒ–ï¼Ÿ

## è®¾è®¡æ€è·¯

é€šè¿‡ Babel æ’ä»¶åœ¨ç¼–è¯‘æ—¶è‡ªåŠ¨è½¬æ¢ï¼š

```jsx
// è½¬æ¢å‰
<UserBio />

// è½¬æ¢å
const _ERROR_HOC_UserBio = withErrorHandler(UserBio);
<_ERROR_HOC_UserBio isCatchReactError />
```

æ ¸å¿ƒæ­¥éª¤ï¼š
1. éå† ASTï¼Œæ‰¾åˆ°æ‰€æœ‰ JSX å…ƒç´ 
2. è¿‡æ»¤æ‰åŸç”Ÿæ ‡ç­¾ï¼ˆdivã€span ç­‰ï¼‰
3. ä¸ºè‡ªå®šä¹‰ç»„ä»¶åˆ›å»º HOC åŒ…è£…
4. æ›¿æ¢åŸ JSX å…ƒç´ 

## å®ç°

### æ’ä»¶ç»“æ„

```javascript
module.exports = function ({ types: t }, config) {
  return {
    visitor: {
      Program(path) {
        // åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥ import è¯­å¥
      },
      ReturnStatement(path) {
        // éå† return ä¸­çš„ JSX
        path.traverse(customComponentVisitor);
      },
    },
  };
};
```

### æ ¸å¿ƒé€»è¾‘

```javascript
const customComponentVisitor = {
  JSXElement(path) {
    const jsxName = path.node.openingElement.name.name;

    // 1. è¿‡æ»¤åŸç”Ÿæ ‡ç­¾
    if (htmlTags.includes(jsxName)) return;

    // 2. è¿‡æ»¤å·²è½¬æ¢çš„ç»„ä»¶
    if (jsxName.includes("_ERROR_HOC_")) return;

    // 3. åˆ›å»º HOC
    const HOC_NAME = createHoc(path, jsxName);

    // 4. æ„å»ºæ–°çš„ JSX å…ƒç´ 
    const newJsx = t.JSXElement(
      t.JSXOpeningElement(t.JSXIdentifier(HOC_NAME), [
        t.jsxAttribute(t.jsxIdentifier("isCatchReactError")),
        ...path.node.openingElement.attributes,
      ]),
      t.JSXClosingElement(t.JSXIdentifier(HOC_NAME)),
      path.node.children
    );

    // 5. æ›¿æ¢
    path.replaceWith(newJsx);
  },
};
```

### åˆ›å»º HOC

```javascript
const createHoc = (path, tagName) => {
  const hocName = `_ERROR_HOC_${tagName}`;
  
  // æ‰¾åˆ°ç»„ä»¶æ‰€åœ¨ä½œç”¨åŸŸ
  const scope = findJSXElementScope(path.scope, tagName);
  
  // æ£€æŸ¥æ˜¯å¦å·²è½¬æ¢
  if (scope.path.__transformInfo?.includes(tagName)) {
    return hocName;
  }

  // ç”Ÿæˆ HOC å£°æ˜
  const hocNode = template.ast(
    `const ${hocName} = withErrorHandler(${tagName})`
  );

  // æ’å…¥åˆ° return è¯­å¥å‰
  const body = scope.path.node.body;
  if (body.type === "BlockStatement") {
    body.body.splice(body.body.length - 1, 0, hocNode);
  }

  // è®°å½•å·²è½¬æ¢
  scope.path.__transformInfo = scope.path.__transformInfo || [];
  scope.path.__transformInfo.push(tagName);

  return hocName;
};
```

### ä½œç”¨åŸŸæŸ¥æ‰¾

```javascript
const findJSXElementScope = (scope, variableName) => {
  if (scope.hasOwnBinding(variableName)) {
    return scope;
  }
  if (scope.parent) {
    return findJSXElementScope(scope.parent, variableName);
  }
  return null;
};
```

## é…ç½®ä½¿ç”¨

### webpack é…ç½®

```javascript
// webpack.config.js
{
  test: /\.(js|jsx|ts|tsx)$/,
  loader: "babel-loader",
  options: {
    plugins: [
      [
        require.resolve("./config/plugins/auto-log-plugin"),
        {
          imports: `import withErrorHandler from "@/components/hoc/withErrorHandler"`,
          errorHandleComponent: "withErrorHandler",
          ignore: ["WrappedComponent", "ReactErrorBoundary"],
          risks: "all",
        },
      ],
    ],
  },
}
```

### é…ç½®é¡¹è¯´æ˜

| é€‰é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|------|-------|------|
| `imports` | string | - | HOC çš„ import è¯­å¥ |
| `errorHandleComponent` | string | - | HOC å‡½æ•°å |
| `ignore` | string[] | [] | å¿½ç•¥çš„ç»„ä»¶ååˆ—è¡¨ |
| `risks` | "all" \| string[] | "all" | éœ€è¦åŒ…è£¹çš„ç»„ä»¶ï¼Œ"all" è¡¨ç¤ºå…¨éƒ¨ |

### HOC å®ç°

```javascript
// withErrorHandler.js
import { ErrorBoundary } from "react-error-boundary";

const ErrorFallback = ({ error, resetErrorBoundary }) => (
  <div role="alert">
    <h2>å‡ºé”™äº†</h2>
    <p>{error.message}</p>
    <button onClick={resetErrorBoundary}>é‡è¯•</button>
  </div>
);

export default (WrappedComponent) => (props) => (
  <ErrorBoundary
    FallbackComponent={ErrorFallback}
    onError={(error) => console.error("Error:", error)}
  >
    <WrappedComponent {...props} />
  </ErrorBoundary>
);
```

## è½¬æ¢ç¤ºä¾‹

### è½¬æ¢å‰

```jsx
function UserInfo() {
  return (
    <div>
      <UserAvatar />
      <UserBio />
    </div>
  );
}
```

### è½¬æ¢å

```jsx
import withErrorHandler from "@/components/hoc/withErrorHandler";

function UserInfo() {
  const _ERROR_HOC_UserAvatar = withErrorHandler(UserAvatar);
  const _ERROR_HOC_UserBio = withErrorHandler(UserBio);
  
  return (
    <div>
      <_ERROR_HOC_UserAvatar isCatchReactError />
      <_ERROR_HOC_UserBio isCatchReactError />
    </div>
  );
}
```

## æµ‹è¯•æ•ˆæœ

åˆ›å»ºä¸€ä¸ªä¼šéšæœºæŠ›é”™çš„ç»„ä»¶ï¼š

```javascript
// useErrorSimulator.js
const useErrorSimulator = ({ probability = 0.5, message = "Error" }) => {
  useEffect(() => {
    if (Math.random() < probability) {
      throw new Error(message);
    }
  }, []);
};

// UserBio.js
const UserBio = () => {
  useErrorSimulator({ probability: 0.5 });
  return <p>User biography...</p>;
};
```

è¿è¡Œåï¼ŒUserBio å‡ºé”™æ—¶ä¼šæ˜¾ç¤º ErrorFallbackï¼Œè€Œä¸ä¼šå¯¼è‡´æ•´ä¸ªé¡µé¢å´©æºƒã€‚

## å±€é™æ€§

1. **åªå¤„ç†æ¸²æŸ“æ—¶é”™è¯¯**ï¼šäº‹ä»¶å¤„ç†å™¨ä¸­çš„é”™è¯¯éœ€è¦ try-catch
2. **æ€§èƒ½å¼€é”€**ï¼šæ¯ä¸ªç»„ä»¶éƒ½åŒ…è£¹ HOC ä¼šå¢åŠ ç»„ä»¶å±‚çº§
3. **è°ƒè¯•å›°éš¾**ï¼šç»„ä»¶åå˜æˆ `_ERROR_HOC_xxx`ï¼ŒReact DevTools ä¸­ä¸å¤ªç›´è§‚

## ä¼˜åŒ–æ–¹å‘

1. **æŒ‰éœ€åŒ…è£¹**ï¼šé€šè¿‡ `risks` é…ç½®åªåŒ…è£¹é«˜é£é™©ç»„ä»¶
2. **ç”Ÿäº§ç¯å¢ƒå…³é—­**ï¼šå¼€å‘ç¯å¢ƒå¯ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒç¦ç”¨
3. **é”™è¯¯ä¸ŠæŠ¥**ï¼šé›†æˆ Sentry ç­‰ç›‘æ§æœåŠ¡

## æ€»ç»“

è¿™ä¸ª Babel æ’ä»¶å±•ç¤ºäº† AST è½¬æ¢çš„å¼ºå¤§èƒ½åŠ›ã€‚æ ¸å¿ƒæ€è·¯ï¼š

1. éå† JSX å…ƒç´ 
2. è¿‡æ»¤åŸç”Ÿæ ‡ç­¾
3. åˆ›å»º HOC åŒ…è£…
4. æ›¿æ¢åŸå…ƒç´ 

å®Œæ•´ä»£ç è§ [react-debug/error_boundary](https://github.com/220529/react-debug/tree/error_boundary) åˆ†æ”¯ã€‚

---

> ğŸ“¦ é¡¹ç›®åœ°å€ï¼š[github.com/220529/react-debug](https://github.com/220529/react-debug)ï¼ˆerror_boundary åˆ†æ”¯ï¼‰
>
> ç³»åˆ—æ–‡ç« ï¼š[React æºç è°ƒè¯•ç¯å¢ƒæ­å»º](https://juejin.cn/post/7588149079400710187)
